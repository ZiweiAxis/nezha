# 紫微平台架构决策文档（根目录）

**版本**：v1.0  
**日期**：2026-02-13  
**范围**：ziwei 平台复合体 — 跨子项目技术决策与集成约定  
**目的**：供各子项目（天枢、谛听、太白）在实现时引用，避免冲突并保持一致性。

---

## 1. 架构概览

### 1.1 定位

紫微是**智能体治理基础设施**的**平台复合体**，由多个子模块组成，而非单一单体应用：

- **平台层**：定义愿景、能力边界、跨子模块接口、标准与约定、部署与验收。
- **子模块层**：天枢（通信与身份）、谛听（策略与审计）、太白（接入规范与 SDK）；具体功能实现下沉至各自代码库。

### 1.2 原则

- **与运行时无关**：不侵入智能体执行逻辑，通过接口与事件治理。
- **与云厂商无关**：支持纯私有化部署。
- **可观测可验证**：关键操作指纹上链，审计可验真。
- **联邦原生**：基于 Matrix 与 DID 实现跨组织互信。

---

## 2. 系统架构（高层）

```
接入层（智能体 A/B/N）
    ↓ 注册/心跳/操作上报
太白（SDK + 预置适配器）— 可选，部分能力由天枢与文档暂担
    ↓
天枢（Matrix、DID 绑定、企业 IM 适配）  ←→  谛听（策略、审批、Trace、审计、链）
    ↓                                          ↓
企业 IM（飞书/钉钉/企微）                    私有链（DID 注册、存证 Merkle 根）
```

- **天枢**：通信枢纽、身份控制平面、IM 触达与回调；不运维链，DID 注册/查询通过谛听暴露的链接口。
- **谛听**：策略引擎（Cedar）、分级审批、全行为 Trace、审计存证；部署并管理私有链，暴露 DID 与存证/验真 API。
- **太白**：协议（Matrix 事件扩展）、多语言 SDK、预置适配器；独立子模块未落地前，协议与文档由根与天枢侧承担。

---

## 3. 集成架构（子模块间）

### 3.1 天枢 ↔ 谛听

| 集成点 | 方向 | 约定 |
|--------|------|------|
| 注册/审批 | 天枢 → 谛听 | 天枢将注册事件推至谛听；谛听决策审批等级，经天枢向 IM 触达 |
| 审批回调 | 谛听 → 天枢 | 审批结果经天枢接收（如 DITING_APPROVE_CALLBACK_URL），天枢再写 DID 并下发身份 |
| 审计上报 | 天枢 → 谛听 | 天枢将审计事件发至谛听（DITING_AUDIT_URL） |
| 初始化权限 | 天枢 → 谛听 | 注册完成后通知谛听（DITING_INIT_PERMISSION_URL） |
| **DID 链上** | 天枢 → 谛听 | 天枢调用谛听暴露的 **DID 注册/查询 API**（待谛听 I-016～I-018 实现） |

### 3.2 智能体 ↔ 天枢 / 谛听

- 智能体经**太白协议**（或直连 Matrix）与天枢通信：注册、心跳、身份下发。
- 操作上报（`m.agent.action`）由智能体/太白 SDK 发至谛听（或经天枢转发，以实际实现为准）。
- 存证回执（`m.agent.audit`）由谛听经天枢或直连下发给智能体（以实现为准）。

### 3.3 链与 DID 的归属

- **私有链**：归属**谛听**。谛听部署、运维链节点，对外提供 DID 服务与审计存证/验真 API。
- **天枢**：不部署链，仅调用谛听暴露的 DID 接口完成注册与查询；链上 DID 文档格式与 `did:ziwei:...` 命名由技术方案约定。

---

## 4. 标准与约定（Standards and Conventions）

### 4.1 仓库与目录

| 路径 | 用途 |
|------|------|
| **ziwei/** | 仓库根；根目录 BMAD 产出与跨子项目文档 |
| **ziwei/docs/** | 跨子项目权威文档：技术方案、架构图、BMAD 多子项目实践、跨子项目文档约定 |
| **ziwei/_bmad-output/planning-artifacts/** | 根目录规划产物：产品简报、本架构文档、平台 Epic/下一步 |
| **ziwei/diting/** | 谛听子项目；自有 _bmad、_bmad-output、docs、ISSUE_LIST |
| **ziwei/tianshu/** | 天枢子项目；自有 _bmad、_bmad-output、docs |
| **ziwei/taibai/**（可选） | 太白独立子模块（待决策） |

### 4.2 文档与 BMAD

- 子项目 PRD/架构**必须引用** `ziwei/docs/open/technical/紫微智能体治理基础设施-技术方案.md` 及本架构文档（`ziwei/_bmad-output/planning-artifacts/architecture-ziwei.md`）。
- 规划类产出：根层放 `ziwei/_bmad-output/planning-artifacts/`；子项目放各自 `_bmad-output/planning-artifacts/`。
- 命名：`prd.md`、`architecture.md`、`epics.md`、`pm-what-to-do-next.md` 等小写+连字符；根层可加后缀如 `architecture-ziwei.md`、`product-brief-ziwei-*.md`。

### 4.3 接口与配置

- 跨子项目调用优先使用**环境变量**配置基址（如 `DITING_AUDIT_URL`、`DITING_CHAIN_URL`），避免硬编码。
- DID 格式：`did:ziwei:<区块链标识>:<唯一哈希>`；链上 DID 服务 API 形态见技术方案 §3.6。

### 4.4 提交与发布

- 遵循各子项目现有约定（如谛听 COMMIT_GUIDANCE）；根目录变更需考虑对子项目引用路径的影响。

---

## 5. 架构决策记录（ADR）

### ADR-001：平台以复合体形式存在，功能下沉子模块

**状态**：已接受 | **日期**：2026-02-13  

**背景**：紫微包含天枢、谛听、太白等多类能力，若在单一代码库实现会导致边界模糊、职责交叉。

**决策**：平台层只定义「做什么、边界、接口与标准」；具体功能实现下沉至子模块（diting、tianshu、未来 taibai），各子模块自有 PRD、架构与 Issue/Story。

**后果**：子项目可独立迭代；跨子项目变更需对齐根技术方案与本架构文档；新能力若跨多子模块，须先在根层定义边界与接口。

---

### ADR-002：私有链归属谛听，天枢通过接口使用 DID

**状态**：已接受 | **日期**：2026-02-13  

**背景**：技术方案将 DID 与审计存证上链均锚定在「私有链」，需明确链的部署与 DID API 归属。

**决策**：私有链由**谛听**部署与管理；谛听暴露 DID 注册/查询 API 与审计存证/验真 API。天枢不运维链，仅调用上述 API 完成 DID 写链与查链。

**后果**：谛听需实现链子模块（如 diting I-016～I-018）；天枢在接口就绪后对接，无链代码依赖。

---

### ADR-003：根目录保留 BMAD 与规划产出，子项目各自 BMAD

**状态**：已接受 | **日期**：2026-02-13  

**背景**：需统一跨子项目规划与子项目本地规划的关系，避免重复或冲突。

**决策**：根目录（ziwei）安装 BMAD，产出产品简报、根架构、平台 Epic/下一步于 `ziwei/_bmad-output/planning-artifacts/`。各子项目保留各自 _bmad 与 _bmad-output，用于本子项目 Phase 2～4；子项目规划须引用根文档。

**后果**：根与子项目均有清晰规划落点；子项目 PM/开发需定期与根规划对齐（如对照 ISSUE_LIST 与根「下一步」）。

---

### ADR-004：太白独立子模块已建立，协议在根、SDK 与验证智能体在 taibai

**状态**：已接受 | **日期**：2026-02-13（v1.1 更新）  

**背景**：技术方案定义太白职责（SDK、适配器、接入规范）；集成验证需太白配合一个智能体做接入验证。

**决策**：**已建立太白子模块** `ziwei/taibai/`。协议权威仍在根技术方案 §4；`taibai` 提供 Python SDK 雏形与**验证用智能体**（examples/verification_agent），用于天枢+谛听集成接入验证。预置适配器（OpenClaw、Dify 等）可后续在 taibai 内扩展。

**后果**：接入验证可统一通过 `taibai/examples/verification_agent` 执行；天枢/谛听实现继续遵循根协议，与太白 SDK 对齐。

---

## 6. 与子项目架构的关系

- **本文档**：根目录、跨子项目；侧重 Integration、Standards、ADR。
- **子项目 architecture**（如 `diting/_bmad-output/planning-artifacts/architecture.md`）：本子项目内部组件、目录、技术选型与本地 ADR；不得与本文档及技术方案中的接口与归属约定冲突。
- 冲突时以**根技术方案 + 本架构文档**为准；子项目可补充「实现级」ADR（如目录布局、语言与框架选择）。

---

**文档结束**

---

## 附录：存储与身份管理（2026-02-21 更新）

### 存储后端

天枢使用可插拔存储后端，支持多种方案：

| 方案 | 环境 | 配置 |
|------|------|------|
| Memory | 开发/测试 | 默认 |
| SQLite | 中小规模 | `TIANSHU_STORAGE=sqlite` |
| MySQL | 企业级 | `TIANSHU_STORAGE=mysql` |
| PostgreSQL | 企业级 | `TIANSHU_STORAGE=postgres` |

### Owner 数据结构

```python
{
    "owner_id": "owner-xxx",
    "identities": {
        "email": {"address": "user@company.com"},
        "telegram": {"user_id": "5632751765"}
    },
    "channels": [
        {"type": "telegram", "receive_id": "5632751765", "enabled": true}
    ],
    "created_at": "2026-02-21T10:00:00Z",
    "updated_at": "2026-02-21T10:00:00Z"
}
```

### 谛听注册

谛听到天枢注册时，需提供预注册的 Owner ID：

```bash
# 谛听配置
DITING_OWNER_ID=owner-diting  # 天枢预注册的 Owner ID
```
