# 下一步：从 NAS 推送完成到本机一键启动

按顺序执行即可。

---

## 1. NAS：确认 Registry 在 5050 并完成推送

- 在 NAS 上把 Registry 容器端口改为 **5050**（例如 `-p 5050:5000`），并启动。
- 在本机执行（或 SSH 到 NAS 后执行）：
  ```bash
  cat deploy/nas-push-synapse.sh | ssh nas "cat > /tmp/nas-push-synapse.sh && sudo bash /tmp/nas-sudo-nopasswd-and-push.sh"
  ```
  若已配好 insecure-registries 且只需推送：
  ```bash
  cat deploy/nas-push-synapse-only.sh | ssh nas "cat > /tmp/nas-push-synapse-only.sh && sudo bash /tmp/nas-push-synapse-only.sh"
  ```

---

## 2. 本机：配置 .env

在 **ziwei 仓库根目录**：

```bash
# 若还没有 .env
cp deploy/env.example .env

# 编辑 .env：
# - 必填：FEISHU_APP_ID、FEISHU_APP_SECRET、MATRIX_GATEWAY_USER、MATRIX_GATEWAY_TOKEN
# - 使用 NAS 镜像时增加一行：
#   SYNAPSE_IMAGE=192.168.3.16:5050/synapse:v1.100.0
```

---

## 3. 本机：配置私有仓库并登录

**Docker**：在 `/etc/docker/daemon.json` 中加入 `"insecure-registries": ["192.168.3.16:5050"]`，然后：

```bash
sudo systemctl restart docker
docker login 192.168.3.16:5050
```

**Podman**：在 `~/.config/containers/registries.conf` 的 `[registries.insecure]` 中加入 `registries = ["192.168.3.16:5050"]`，然后：

```bash
podman login 192.168.3.16:5050
```

---

## 4. 本机：一键启动

在 **ziwei 仓库根目录**：

**Docker：**
```bash
docker compose -f deploy/docker-compose.integration.yml --env-file .env up -d
```

**Podman：**
```bash
cp deploy/docker-compose.integration.yml docker-compose.integration.yml
podman-compose -f docker-compose.integration.yml --env-file .env up -d
```

---

## 5. 健康检查

```bash
curl -s http://localhost:8080/healthz   # 谛听
curl -s http://localhost:8082/health   # 天枢
curl -s http://localhost:8008/health   # Synapse
```

---

详细说明见 `deploy/README.md`。
