# 天枢原生渠道（Matrix 房间）验证步骤

**目的**：在不配置飞书等企业 IM 的情况下，验证天枢通过 **Matrix 房间** 投递审批/通知消息，用户用 **Element** 等 Matrix 客户端加入房间即可看到。

---

## 1. 前置条件

- 已按 `deploy/README.md` 一键启动（**可不填**飞书凭证）。**验证统一使用 NAS Synapse**（`xyin.oicp.net`），天枢默认连 NAS，网关在 NAS 上注册。
- 天枢已连上 Matrix（启动日志无「Matrix 连接失败」）。
- 本机可访问天枢 HTTP（如 `http://localhost:8082`）；Synapse 为 NAS 上 `http://xyin.oicp.net:8008`，手机 Element 登录同一 Synapse（如 @hulk:xyin.oicp.net）即可收邀请、看消息。

---

## 2. 调用原生渠道演示接口

天枢提供 **GET /api/v1/delivery/native-demo**：会创建一间 Matrix 房间、向该房间投递一条「审批请求」消息（channel=matrix），并返回房间 ID / 别名，供你在 Element 中加入并查看。

```bash
# 天枢端口以你实际为准（compose 暴露为 8082）
curl -s http://localhost:8082/api/v1/delivery/native-demo
```

**成功时返回示例**（若配置了 `NATIVE_DEMO_INVITE_USER`，会向该用户发送房间邀请）：

```json
{
  "ok": true,
  "room_id": "!xxx:matrix.local",
  "event_id": "$xxx",
  "invited": "@hulk:xyin.oicp.net",
  "hint": "已向 @hulk:xyin.oicp.net 发送房间邀请，请在 Element 中接受邀请即可看到审批消息。"
}
```

**自动邀请你的 Matrix 账号**：启动天枢时设置环境变量 `NATIVE_DEMO_INVITE_USER` 为你的完整 Matrix ID（如 `@hulk:xyin.oicp.net`），调用 native-demo 后网关会自动邀请该用户进房间，在手机/桌面 Element 中接受邀请即可看到消息，无需管理员手动邀请。

- 若返回 **503** 且提示「Matrix 未连接」，说明天枢尚未连上 Synapse，可稍等约 20 秒后重试。
- 若返回 **500** 且「创建房间失败」，查看天枢容器日志：`podman logs ziwei-tianshu 2>&1 | grep -E "创建|Invalid"`。若出现 **Invalid access token**，多为网关 token 过期或与当前 Synapse 不一致，请**完整重启编排**使网关重新向 Synapse 注册并写入新 token：
  ```bash
  cd ziwei && podman-compose -f docker-compose.integration.yml down
  podman-compose -f docker-compose.integration.yml up -d
  sleep 25 && curl -s http://localhost:8082/api/v1/delivery/native-demo
  ```

---

## 3. 用 Element 加入房间并查看消息

1. **安装并打开 Element**  
   - 桌面端：<https://element.io/download>  
   - 或使用 Element Web：<https://app.element.io>

2. **连接你的 Synapse**  
   - 若 Synapse 在本机：在 Element 登录页选择「Edit」/「更改」，Homeserver 填 `http://localhost:8008`（或你暴露的 Synapse 地址）。  
   - 若使用 app.element.io，则无法连自建 Synapse，需用桌面版或自部署 Element Web 并配置 Homeserver。

3. **注册/登录 Matrix 用户**  
   - 在 Synapse 上注册一个新用户（例如 `@human:matrix.local`），或使用已有账号登录。

4. **加入房间**  
   - 若天枢配置了 **NATIVE_DEMO_INVITE_USER**（如 `@hulk:xyin.oicp.net`），调用 native-demo 后会自动向该用户发送邀请，在 Element 中接受邀请即可。  
   - 未配置时：需由已在房间内的用户（如网关账号）在 Element 中对你发起邀请到该 `room_id`，或使用支持通过 room_id 加入的客户端。

5. **查看投递消息**  
   - 房间内应有一条天枢网关账号发出的消息，内容为「【原生渠道验证】审批请求」及描述。  
   - 消息的 Matrix 类型为 `m.room.message`，content 中带 `msgtype: tianshu.delivery`、`semantic_type: approval_request` 等，说明原生渠道投递成功。

---

## 4. 可选：审批回执

当前演示仅验证「消息投递到 Matrix 房间」。若要验证「用户回复/点击链接完成审批」：

- **方式一**：在房间内回复「通过」或「拒绝」，需天枢 sync 解析回复并回传谛听（若已实现）。
- **方式二**：消息体内携带审批链接（指向天枢 HTTP 回调），用户在浏览器中点击完成审批；需在天枢侧实现对应回调并在 payload 中写入链接。

---

## 5. 房间复用与危险操作验证

- **同一房间可复用**：native-demo 创建并邀请你加入的房间，后续测试都可继续使用。建议将返回的 **room_id** 写入 `.env` 的 **DELIVERY_ROOM_ID**，则所有审批请求都会发到该房间。
- **与 Agent 对话、危险操作审批**：在该房间内验证「Agent 执行危险操作 → 谛听拦截 → 审批发到本房间 → 你在房间内批准/拒绝」的流程说明见 **`deploy/危险操作与Matrix审批验证.md`**。

---

## 6. 小结

| 步骤 | 操作 |
|------|------|
| 1 | 一键启动（可不配飞书） |
| 2 | `curl http://localhost:8082/api/v1/delivery/native-demo` |
| 3 | Element 接受邀请或加入返回的 room_id |
| 4 | 在房间内看到审批类消息即表示原生渠道验证通过 |
| 5 | 可选：设 DELIVERY_ROOM_ID 为该 room_id，按《危险操作与Matrix审批验证》做审批联调 |

**架构**：天枢不绑企业 IM 时，触达渠道为 Matrix 房间/私信（见 `docs/open/technical/紫微智能体治理基础设施-技术方案.md` §2.5）。
