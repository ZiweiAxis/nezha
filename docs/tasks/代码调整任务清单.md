# 代码调整任务清单

## 任务概览

| 阶段 | 任务 | 状态 |
|------|------|------|
| Phase 1 | 方案确认 | 待完成 |
| Phase 2 | 谛听独立化 | 待开始 |
| Phase 3 | 天枢清理 | 待开始 |
| Phase 4 | 调用统一 | 待开始 |

---

## Phase 1: 方案确认

### T1.1 更新设计文档

- [ ] 更新 `紫微整体集成架构.md` - 明确谛听是独立子项目
- [ ] 更新 `MEMORY.md` - 修正模块路径
- [ ] 更新所有模块的 README - 修正依赖关系

---

## Phase 2: 谛听独立化

### T2.1 创建独立项目结构

```bash
# 创建目录
mkdir -p ziwei/diting/{cmd,internal,pkg,docs}

# 移动代码（从 xiezhi/cmd/diting/）
mv xiezhi/cmd/diting/* ziwei/diting/
```

### T2.2 修复 Go 依赖

**需要修改的 import**：
```go
// 旧 import
import "diting/internal/config"

// 新 import
import "github.com/ZiweiAxis/diting/internal/config"
```

**需要更新的文件**：
- [ ] `ziwei/diting/go.mod` - 设置 module 路径
- [ ] `ziwei/xiezhi/go.mod` - 移除 `diting` 依赖
- [ ] 所有引用 `diting` 的 import 路径

### T2.3 更新 CI/CD

- [ ] 创建 `.github/workflows/diting.yml`
- [ ] 更新 `xiezhi/.github/workflows/` - 移除谛听构建

### T2.4 更新部署配置

- [ ] 更新 `docker-compose.yml`
- [ ] 更新 Kubernetes 部署（如有）

---

## Phase 3: 天枢清理

### T3.1 清理diting_client

**选项 A：完全删除**
```bash
rm -rf tianshu/src/diting_client/
```

**选项 B：重构为使用太白 SDK**
```python
# 旧代码（直接调用）
from src.diting_client.chain_did import register_did

# 新代码（通过太白）
from src.taibai import TaibaiClient
client = TaibaiClient()
client.register_did(...)
```

- [ ] 评估选择方案 A 或 B
- [ ] 执行清理/重构

### T3.2 更新天枢依赖

- [ ] 检查 `tianshu/requirements.txt` - 移除不必要的依赖
- [ ] 更新 `tianshu/README.md` - 修正模块说明

---

## Phase 4: 调用统一

### T4.1 检查直接调用

搜索所有直接调用天枢的代码：
```bash
# 检查 Go
grep -r "http://.*tianshu" --include="*.go"

# 检查 Python  
grep -r "requests\.\|http\." --include="*.py" tianshu/src/
```

需要替换的位置：
- [ ] `xiezhi/` - 使用太白 SDK
- [ ] `nezha/` - 使用太白 SDK
- [ ] `tianshu/` - 内部调用保持，但对外接口统一

### T4.2 集成太白 SDK

**Go 端**：
```go
import "github.com/ZiweiAxis/taibai-go"

client := taibai.NewClient(taibai.Config{
    Endpoint: "http://tianshu:8081",
    Token:   "...",
})
client.SendMessage(...)
```

**Python 端**：
```python
from taibai import TaibaiClient

client = TaibaiClient(endpoint="http://tianshu:8081", token="...")
client.send_message(...)
```

- [ ] 在各模块中集成太白 SDK
- [ ] 移除直接 HTTP 调用

---

## 详细任务清单

### 任务列表

| ID | 任务 | 涉及文件 | 预估工作量 |
|----|------|----------|------------|
| T1.1.1 | 更新紫微整体集成架构.md | docs/ | 0.5h |
| T1.1.2 | 更新 MEMORY.md | MEMORY.md | 0.5h |
| T2.1.1 | 创建 ziwei/diting/ 目录 | - | 1h |
| T2.1.2 | 移动代码 | xiezhi/cmd/diting/* | 2h |
| T2.2.1 | 修复 Go import | diting/*.go | 4h |
| T2.2.2 | 更新 xiezhi/go.mod | xiezhi/go.mod | 1h |
| T2.3.1 | 创建 CI/CD | .github/workflows/ | 2h |
| T2.4.1 | 更新部署配置 | docker-compose.yml | 1h |
| T3.1.1 | 评估清理方案 | - | 1h |
| T3.1.2 | 执行清理 | tianshu/src/diting_client/ | 4h |
| T3.2.1 | 更新天枢依赖 | requirements.txt | 0.5h |
| T4.1.1 | 检查直接调用 | 各模块 | 2h |
| T4.2.1 | 集成太白 SDK | 各模块 | 8h |

**总计预估：~27 小时**

---

## 风险与注意事项

### 风险

1. **代码依赖复杂** - 谛听与獬豸有大量共享代码
2. **import 路径变更** - 可能破坏现有功能
3. **测试覆盖** - 需要完整回归测试

### 注意事项

1. **先备份** - 操作前确保代码已提交
2. **小步迭代** - 每个变更后测试
3. **文档同步** - 代码变更必须同步文档

---

## 依赖关系

```
T2.1 (创建目录) ──┬── T2.2 (修复依赖)
                   │
T3.1 (清理) ──────┤
                   │
T4.2 (集成SDK) ◀─┘
```

建议执行顺序：
1. Phase 1 (文档)
2. Phase 2 (谛听独立) 
3. Phase 3 (天枢清理)
4. Phase 4 (调用统一)
