# 悟空模块谛听客户端 PRD

**项目名称**：悟空谛听客户端  
**版本**：v1.0  
**日期**：2026-02-17  
**状态**：初稿

---

## 1. 概述

### 1.1 背景

悟空作为紫微平台的 Agent 管理框架，需要集成谛听的安全治理能力。谛听负责策略管理和审批，悟空作为客户端需要：

- 接收并执行谛听下发的安全策略
- 在本地进行策略评估，判断请求是否需要转发谛听
- 管理需要审批的任务挂起与恢复
- 处理 JIT（Just-In-Time）动态策略
- 返回执行结果

当前 TaskSuspendManager 已实现基础的挂起功能，需要扩展为完整的谛听客户端功能。

### 1.2 目标

为悟空模块实现完整的谛听客户端能力，使其能够：
- 接收并本地存储谛听下发的策略规则
- 在请求执行前进行本地策略评估
- 对超出策略范围的请求进行审批挂起
- 处理审批结果和 JIT 动态策略
- 与谛听服务保持通信

---

## 2. 目标用户与场景

### 2.1 目标用户

| 用户类型 | 使用场景 |
|----------|----------|
| **运维人员** | 配置悟空与谛听的连接参数，管理策略同步 |
| **Agent 开发者** | 通过悟空启动 Agent，享受自动的安全策略保护 |
| **安全审计人员** | 通过谛听审批界面审核 Agent 的高风险操作 |

### 2.2 典型使用场景

#### 场景一：Agent 启动时的身份注册与审批
1. 运维人员通过悟空启动 Claude Code Agent
2. 悟空向天枢注册 Agent 身份
3. 如果 Agent 类型需要审批，任务被挂起
4. 运维人员在谛听审批界面批准 Agent
5. 悟空收到批准消息，Agent 开始运行

#### 场景二：文件操作拦截
1. Agent 尝试写入敏感文件（如 `/etc/passwd`）
2. 悟空拦截请求，本地策略评估发现需要审批
3. 任务挂起，推送审批请求到谛听
4. 运维人员审批通过
5. 悟空执行写入操作，记录审计日志

#### 场景三：JIT 临时策略
1. Agent 需要访问特定数据库表（一次性需求）
2. 悟空转发请求到谛听
3. 审批通过后，谛听下发 JIT 临时策略（如 1 小时有效）
4. 悟空执行请求，策略过期后自动失效

---

## 3. 功能需求列表

### 3.1 核心功能

| 功能 ID | 功能名称 | 优先级 | 描述 |
|---------|----------|--------|------|
| F01 | 策略接收与存储 | P0 | 接收谛听下发的策略规则，存储到本地 |
| F02 | 本地策略评估 | P0 | 在请求执行前进行策略评估，返回 Allow/Deny/Review |
| F03 | 请求拦截 | P0 | 拦截 Agent 的请求，判断是否需要转发谛听 |
| F04 | 任务挂起管理 | P0 | 挂起需要审批的任务，管理任务状态 |
| F05 | 审批状态轮询 | P0 | 轮询谛听获取审批状态，处理审批结果 |
| F06 | JIT 策略处理 | P1 | 接收并应用 JIT 临时策略，处理策略过期 |
| F07 | 执行结果返回 | P0 | 将执行结果返回给 Agent |
| F08 | 策略更新监听 | P1 | 监听谛听的策略更新推送 |

### 3.2 管理功能

| 功能 ID | 功能名称 | 优先级 | 描述 |
|---------|----------|--------|------|
| F09 | 策略同步 | P1 | 手动触发与谛听的策略同步 |
| F10 | 状态查询 | P2 | 查询当前挂起任务、策略状态 |
| F11 | 日志记录 | P1 | 记录所有策略评估、审批过程 |

### 3.3 与现有模块的关系

| 功能 | 依赖模块 | 说明 |
|------|----------|------|
| 策略接收与存储 | TaskSuspendManager | 复用现有存储机制 |
| 任务挂起管理 | TaskSuspendManager | 扩展现有挂起功能 |
| 审批状态轮询 | TaskSuspendManager | 复用现有轮询逻辑 |
| 策略评估 | AgentManager | 集成到请求拦截流程 |

---

## 4. 非功能需求

### 4.1 性能需求

| 指标 | 要求 | 说明 |
|------|------|------|
| 本地策略评估延迟 | < 10ms | 策略评估应在 10ms 内完成 |
| 审批轮询间隔 | 默认 3s | 可配置，建议 1-10s |
| 策略同步时间 | < 5s | 全量策略同步应在 5s 内完成 |
| 并发挂起任务数 | 支持 100+ | 应能同时管理多个挂起任务 |

### 4.2 可用性需求

| 指标 | 要求 |
|------|------|
| 与谛听失联处理 | 本地缓存策略可继续评估，审批任务进入等待 |
| 进程重启恢复 | 持久化的挂起任务和策略应能恢复 |
| 策略版本管理 | 支持策略版本回滚 |

### 4.3 安全需求

| 指标 | 要求 |
|------|------|
| 通信安全 | 与谛听通信使用 HTTPS |
| 策略完整性 | 策略存储需防篡改 |
| 审计日志 | 所有关键操作需记录审计日志 |

### 4.4 扩展性需求

| 指标 | 要求 |
|------|------|
| 策略引擎插件 | 支持扩展新的策略评估引擎 |
| 多种策略格式 | 支持 Cedar JSON、Rego 等格式 |

---

## 5. 用户流程与交互

### 5.1 流程一：Agent 启动与审批

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   运维人员   │     │     悟空     │     │     天枢     │     │     谛听     │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                   │                     │                     │
       │ 启动 Agent         │                     │                     │
       │───────────────────▶│                     │                     │
       │                   │ 注册身份             │                     │
       │                   │─────────────────────▶│                     │
       │                   │◀─────────────────────│                     │
       │                   │ 需审批               │                     │
       │                   │                     │                     │
       │                   │ 挂起任务             │                     │
       │                   │◀────────────────────│                     │
       │                   │                     │                     │
       │                   │                     │   创建审批请求       │
       │                   │────────────────────▶│                     │
       │                   │                     │                     │
       │ 审批通过          │                     │                     │
       │◀─────────────────│                     │                     │
       │                   │ 审批结果             │                     │
       │                   │◀────────────────────│                     │
       │                   │                     │                     │
       │                   │ 执行任务             │                     │
       │◀──────────────────│                     │                     │
```

### 5.2 流程二：请求拦截与审批

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    Agent     │     │     悟空     │     │     谛听     │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       │ 执行操作            │                    │
       │───────────────────▶│                    │
       │                    │ 本地策略评估        │
       │                    │ ──────────────▶    │
       │                    │                    │
       │                    │ 返回 Review        │
       │                    │◀───────────────    │
       │                    │                    │
       │                    │ 转发审批请求        │
       │                    │───────────────────▶
       │                    │                    │
       │                    │ 挂起任务            │
       │◀──────────────────│                    │
       │                    │                    │
       │                    │ 审批结果 + JIT 策略 │
       │                    │◀───────────────────
       │                    │                    │
       │                    │ 执行操作            │
       │◀──────────────────│                    │
```

---

## 6. 数据模型

### 6.1 策略模型

```typescript
interface Policy {
  id: string;
  version: string;
  type: 'static' | 'jit';
  rules: PolicyRule[];
  createdAt: Date;
  expiresAt?: Date;
  scope?: {
    resources?: string[];
    actions?: string[];
    subjects?: string[];
  };
}

interface PolicyRule {
  id: string;
  effect: 'allow' | 'deny';
  principal?: string;
  action: string;
  resource: string;
  conditions?: Record<string, any>;
}
```

### 6.2 挂起任务模型

（见 TaskSuspendManager.ts 现有实现）

---

## 7. 验收标准

### 7.1 功能验收

| 功能 ID | 验收条件 |
|---------|----------|
| F01 | 能够接收并存储谛听下发的 JSON 格式策略 |
| F02 | 本地策略评估在 10ms 内返回决策 |
| F03 | 正确拦截需要转发的请求 |
| F04 | 任务挂起/恢复功能正常 |
| F05 | 审批状态轮询正确处理各种状态 |
| F06 | JIT 策略在过期后自动失效 |
| F07 | 执行结果正确返回给 Agent |
| F08 | 策略更新能够实时同步 |

### 7.2 非功能验收

| 指标 | 验收条件 |
|------|----------|
| 性能 | 策略评估延迟 < 10ms |
| 可用性 | 与谛听失联时不影响已有策略评估 |
| 安全 | 通信使用 HTTPS，敏感数据加密存储 |

---

## 8. 术语表

| 术语 | 定义 |
|------|------|
| 谛听 | 紫微平台的策略管理和审批服务 |
| 悟空 | 紫微平台的 Agent 管理框架（客户端） |
| JIT 策略 | Just-In-Time 临时策略，审批通过后生成 |
| CHEQ | 审批确认请求（Confirmation Request） |
| 策略评估 | 根据规则判断请求是否允许通过 |

---

**文档结束**
