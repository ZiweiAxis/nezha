# 风险分析层技术方案 - 提案

> 状态：讨论中
> 创建时间：2026-02-16
> 来源：克浩提供

---

## 结论

**"基于算法的跟踪与预测 + 风险判断"** 业界已有成熟开源技术，可直接用于商业项目，许可证友好。

已有能力：**Cedar 授权 + 网关 + CHEQ** = 策略/决策层

需要补充：**行为/风险分析层** + **决策/治理层**

---

## 一、整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                    已有层                                            │
├─────────────────────────────────────────────────────────────────────┤
│  PEP (网关/Xiezhi) → PDP (Cedar) → CHEQ (人类确认)                 │
└─────────────────────────────────────────────────────────────────────┘
                              ↑
                              │ 调用
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    新增：风险分析与决策层                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐          │
│  │   UEBA       │ → │  RiskEngine  │ → │   Decision   │          │
│  │ 行为分析引擎  │   │  风险评分引擎  │   │  决策框架     │          │
│  └──────────────┘   └──────────────┘   └──────────────┘          │
│       ↑                                    │                        │
│       │ 行为特征/异常分                    │ 最终决策                │
│       │                                    ▼                        │
│       └────────────────────────────────────────┘                    │
│                           PDP (Cedar)                               │
└─────────────────────────────────────────────────────────────────────┘
```

**核心思路**：
- **Cedar** 负责"能不能做"的授权判断
- **UEBA / RiskEngine / Decision** 负责"这个操作/主体有多危险，要不要额外处理"

---

## 二、可落地的开源技术栈

### 1. 行为分析与异常检测（UEBA / Anomaly Detection）

| 项目 | 许可证 | 说明 |
|------|--------|------|
| **Kitsune** (MIT) | ✅ 商业友好 | 在线网络异常检测，基于自编码器，无监督，适合实时流 |
| **OpenUBA** (GPL-3.0) | ⚠️ 需注意 | 开源 UEBA 框架，内置多种 ML 模型，需作为独立服务调用 |
| Apache Metron / Wazuh | 较重 | 完整 SIEM/XDR 方案，适合已有日志平台 |

**推荐**：Kitsune（MIT）+ 自建特征工程

---

### 2. 风险评分引擎（Risk Scoring Engine）

| 项目 | 许可证 | 说明 |
|------|--------|------|
| **Financial-Fraud-Risk-Engine** (MIT) | ✅ 商业友好 | 端到端金融欺诈风险评分，含 ML 流水线 + SHAP 可解释 |
| 自建 Risk Scoring Service | - | 推荐：用 Python 写，集成 XGBoost/LightGBM |

---

### 3. 决策层：Policy-as-Code

| 项目 | 许可证 | 说明 |
|------|--------|------|
| **decision-layer** (MIT) | ✅ 商业友好 | 决策框架，把策略/法规变成可执行函数，支持 OPA/Rego 集成 |
| **OPA / Rego** | Apache-2.0 | 可用 Rego 写风险决策策略 |

---

### 4. AI 治理与风险框架（参考）

- **FINOS AI Governance Framework** - 金融业开源 AI 治理框架
- **NIST AI RMF** - AI 风险管理框架
- **CSA AI Model Risk Management** - AI 模型风险管理

---

## 三、许可证与商业冲突

### 商业友好的许可证（可闭源商用）

- **MIT**：Kitsune、Financial-Fraud-Risk-Engine、decision-layer
- **Apache-2.0**：OPA

### 需要注意的许可证

- **GPL-3.0**（如 OpenUBA）：可以商用，但若修改源码并分发需开源

---

## 四、推荐落地方案

### 1. UEBA 服务

**方案**：部署 OpenUBA（GPL-3.0）作为独立 UEBA 服务，只调用其接口

- 不修改源码，作为独立服务部署
- 输入：AI 操作事件日志
- 输出：行为特征、异常分

### 2. 风险评分服务

**方案**：参考 Financial-Fraud-Risk-Engine（MIT）架构，自建风险评分服务

```
输入：
├─ 主体 DID
├─ 操作类型
├─ 资源特征
└─ 上下文（时间、设备、来源等）

输出：
├─ risk_score (0-1)
├─ risk_level (low/medium/high)
└─ risk_tags (abnormal_access, excessive_export, etc.)
```

### 3. 决策层

**方案**：使用 decision-layer（MIT）作为"决策框架"

整合内容：
- Cedar 的授权结果
- 风险评分结果
- CHEQ 是否已确认

输出：统一决策给网关（Allow/Deny/Review + 风险标签）

### 4. 治理与合规

- **FINOS AI Governance Framework** - 风险清单和治理流程
- **NIST / CSA AI RMF** - 持续监控思路

---

## 五、与现有系统的集成

| 现有模块 | 集成方式 |
|----------|----------|
| Cedar (PDP) | 决策框架调用 Cedar 获取授权结果 |
| CHEQ | 高风险操作触发人工确认 |
| Xiezhi (PEP) | 接收最终决策，执行 Allow/Deny/Review |
| 审计日志 | 记录风险评分、决策过程 |

---

## 六、小结

| 层次 | 已有 | 需要补充 |
|------|------|----------|
| 授权决策 | ✅ Cedar | - |
| 风险判断 | ❌ | ✅ UEBA + 风险评分 |
| 人工确认 | ✅ CHEQ | - |
| 治理合规 | ❌ | ✅ FINOS / NIST |

**结论**：Cedar 已经解决了"授权决策"，但"风险判断 + 行为分析"需要单独一层。业界已有不少 MIT/Apache-2.0 开源项目，可直接在商业项目中使用，商业冲突很小。

---

## 七、核心竞争点：基于 Trace 链的操作一致性风险识别（产品差异化）

> 状态：架构确认，待迭代实现
> 重要性：产品核心竞争壁垒，需知识产权保护

### 7.1 创新背景

传统风险分析（UEBA）基于**单点行为统计**：某个主体在某个时间做了某个操作，与历史基线比对，判断是否异常。

这对 AI Agent 场景是不够的。AI Agent 的操作具有**意图驱动、多步骤、跨资源**的特征：

```
人类指令："帮我清理一下测试环境的过期数据"
    ↓
Agent 实际执行链：
  1. list_files("/data/test/")
  2. read_file("/data/test/config.json")   ← 读取配置
  3. query_db("SELECT * FROM logs WHERE date < '2024-01-01'")
  4. delete_db("DELETE FROM logs WHERE date < '2024-01-01'")
  5. rm("/data/test/archive/2023/")
  6. curl("http://external-api/notify")    ← 异常：为何通知外部？
```

单点看每个操作都可能"合理"，但**整条 Trace 链的操作序列与原始意图之间的一致性**才是真正的风险信号。

### 7.2 核心创新：意图-行为一致性校验

獬豸在策略评估过程中，结合 Trace 链进行**操作一致性风险识别**：

```
原始指令（意图）
    ↓
预期操作图谱（由策略引擎 + LLM 推断）
    ↓
实际 Trace 链（谛听采集）
    ↓
一致性比对算法
    ↓
风险向量 { deviation_score, anomaly_ops, risk_tags }
    ↓
注入 PDP 评估上下文 → 影响 allow/deny/review 决策
```

**关键差异**：不是看"这个操作本身危不危险"，而是看"这个操作在当前意图上下文中是否合理"。

### 7.3 风险识别维度

| 维度 | 检测内容 | 示例 |
|------|---------|------|
| 操作范围越界 | 实际操作的资源超出意图声明的范围 | 清理测试数据却访问了生产库 |
| 操作序列异常 | 操作顺序与正常模式不符 | 先删除后读取（逻辑倒置） |
| 隐蔽外联 | Trace 链中出现未声明的外部调用 | 数据操作后调用外部 API |
| 权限爬升 | 操作链中出现逐步提权的模式 | 读→写→执行→管理员操作 |
| 数据外泄路径 | 敏感数据读取后出现导出/传输操作 | read(PII) → export → curl |
| 调用链深度异常 | 子 Agent 调用链超出预期深度 | 预期 1 层，实际 3 层嵌套 |

### 7.4 与策略引擎的结合点

这是策略引擎的创新扩展，不是独立模块：

```
谛听拦截请求
    ↓
獬豸 PDP 评估
    ├── 标准 ABAC 规则匹配（subject/action/resource）
    ├── PIP 业务数据属性拉取（细粒度权限）
    └── Trace 链一致性分析（本创新点）
            ↓
        风险向量注入评估上下文
            ↓
        综合决策：allow / deny / review（附风险标签）
```

风险向量作为 `Environment` 属性参与 ABAC 评估，策略规则可以引用：

```yaml
- id: "r-high-risk-trace"
  conditions:
    - attr: "env.trace_deviation_score"
      op: ">="
      value: 0.7
  decision: "review"
  reason: "操作链与意图偏差过大，需人工确认"
```

### 7.5 知识产权价值

此创新点具备专利申请价值：

- 现有 UEBA 专利均基于单点行为统计，无意图-行为一致性建模
- 现有策略引擎专利（Cedar/OPA）不涉及 Trace 链分析
- 将 Trace 链分析结果作为 ABAC 评估上下文属性注入，是全新的组合架构

建议专利名称：**《一种基于操作 Trace 链与原始意图一致性分析的 AI Agent 风险识别方法》**

优先级：P1（架构稳定后申请，预计 2026 年 Q3）

---

## 八、设计决策记录（2026-02-xx）

### 8.1 marker 生命周期管理

**典型场景**：CI/CD 发布窗口——发布流程开启期间允许多次部署操作，流程关闭后权限自动收回。marker 的设计意图与此完全契合。

**决策**：
- 当前阶段采用**方案 A**：只有人类操作员可创建/关闭 marker
- marker 创建需声明关联资源范围，策略规则只能在对应范围内引用
- 支持 TTL 强制上限兜底，防止忘记关闭
- 所有 marker 变更记录到不可篡改的 audit log
- 待后续出现「agent 需要自主开窗口」的明确业务需求后，再升级到方案 B/C

### 8.2 来源维度（Origin）可靠识别

**决策**：
- 来源信息从调用链上下文提取，不依赖 agent 自报
- `origin_context`（根节点信息 + 调用深度）由谛听注入并签名，agent 无法伪造
- **保守策略**：调用链中只要有 agent 节点，即判定为 agent 触发，不继承人类信任级别
- 人类通过 agent A 间接触发 agent B，算 agent 触发，不做信任级别传递

### 8.3 PIP 接口设计

**决策**：
- PIP 调用并行化，多个 source 同时拉取
- **分级 TTL**：敏感属性（金额、状态）100ms，非敏感属性（owner_id）5s
- **fail-close 边界**：PIP 超时/500/网络不可达一律 deny，不可降级为 fail-open
- 超时阈值：50ms，超时即 deny
- 属性缺失时策略规则可自定义默认值，但默认行为为 deny

### 8.4 来源维度：origin_context 签名与跨服务传递

**签名机制**：谛听在消息入口注入 `origin_context`，HMAC-SHA256 签名，密钥只有谛听持有，PDP 验签调用谛听验签接口不暴露密钥。

```json
{
  "origin_context": {
    "root_type": "human",
    "root_id": "did:ziwei:user:xxx",
    "session_id": "sess_abc",
    "call_depth": 0,
    "timestamp": 174000000,
    "sig": "hmac_sha256(payload, diting_secret)"
  }
}
```

**跨服务传递**：以 HTTP header `X-Ziwei-Origin-Context` 透传，每个谛听 sidecar 负责验签、生成根节点、`call_depth` +1 后重新签名。

**决策**：采用方案 A——所有 sidecar 共享同一 HMAC 密钥，配合密钥轮换机制，早期够用，后续按需升级到签名链方案。

### 8.5 PIP 接口规范

**标准协议**：PIP source 实现统一 HTTP 接口，mTLS 认证为硬要求。

```
POST /pip/v1/attributes
{ "subject", "resource", "attributes": [...] }

响应：{ "attributes": {...}, "missing": [], "ttl_hints": {...} }
```

**TTL 策略**：业务系统通过 `ttl_hints` 声明每个属性的建议缓存时长，獬豸取 `min(配置上限, ttl_hints)`。

**适配成本**：业务系统只需实现该接口，已有内部权限接口写薄适配层转换格式即可。

---

## 九、相关文档

- [网关拦截流程设计-提案.md](./网关拦截流程设计-提案.md)
- [CHEQ-IETF草案.md](../open/technical/CHEQ-IETF草案.md)
