# Matrix 端到端流程设计

> 状态：讨论中
> 创建时间：2026-02-16

---

## 一、流程概述

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  Agent  │────▶│  天枢   │────▶│  谛听  │────▶│ Matrix │
│ (悟空)   │     │         │     │         │     │         │
└─────────┘     └────┬────┘     └────┬────┘     └─────────┘
     │                │                │
     │ 1. 注册请求    │ 2. SDK拦截    │ 3. 后台审批
     │ (无感知)       │ (无感知)       │ (异步)
     │────────────────▶│               │
     │                │───▶│           │
     │                │               │───▶│
     │                │               │    │
     │                │ 4. 审批通过   │    │
     │                │◀──────────────│    │
     │                │               │    │
     │ 5. 注册成功    │ 6. DID下发    │    │
     │◀──────────────│◀──────────────│    │
     │                │                │    │
     │         7. 用 DID 在 Matrix 和用户对话              │
     │◀─────────────────────────────────────────────────│
     │                │                │    │
     │ 8. 用户指令    │                │    │
     │────────────────▶│                │    │
     │         9. 拦截 → 推送审批    │───▶│
     │◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀│
     │                │                │    │
     │         10. 审核 → 放行/拒绝 │◀────│
     │◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀◀│
```

> **关键说明**：注册流程与执行拦截流程不同：
> - **注册**：悟空注册模块和天枢都是**无感知**谛听的，SDK在后台拦截并处理审批
> - **执行**：操作被拦截时需要显式审批

---

## 二、详细流程

### 第一阶段：Agent 注册与审批

```
1. Agent 向天枢发起注册请求
       ↓
2. 天枢将请求转发给谛听（经代理/鉴权）
       ↓
3. 谛听拦截，策略判断需要审批（Review）
       ↓
4. 谛听调用天枢投递 API（POST /api/v1/delivery/approval-request）
       ↓
5. 天枢将审批消息推送到 Matrix 房间（owner 的房间）
       ↓
6. owner 在 Matrix 点击批准
       ↓
7. 回调通知天枢 → 通知谛听
       ↓
8. 审批通过 → 谛听放行 → 天枢完成注册
       ↓
9. 天枢向 Agent 下发：
   - 唯一 Agent DID
   - Matrix Room ID（该 Agent ↔ User 的专属房间）
   - owner 已加入该 Room
```

### 第二阶段：Agent 正常工作

```
10. Agent 使用唯一 DID 在 Matrix 中和用户对话
       ↓
11. 用户发送指令
       ↓
12. Agent 执行操作 → 谛听拦截
       ↓
13. 谛听判断需要审批 → 调用天枢投递 API
       ↓
14. 推送到 Matrix 房间（用户所在房间）
       ↓
15. 用户审核 → 点击批准/拒绝
       ↓
16. 回调 → 谛听放行/拒绝
       ↓
17. Agent 收到执行结果 → 返回给用户
```

---

## 三、关键设计

### 1. 谛听的 DID

- 谛听固定 DID：`did:ziwei:local:diting`（或类似格式）
- 启动时自动连接 Matrix（通过天枢）
- 需要解决授权问题：如何让谛听自动接入天枢

### 2. Agent 的 DID

| 类型 | 说明 | 用途 |
|------|------|------|
| **唯一 Agent DID** | 注册时分配，长期有效 | 身份标识 |
| **Matrix Room ID** | 每个 Agent ↔ User 创建专属 Room | 消息推送、审批 |

**Room 规则**：
- 每个 Agent 和对应 User 创建**专属 Matrix Room**
- 首次注册时自动创建 Room
- **owner 必须加入**该 Room（用于接收审批和对话）

### 3. 投递方式

**保持现有方案**：经天枢投递
- 谛听调用 `POST /api/v1/delivery/approval-request`
- 天枢负责推送到 Matrix 房间

### 4. 审批流程

- 首次注册：需要 owner 审批
- 后续操作：根据策略决定是否需要审批

---

## 四、与现有模块的对应

| 模块 | 职责 | 现有能力 |
|------|------|----------|
| 天枢 | 消息枢纽、投递 API、Agent 注册 | ✅ MVP |
| 谛听 | 拦截、策略评估、CHEQ | ✅ MVP |
| Matrix | 消息通道、用户交互 | ✅ Synapse |

---

## 五、待确认问题

1. ~~Agent 如何获取 Matrix Room ID？~~ → 天枢创建，绑定 Agent ↔ User，下发给 Agent
2. ~~虚拟 DID / 临时 DID 的具体实现方式？~~ → 暂不需要，每个 Agent 一个 Room
3. **谛听启动授权**：谛听启动时自动连接天枢，需要解决授权问题（如预共享密钥、配置 token 等）

---

## 六、相关文档

- [天枢-方案相关待办.md](../../tianshu/docs/天枢-方案相关待办.md)
- [网关拦截流程设计-提案.md](./网关拦截流程设计-提案.md)
