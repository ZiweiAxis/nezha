# 网关拦截流程设计 - 提案

> 状态：讨论中
> 创建时间：2026-02-16
> 更新：2026-02-17

## 背景

当前谛听网关已实现基础的 L0/L1/L2 策略评估和 CHEQ 人工确认机制，但缺少完整的架构设计文档：
- 悟空拦截器的角色
- 策略下发与执行流程
- JIT 动态策略更新机制
- 两种拦截通道的区分

---

## 一、核心角色定义

### 架构概览

```
┌─────────────┐     策略下发      ┌─────────────┐     策略管理+审批    ┌─────────────┐
│    Agent     │ ─────────────────▶│    悟空     │ ─────────────────▶│    谛听     │
│  (发起请求)   │                    │  (拦截器)   │                    │ (策略+审批)  │
└─────────────┘                    └──────┬──────┘                    └──────┬──────┘
       │                                 │                                 │
       │ 1. 请求                         │                                 │
       │────────────────────────────────▶│                                 │
       │                                 │ 2. 策略内?                      │
       │                                 │    ├─ 是 → 直接执行 → 返回     │
       │                                 │    └─ 否 → 转发谛听            │
       │                                 │────────────────────────────────▶│
       │                                 │                                 │
       │                                 │ 3. 策略外 → 审批               │
       │                                 │◀────────────────────────────────│
       │                                 │                                 │
       │                                 │ 4. JIT 动态策略更新             │
       │                                 │◀────────────────────────────────│
       │                                 │                                 │
       │                                 │ 5. 执行请求                     │
       │                                 │────────────────────────────────▶│
       │                                 │                                 │
       │◀────────────────────────────────│                                 │
```

### 角色职责

#### 悟空（拦截器）

| 职责 | 说明 |
|------|------|
| **策略接收** | 接收并存储谛听下发的策略规则 |
| **策略执行** | 根据策略规则判断请求是否允许通过 |
| **策略内放行** | 请求在策略允许范围内，直接执行 |
| **策略外转发** | 请求超出策略范围，转发给谛听处理 |
| **任务挂起** | 审批期间挂起任务，审批通过后执行 |
| **结果返回** | 返回执行结果给 Agent |

#### 谛听（策略+审批服务）

| 职责 | 说明 |
|------|------|
| **策略管理** | 策略的创建、更新、下发 |
| **策略下发** | 将策略推送给悟空拦截器 |
| **审批处理** | 对超出策略的请求进行人工审批 |
| **JIT 动态策略** | 审批通过后，生成临时策略并推送给悟空 |
| **审计日志** | 记录所有请求和审批过程 |

---

## 二、策略下发与执行流程

### 第一阶段：策略下发

```
谛听 → 悟空：推送策略规则
       │
       ├─ 全量策略更新
       └─ 增量策略更新
```

**实现方式**：
- HTTP 推送或 WebSocket 长连接
- 策略格式：Cedar JSON 或 Rego

### 第二阶段：请求拦截（核心逻辑）

```
Agent → 悟空：发起请求
       │
悟空 → 本地策略引擎：评估请求
       │
       ├─ 策略允许 → 直接执行 → 返回结果
       │
       └─ 策略不允许 → 转发谛听 → 等待审批
```

**详细流程**：

```
1. 请求进入悟空拦截器
   │
2. 提取请求上下文
   ├─ action（操作类型）
   ├─ resource（目标资源）
   ├─ subject（DID/身份）
   └─ 环境属性
   │
3. 本地策略评估
   ├─ 查询本地策略规则
   ├─ 匹配 action + resource + subject
   └─ 返回决策：Allow / Deny / Review
   │
4. 分支处理
   │
   ├─ Allow → 直接执行 → 返回结果
   │
   ├─ Deny → 直接拒绝 → 返回错误
   │
   └─ Review → 转发谛听审批
       │
       ├─ 创建 CHEQ
       ├─ 推送到审批渠道（Matrix/飞书）
       └─ 等待审批结果
```

---

## 三、审批与 JIT 动态策略

### 审批流程

```
悟空 → 谛听：转发请求（需要审批）
       │
谛听 → 审批渠道：推送审批请求（Matrix/飞书）
       │
用户 → 审批渠道：批准/拒绝
       │
审批渠道 → 谛听：审批结果
       │
谛听 → 悟空：JIT 动态策略更新 + 执行结果
```

### JIT 动态策略

审批通过后，谛听生成临时策略并推送给悟空：

```json
{
  "type": "jit_policy",
  "policy_id": "jit-20260217-001",
  "subject": "did:agent:ai-007",
  "scope": {
    "resource": "database:customers",
    "rows": "region='US'",
    "columns": ["name", "email"]
  },
  "actions": ["read"],
  "expires_at": "2026-02-17T11:00:00Z",
  "context": {
    "approved_by": "did:human:alice",
    "request_id": "cheq-xxx"
  }
}
```

**悟空收到 JIT 策略后**：
1. 存储临时策略
2. 执行被挂起的请求
3. 策略过期后自动清理

---

## 四、任务挂起机制

### 状态流转

```
┌─────────┐     审批通过      ┌─────────┐
│  挂起中  │ ──────────────▶│  执行中   │
└─────────┘                  └─────────┘
     ▲                          │
     │      审批拒绝/超时        │
     └──────────────────────────┘
```

### 悟空端实现

```typescript
interface PendingTask {
  taskId: string;
  request: AgentRequest;
  createdAt: Date;
  status: 'pending' | 'approved' | 'rejected' | 'timeout';
}

class WukongInterceptor {
  private pendingTasks: Map<string, PendingTask> = new Map();
  
  // 拦截请求
  async intercept(request: AgentRequest): Promise<Response> {
    // 1. 本地策略评估
    const decision = await this.evaluateLocalPolicy(request);
    
    if (decision === 'allow') {
      // 策略内，直接执行
      return await this.execute(request);
    }
    
    // 2. 策略外，转发谛听审批
    const taskId = await this.sendToDiting(request);
    
    // 3. 挂起任务，轮询等待审批结果
    return await this.pollForApproval(taskId);
  }
  
  // 轮询审批状态
  private async pollForApproval(taskId: string): Promise<Response> {
    while (true) {
      const status = await this.checkDitingStatus(taskId);
      
      if (status === 'approved') {
        // 执行请求
        const task = this.pendingTasks.get(taskId);
        return await this.execute(task.request);
      }
      
      if (status === 'rejected' || status === 'timeout') {
        return this.createRejectionResponse(status);
      }
      
      await sleep(2000); // 2秒轮询间隔
    }
  }
}
```

---

## 五、与现有实现的对应关系

| 设计概念 | 现有/计划实现 |
|----------|---------------|
| 悟空拦截器 | wukong（待开发） |
| PEP 角色 | `diting/internal/proxy/pipeline.go` |
| L0/L1/L2 策略 | `diting/internal/policy/` (Cedar) |
| CHEQ 确认 | `diting/internal/cheq/` |
| 审批规则匹配 | `diting/internal/ownership/rule_matcher.go` |
| 审计日志 | `diting/internal/audit/` |
| DID 注册/查询 | `tianshu/src/diting_client/chain_did.py` |
| JIT 动态策略 | 计划实现 |
| Matrix 审批 | `tianshu/src/bridge/feishu.py` |

---

## 六、待确认问题

1. **策略下发方式**：HTTP 推送还是 WebSocket 长连接？
2. **策略存储**：悟空本地存储策略，还是每次请求从谛听获取？
3. **JIT 策略粒度**：行级/列级过滤如何实现？
4. **超时策略**：审批超时时间如何配置？

---

## 七、相关文档

- [动态策略生命周期管理-提案.md](./动态策略生命周期管理-提案.md)
- [Matrix端到端流程设计-提案.md](./Matrix端到端流程设计-提案.md)
- [CHEQ-IETF草案.md](../open/technical/CHEQ-IETF草案.md)
- [紫微智能体治理基础设施-技术方案.md](../open/technical/紫微智能体治理基础设施-技术方案.md)
