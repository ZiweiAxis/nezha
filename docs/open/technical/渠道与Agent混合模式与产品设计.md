# 渠道与 Agent 混合模式及产品设计

**版本**：v1.0  
**日期**：2026-02-16  
**目的**：约定「一个 Agent 既可复用渠道共享机器人，也可配置独立机器人」的混合模式，并给出渠道与 Agent 管理在产品上的设计思路，以兼顾简单与复杂场景。

---

## 1. 混合模式定义

### 1.1 两种绑定方式

| 方式 | 含义 | 典型场景 |
|------|------|----------|
| **共享机器人** | Agent 使用**平台在该渠道上的统一机器人**发收消息；身份通过 payload/卡片内展示（如「来自：小谛」）。 | 多数 Agent、小谛、审批通知等；一个飞书应用/一个钉钉机器人服务所有。 |
| **独立机器人** | Agent 在该渠道拥有**专属应用/机器人**（如单独飞书应用、单独钉钉机器人、单独 Matrix 账号）；发件人即该 Agent。 | 重点 Agent、对外品牌 Agent、需独立权限/配额或强身份区分的场景。 |

### 1.2 混合模式

- **同一渠道**上，平台可同时存在：  
  - 一个**共享机器人**（多个 Agent 复用）；  
  - 若干**独立机器人**（与具体 Agent 一一或分组绑定）。  
- **同一 Agent** 在不同渠道可选用不同策略：例如飞书用共享、钉钉用独立。  
- 这样既满足「简单部署、一个 bot 全覆盖」，又满足「部分 Agent 要独立身份、独立配置」的复杂需求。

---

## 2. 为何更合理、能覆盖更多复杂场景

- **简单场景**：不配置独立机器人即可，所有 Agent 走共享 bot + payload 身份，实施成本低。  
- **复杂场景**：  
  - 需要**强身份区分**（如对外客服 Agent 必须用独立企业号/应用）；  
  - 需要**独立权限、配额、审计**（按应用/机器人维度）；  
  - 需要**@ 即路由**（独立 bot 时，用户 @ 该 bot 即等于 @ 该 Agent）；  
  - 需要**不同 Agent 不同审批流/触达策略**（独立应用可配不同飞书群、不同审批人）。  
- **混合**避免「要么全共享要么全独立」的二选一，按 Agent、按渠道灵活选型。

---

## 3. 抽象与配置维度

### 3.1 渠道侧（Channel）

- **渠道类型**：飞书、钉钉、企微、Matrix 等。  
- **渠道实例**：同一类型下可配置多条「连接」，每条连接对应一个**机器人实例**（一个飞书应用、一个钉钉机器人、一个 Matrix 账号等）。  
  - 其中可标记一个为**平台默认/共享实例**（如「飞书-默认应用」）；  
  - 其余为**独立实例**，用于绑定到具体 Agent 或 Agent 组。

### 3.2 Agent 侧（Agent）

- 每个 Agent 有**全局唯一身份**（如 agent_id、展示名）。  
- 每个 Agent 在**每个渠道**上可配置：  
  - **使用共享机器人**：不填独立凭证，发收都走该渠道的「默认/共享实例」；身份靠 payload 的 sender_id / sender_display_name。  
  - **使用独立机器人**：绑定该渠道下的一个**独立实例**（如指定飞书 app_id、钉钉 app_key、Matrix user_id）；发收都走该实例，发件人即该 Agent。

### 3.3 平台侧

- **渠道管理**：维护「渠道类型 + 实例列表」；每个实例包含：名称、凭证（或凭证引用）、是否默认/共享、可选审批/触达策略模板。  
- **Agent 管理**：维护 Agent 列表及**每渠道的绑定方式**（共享 vs 独立 + 若独立则指向哪条实例）。  
- **投递与路由**：  
  - 发消息时：根据目标 Agent + 渠道，解析出用共享实例还是独立实例，选对应 bot 发送，并在 payload 中带 sender 身份（共享时必带，独立时可选）。  
  - 收消息时：根据消息来源的实例（app_id / bot_id / matrix user_id）反查是共享还是某独立 Agent，再结合 reply_to / 文案约定做路由。

---

## 4. 产品设计要点（渠道与 Agent 管理）

### 4.1 管理对象

- **渠道管理**  
  - 列表：渠道类型（飞书/钉钉/企微/Matrix）+ 该类型下的**实例列表**。  
  - 单实例：名称、凭证（或密钥引用）、是否作为**该渠道的默认（共享）实例**、可选：默认审批人、默认群/会话等。  
  - 操作：新增/编辑/禁用实例；设置「默认实例」（每个渠道类型至多一个用于共享）。

- **Agent 管理**  
  - 列表：Agent 身份、展示名、所属/负责人等。  
  - 单 Agent：基础信息 + **渠道绑定**。  
  - **渠道绑定**（核心）：按渠道维度配置。  
    - 飞书：使用「默认应用」 / 使用「独立应用 XXX」；若独立，选择已配置的某条飞书实例或录入新应用。  
    - 钉钉/企微/Matrix：同上，选择共享或指定独立实例。  
  - 可做成表格：行 = Agent，列 = 渠道，单元格 = 共享 | 独立(实例名)。

### 4.2 典型界面与流程

- **渠道管理页**  
  - 按渠道类型 Tab 或分组；每类下列出实例卡片（名称、是否默认、状态）。  
  - 支持「添加飞书应用」「添加钉钉机器人」等，填写 app_id/secret 或扫码授权，并可选勾选「作为默认（共享）实例」。

- **Agent 详情 / 配置页**  
  - 「渠道与触达」区块：表格或卡片，每渠道一行。  
  - 每行：渠道名 + 单选项「使用平台默认机器人」/「使用独立机器人」；若选独立，下拉选择该渠道下已配置的某实例（或「新建并绑定」跳转到渠道管理）。  
  - 保存后，该 Agent 在该渠道的发收即按此配置执行。

- **全局约束与提示**  
  - 至少保留一个渠道的「默认实例」，否则共享模式不可用。  
  - 独立实例若被某 Agent 占用，删除/停用实例前需先解除绑定或迁移到共享。

### 4.3 与「小谛」等系统身份

- **小谛**可视为平台内建的一个**系统 Agent**：  
  - 默认在飞书/钉钉/企微上使用**共享机器人**，身份为 payload 中的「小谛」；  
  - 若需强区分，也可为小谛配置**独立机器人**（如独立飞书应用），在渠道管理中新增实例并绑定到「小谛」身份即可。  
- 产品上小谛与普通 Agent 共用同一套「渠道绑定」模型，仅数据上标记为系统身份、部分操作可做权限限制。

---

## 5. 对现有方案的影响

- **多身份单机器人**（当前主方案）对应「全部使用共享」的子集；混合模式是其在配置维度上的**超集**。  
- **发件落库 + 回复反查**、**@ 与文案约定**仍然适用：  
  - 共享时：message_id ↔ (sender_id, agent_id) 落库，回复反查目标 Agent。  
  - 独立时：若渠道事件能区分 bot 实例（如不同 app_id），则收消息可直接按实例定位到 Agent，再结合 reply 做二次确认。  
- 产品设计上只需增加「渠道实例」与「Agent–渠道–实例」绑定，无需推翻现有单机器人方案。

---

## 6. 小结

- **混合模式**：同一 Agent 可配置为「使用渠道共享机器人」或「使用该渠道下的独立机器人」，按渠道、按 Agent 灵活选择，兼顾简单与复杂场景。  
- **产品设计**：  
  - **渠道管理**：按类型管理多个「机器人实例」，并标记默认/共享实例；  
  - **Agent 管理**：每个 Agent 在每渠道上配置「共享 vs 独立 + 独立时选哪条实例」；  
  - 小谛等系统身份复用同一模型，可共享也可独立。  
- **实现顺序**：可先落地「仅共享」+ 渠道与 Agent 的配置结构（为独立预留字段与接口），再逐步支持「独立实例」的录入与绑定及投递/路由分支。

**引用**：`多身份单机器人投递方案讨论.md`、`谛听在天枢的身份-小谛.md`。
