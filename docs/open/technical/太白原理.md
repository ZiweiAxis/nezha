# 太白原理

**目的**：介绍太白在紫微平台中的角色、工作原理与协议要点。权威协议定义见根技术方案 §4；平台层职责见《紫微平台层职责梳理》。

---

## 1. 定位与角色

太白是紫微的**智能体接入规范与联络层**，核心只有一件事：**联络 Agent 与天枢**。

- **接收天枢传来的信息**，转发给 Agent（如指令、身份下发、审批结果等）。
- **Agent 按天枢规范输出**，经太白回传天枢（如注册请求、心跳、操作上报、任务响应等）。
- **不执行业务逻辑**，不实现监听机制；执行在 Agent 侧，监听效果由獬豸机制达到。

可以理解为：天枢是「枢纽与身份」，Agent 是「干活的一方」，太白是中间的**协议与桥**——约定「怎么说、怎么收、怎么回」，让任何符合规范的 Agent 都能和天枢正确对接。

---

## 2. 工作原理概览

```
                    ┌─────────────┐
  用户/IM/系统 ──────►│    天枢     │◄──── 身份、路由、审批触达
                    └──────┬──────┘
                           │ 下发指令 / 身份 / 审批结果
                           │ 接收注册 / 心跳 / 响应
                           ▼
                    ┌─────────────┐
                    │    太白     │  协议 + SDK：联络层
                    │  (规范/桥)  │  发现、注册、心跳、收发格式
                    └──────┬──────┘
                           │ 转发给 Agent / 收 Agent 按规范回传
                           ▼
                    ┌─────────────┐
                    │   Agent     │  执行业务、调用工具、跑模型等
                    └─────────────┘
```

- **发现**：Agent 通过太白约定方式发现天枢端点（如 `GET /.well-known/tianshu-matrix` 或 `GET /api/v1/discovery`），拿到 `matrix_homeserver`、可选 `api_base`，才能后续注册、心跳、收指令。
- **注册与心跳**：Agent 经太白协议向天枢发起注册（携带 owner 等）、周期性心跳；天枢落库身份、可选触达獬豸与链，并据此路由后续指令。
- **指令与响应**：天枢把用户/系统的指令下发给 Agent（经 Matrix 或 HTTP，取决于部署）；太白约定**消息格式与身份**，Agent 按该规范解析输入、组织输出，经太白回传天枢，天枢再转给用户或下游。

所有「说什么、以什么格式说、谁对谁」都由**太白协议**统一约定，天枢与 Agent 都按同一套规范交互，太白 SDK 则把协议封装成易用的 API（发现、注册、心跳、上报等）。

---

## 3. 太白协议（基于 Matrix 的治理扩展）

协议在根技术方案 §4 有完整定义；此处为原理级摘要。

### 3.1 事件类型与方向

| 事件类型 | 方向 | 用途 |
|----------|------|------|
| `m.agent.register_request` | Agent → 天枢 | 发起注册，携带 owner、环境指纹等 |
| `m.agent.identity` | 天枢 → Agent | 下发 DID 及凭证 |
| `m.agent.action` | Agent → 獬豸 | 操作上报（供审计/Trace） |
| `m.agent.audit` | 獬豸 → Agent | 存证回执（如链上交易 ID） |
| `m.agent.heartbeat` | Agent → 天枢 | 保活、环境指纹校验 |
| `m.agent.revoke` | 天枢 → Agent | 吊销身份通知 |

负载需按规范签名；接收方通过链上 DID 公钥验签。当前实现中，部分能力先以 **HTTP 接口** 形式提供（如天枢的 `POST /api/v1/agents/register`、`POST /api/v1/agents/heartbeat`，以及发现端点），与上述事件语义对齐，后续可扩展为完整 Matrix 事件。

### 3.2 操作类型（上报 m.agent.action 时）

协议约定操作类型示例，便于审计与策略对齐，例如：

- `file_read` / `file_write`：文件读/写
- `api_call`：对外 API 调用
- `verification_ping`：接入验证用

具体常量与扩展由太白 SDK 与根技术方案 §4 保持一致。

---

## 4. 发现与联络流程（当前实现要点）

1. **发现天枢**  
   Agent 请求 `GET {api_base}/.well-known/tianshu-matrix` 或 `GET {api_base}/api/v1/discovery`，获得：
   - `matrix_homeserver`：Matrix 服务地址
   - 可选 `api_base`：天枢 HTTP API 根地址  

2. **注册**  
   Agent 向天枢 `POST /api/v1/agents/register` 提交 `owner_id`、可选 `agent_display_id`；天枢落库、绑定 Owner、可选通知獬豸与链，返回 `agent_id` 等。

3. **心跳**  
   Agent 周期性向天枢 `POST /api/v1/agents/heartbeat` 提交 `agent_id`、`status`，用于保活与在线状态。

4. **指令与响应**  
   天枢通过 Matrix 或 HTTP 把指令下发给 Agent；Agent 按天枢约定的消息格式解析、执行、组织结果，再按约定格式回传天枢（经太白协议/SDK 封装的通道）。

5. **操作上报**  
   Agent 在执行操作后，可按协议向獬豸上报 `m.agent.action`（或等价 HTTP），用于审计；獬豸可回 `m.agent.audit` 存证回执。

---

## 5. 「按天枢规范输出」的含义

Agent 与天枢之间能正确协作，是因为双方遵守同一套**规范**：

- **身份**：使用天枢分配的 `agent_id`、DID 及约定签名方式，便于天枢与獬豸做身份校验与路由。
- **消息格式**：指令、响应、注册、心跳、操作上报等，都按太白协议约定的事件类型与载荷结构组织，天枢才能正确解析、路由、写入 Trace 或触达审批。
- **时序与语义**：先发现、再注册、再心跳、再收指令；响应与上报的时机、关联关系（如 trace_id、session_id）符合天枢与獬豸的约定。

太白不定义业务语义（例如「如何执行命令」「如何调工具」），只定义**与天枢的通信与身份规范**；Agent 内部实现任意，只要对外按规范输出即可。

---

## 6. SDK 与示例

- **太白 SDK**（如 `taibai/sdk/python/ziwei_taibai`）：封装发现（`discover_tianshu`）、注册（`register_agent`）、心跳（`heartbeat`）、操作上报（`report_action`）及 `Agent` 类，当前以 HTTP 调用天枢/獬豸为主，与协议 §4 对齐；Matrix 事件可后续扩展。
- **验证用智能体**（`taibai/examples/verification_agent`）：仅做发现 → 注册 → 心跳 → 可选上报，用于验证「Agent 经太白与天枢、獬豸」的接入链路，不包含业务执行或大模型。

---

## 7. 与平台其他层的关系

- **天枢**：通信枢纽与身份；暴露发现、注册、心跳及指令下发与汇聚；与太白协议对齐的接口由天枢实现。
- **獬豸**：一套机制，达到监听效果；不执行。Agent 上报的 `m.agent.action` 或等价 HTTP 会进入獬豸审计/Trace；执行前鉴权（如 `/auth/exec`）也由獬豸提供机制，太白不实现这些逻辑。
- **太白**：只做联络与规范——协议、SDK、发现与收发约定；不执行、不实现监听。

---

**版本**：v1.0  
**日期**：2026-02-15  
**引用**：根技术方案 §4（太白）；《紫微平台层职责梳理》；taibai 子项目 `docs/协议与SDK说明.md`、`README.md`。
