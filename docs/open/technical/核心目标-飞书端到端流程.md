# 核心目标：飞书端到端流程（当前仅飞书）

**版本**：v1.0  
**日期**：2026-02-15  
**范围**：先飞书；钉钉/企微后续再考虑。

---

## 1. 目标一句话

**一键启动平台 → 启动一个 Agent → 自动注册 → 飞书收到确认 → 审核通过后 Agent 接入 → 谛听下发默认策略 → 用户通过飞书给 Agent 下指令 → Agent 执行任务 → 谛听拦截危险操作 → 飞书推送审批 → 用户批准/拒绝。**

---

## 2. 端到端流程（飞书）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 1. 一键启动                                                                   │
│    deploy/ 或文档：启动 Synapse + 天枢 + 谛听（+ 飞书配置）；可选启动一个 Demo Agent │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 2. Agent 启动并自动注册                                                        │
│    Agent（如太白 verification_agent 或自研）向天枢发起注册（HTTP 或 Matrix）     │
│    天枢落库身份、可选通知谛听「初始化权限」、调用谛听链上 DID 注册                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 3. 飞书发确认 / 审核通过                                                        │
│    天枢向飞书推送「Agent 注册确认」卡片（或审批流）→ 用户点击「通过」               │
│    回调天枢（或谛听）→ Agent 视为已接入（身份生效、可收消息）                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 4. 谛听下发默认策略（可选实现）                                                  │
│    天枢调用谛听「初始化权限」接口（agent_id、owner_id）→ 谛听侧记录或下发默认策略   │
│    当前：谛听暴露 POST /init_permission 占位（200 OK）；默认策略=全局策略规则文件   │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 5. 用户通过飞书给 Agent 下指令                                                  │
│    用户在飞书发消息 → 天枢飞书桥接 → 转 Matrix/HTTP 到对应 Agent                 │
│    Agent 收到指令（如「执行任务 X」）                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                        ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│ 6. Agent 执行任务 → 谛听拦截危险 → 飞书推送审批                                  │
│    Agent 执行时经谛听代理或调用 POST /auth/exec → 谛听策略评估                   │
│    若为 review（需审批）：创建 CHEQ → 飞书卡片推送给审批人「批准/拒绝」            │
│    用户点击批准 → 谛听 Submit 通过 → Agent 继续执行；拒绝则拒绝                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 与现有实现的对应

| 环节 | 实现位置 | 说明 |
|------|----------|------|
| 一键启动 | 根 `deploy/`（见下） | Synapse + 天枢 + 谛听编排；飞书环境变量与 README |
| Agent 自动注册 | 天枢 `register_agent_by_human`、HTTP API；太白 `Agent.register()` | 天枢落库、通知谛听 init_permission、DID 上链（DITING_CHAIN_URL） |
| 飞书确认/审核 | 天枢飞书卡片「注册确认」、审批回调 | 天枢 channel_adapter、飞书卡片；回调 URL 配置 |
| 谛听默认策略 | 谛听 POST /init_permission（已实现占位） | 天枢 DITING_INIT_PERMISSION_URL=http://diting:8080/init_permission；谛听返回 200 OK，默认策略=全局 policy 规则文件 |
| 飞书下指令 | 天枢飞书 ↔ Matrix 桥接、Agent 收 Matrix 消息 | 用户发飞书 → 桥接到 Agent 所在 Room → Agent 消费 |
| 执行+拦截+审批 | 谛听 /auth/exec、CHEQ、飞书卡片 | 3af 或 Agent 调 /auth/exec → review 时 CHEQ → 飞书卡片批准/拒绝 |

---

## 4. 不在此范围（后续）

- 钉钉、企业微信（仅飞书先行）。
- 复杂「默认策略」下发（当前以全局策略文件 + init_permission 占位为主）。

---

**引用**：`紫微智能体治理基础设施-技术方案.md`、`紫微平台各模块集成方案.md`、`E-P7-DID联调验证.md`。
