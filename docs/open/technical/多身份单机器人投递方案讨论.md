# 多身份、单机器人投递：方案讨论

**版本**：v1.0  
**日期**：2026-02-16  
**目的**：在「多个 Agent/服务身份（小谛、各注册 Agent）对应到同一渠道的一个机器人」的前提下，讨论如何做方案选择。

---

## 1. 约束与目标

### 1.1 约束

- **飞书 / 钉钉 / 企微**：通常一个租户下**一个应用/机器人**对接天枢；不会为每个 Agent 各建一个飞书应用。
- **Matrix**：可以注册多个用户（@gateway、@xiaodi、@agent-xxx），但若每个注册 Agent 都占一个 Matrix 账号，账号数量会膨胀，运维与 Synapse 策略也复杂。
- **统一诉求**：所有渠道上，**同一条通道（同一个 bot）** 要能代表**不同身份**发消息。

### 1.2 目标

- 每个**逻辑身份**在天枢有唯一标识（小谛、各 Agent 的 agent_id 等）。
- **投递时**：用户能明确看到「这条消息是**谁**发的」（小谛 / Agent A / 天枢系统）。
- 方案可扩展：新 Agent 加入只增加身份与投递元数据，不要求每渠道新增一个 bot。

---

## 2. 方案对比

### 方案 A：单机器人 + 身份只在消息体内（payload/卡片）

- **做法**：每个渠道只用一个机器人（飞书一个应用、钉钉一个机器人、Matrix 一个 gateway）。所有消息都由该机器人发出；**发件人身份**通过 payload 传递：如 `sender_id`、`sender_display_name`（或 `agent_id` + 展示名）。
- **展示**：在**消息内容/卡片**里体现「来自：小谛」「来自：xxx Agent」（标题、署名行、头像区等），渠道会话列表里仍显示为同一个 bot。
- **优点**：与飞书/钉钉「一应用一 bot」天然契合；Agent 数量增加不增加渠道侧实体；实现简单、可复用同一套投递与鉴权。
- **缺点**：渠道原生「发件人」仍是 bot 名称，身份区分依赖内容与卡片设计。

### 方案 B：单机器人 + 渠道「发件人别名」能力（若支持）

- **做法**：仍是一个 bot，但若渠道支持「发送时指定显示名称/头像」（如部分 IM 的 bot 可带 custom sender），则按身份填不同 display_name 或 avatar。
- **优点**：在支持的渠道上，会话列表或气泡旁就能看到不同名字。
- **缺点**：飞书/钉钉对「同一应用多身份」支持不一，可能只能做到「应用名 + 消息内署名」，需按渠道能力逐家确认。

### 方案 C：Matrix 多账号、飞书/钉钉单 bot（混合）

- **做法**：Matrix 上为**少数固定角色**单独建账号（如 @gateway 天枢、@xiaodi 小谛），其余 Agent 仍用 gateway 或共用账号 + payload 身份；飞书/钉钉保持单应用，身份一律在消息/卡片内。
- **优点**：Matrix 上小谛、天枢等可区分发件人；其它渠道保持简单。
- **缺点**：Matrix 与飞书/钉钉的「身份表达方式」不一致；若 Matrix 上以后也想为每个 Agent 建账号，仍会碰到账号膨胀问题。

### 方案 D：每 Agent 每渠道独立 bot/应用

- **做法**：每个逻辑身份在飞书/钉钉各建一个应用，Matrix 每个 Agent 一个账号。
- **优点**：渠道原生发件人即身份。
- **缺点**：飞书/钉钉侧应用数量不可接受；Matrix 账号与运维成本高；不可扩展。**不推荐**。

---

## 3. 推荐方向：以 A 为主，B/C 按渠道能力选用

### 3.1 统一抽象

- **发件人身份**在天枢侧统一为：`sender_type`（如 `service` | `agent`）+ `sender_id`（如 `tianshu-service-diting`、`agent_id`）+ `sender_display_name`（如「小谛」「我的助手」）。
- 所有投递（审批、通知、对话回复等）都带这三类信息；**渠道适配层**根据渠道能力决定如何展示。

### 3.2 按渠道落地方案

| 渠道     | 建议做法 |
|----------|----------|
| **飞书** | 单应用。身份只在消息/卡片内：标题或署名写「小谛」「来自 xxx Agent」；卡片模板支持 `sender_display_name`、可选头像占位。 |
| **钉钉** | 单机器人。同上，身份在消息体/卡片内。 |
| **Matrix** | **选项 1**：单 gateway，身份在消息 payload（与飞书/钉钉一致）。**选项 2**：为极少数固定角色（如 小谛）单独账号，其余仍用 gateway + payload；需约定「哪些身份用独立账号、哪些用 payload」。 |

### 3.3 与「小谛」身份的一致性

- 小谛与其它 Agent 一样，是**一种逻辑身份**，拥有 `sender_id`（如 `tianshu-service-diting`）和 `sender_display_name`（「小谛」）。
- 投递时无论用哪个渠道，都带这套字段；**不依赖**「小谛必须单独一个 Matrix 账号或单独一个飞书应用」。
- 若后续某渠道支持「同一 bot 多显示名」且希望用，可在该渠道适配层里把 `sender_display_name` 映射到渠道的展示名，而不改变天枢侧「多身份单机器人」的统一模型。

---

## 4. 群聊中的 @ 与回复：如何正确投递到小谛或具体 Agent

### 4.1 问题

- **@小谛 / @具体 Agent**：在群聊里用户 @小谛 或 @某个 Agent 时，消息需要**正确路由**到对应身份（小谛或该 Agent），而不是「只要是 @ 机器人」就乱投。
- **对话过程中的回复**：用户在和「某个 Agent」对话（例如在回复该 Agent 上一条消息）时，飞书/钉钉等渠道能否让平台知道「这条消息是**回复给哪个 Agent**」？

### 4.2 渠道能力是否支持（需以官方文档与联调为准）

下表为**方案所需能力**及当前对各渠道的结论；**是否完全支持需在接入前查官方文档并做联调确认**。

| 能力 | 飞书 | 钉钉 | 企微 | Matrix | 说明 |
|------|------|------|------|--------|------|
| **发消息后返回 message_id** | ✅ 支持 | 待确认 | 待确认 | ✅ 支持 | 天枢/谛听代码中飞书已用 `data.data.message_id`；Matrix 为 `event_id`。钉钉/企微需查「发消息」接口响应。 |
| **收消息事件里带「被回复消息 ID」** | 待确认 | 待确认 | 待确认 | ✅ 支持 | Matrix 回复关系为 `m.relates_to.in_reply_to.event_id`。飞书事件需查是否含 `root_id`/`parent_id` 等；钉钉/企微需查「接收消息」事件结构。 |
| **单应用下单 bot、@ 只能 @ 到该 bot** | ✅ 是 | ✅ 是 | ✅ 是 | 可多账号 | 群内无法从 @ 目标区分「小谛」与「Agent A」，需文案或回复关系补足。 |

- **飞书**：发件返回 `message_id` 已在使用；接收消息事件结构需查 [飞书 - 接收消息事件](https://open.feishu.cn/document/server-docs/im-v1/message-event/message-receive-event) 是否包含被回复消息的 `root_id` / `parent_id` 或等价字段。
- **钉钉**：发消息、接收消息的 API 与事件结构需查 [钉钉 - 机器人接收消息](https://open.dingtalk.com/document/orgapp/receive-message) 等，确认是否返回 message_id 及回复关系。
- **企微**：同上，需查企业微信「发送消息」「接收消息」文档，确认 message_id 与回复关系字段。
- **Matrix**：`event_id` 即消息标识；回复关系为 `m.relates_to.in_reply_to.event_id`，**明确支持**发件落库 + 回复反查。

**结论**：**该设定（发件落库 + 回复反查以识别「回复给哪个 Agent」）在 Matrix 上明确支持；飞书/钉钉/企微需按上表逐项查官方文档并在联调中验证，再固化到实现与契约。**

**建议**：在实现「多身份 + 回复路由」前，对飞书/钉钉/企微各做一次接口与事件核对：① 发消息响应是否含 message_id（或等价）；② 用户「回复某条消息」时，事件 payload 是否含被回复消息的 ID（如 parent_id、root_id、reply_to_message_id 等）。核对结果可更新上表并注明文档版本或测试日期。

### 4.3 方案：发件落库 + 回复反查 + @ 的文本/约定

- **发消息时**：每次以某身份（小谛或某 Agent）发出一条消息后，将 **渠道返回的 message_id** 与 **sender_id**（或 agent_id）落库关联，例如：`(channel, channel_message_id) -> sender_id`。
- **用户「回复」某条消息时**：渠道回调/事件里会带「被回复消息的 message_id」。我们用该 ID 反查，得到这条被回复消息对应的 **sender_id**，即知「用户是在回复小谛 / 回复某个 Agent」，再按该身份做投递路由。  
  **结论：在「与具体 Agent 对话」的场景下，钉钉/飞书等渠道是可以通过「回复关系」知道「消息是回复给哪个 Agent」的**，前提是我们发消息时做了 message_id ↔ sender_id 的落库。
- **用户主动 @ 机器人（未回复某条）时**：无法从渠道事件区分「@ 小谛」还是「@ Agent A」，只能靠以下一种或多种：
  - **文案/使用约定**：引导用户在群内发「小谛 审批通过」「Agent名 请处理 xxx」，首词或首行作为目标身份解析；或约定「要指定对象请在开头 @机器人 并写 小谛/Agent名」。
  - **身份列表/快捷入口**：在机器人发送的卡片或菜单里提供「选择身份」的入口（如按钮「找小谛」「找某 Agent」），用户点击后进入该身份的会话或带上隐式上下文，后续消息按该上下文路由。
  - **Matrix 若用多账号（方案 C）**：在 Matrix 里 @xiaodi 与 @agent-a 是不同用户，@ 即能区分；飞书/钉钉仍用「回复反查 + 文案约定」补足。

### 4.4 与「多身份单机器人」的一致性

- 投递时带 `sender_id` / `sender_display_name`，既用于**展示**「谁发的」，也用于**落库**「这条渠道消息对应哪个身份」。
- 回消息路由时：优先用 **reply_to_message_id → sender_id** 判定目标身份；若无回复关系，再用 **文本约定或入口上下文** 判定；若仍无法判定，可退回「默认身份」或提示用户指明对象。

---

## 5. 小结与待决

- **结论**：在多身份、单机器人的约束下，**以「单机器人 + 身份在 payload/卡片内」为主方案（A）**，必要时在部分渠道用 B/C 做增强。**群聊 @ 与回复**：通过「发件落库 (message_id ↔ sender_id) + 回复反查」可知「消息是回复给哪个 Agent」；@ 谁则依赖文案约定或入口上下文（或 Matrix 多账号）。
- **待决**：  
  - Matrix 是否对「小谛」单独建账号（方案 C），还是全用 gateway + payload（方案 A）；  
  - 飞书/钉钉卡片模板是否统一增加「发件人展示」占位（署名行/头像），并约定必传 `sender_display_name`；  
  - 各渠道「发件 message_id ↔ sender_id」落库与回复事件的统一契约（字段名、存储粒度、过期策略）；  
  - 群内 @ 机器人时的**默认解析规则**（如首词/首行身份名、是否支持「@机器人 小谛 xxx」等）与产品文案。

**引用**：`谛听在天枢的身份-小谛.md`、`紫微平台各模块集成方案.md`（审批触达）、`紫微智能体治理基础设施-技术方案.md` §2.4。
