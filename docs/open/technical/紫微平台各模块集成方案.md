# 紫微平台各模块集成方案

**版本**：v1.0  
**日期**：2026-02-15  
**密级**：内部技术文档  
**引用**：根技术方案 `ziwei/docs/open/technical/紫微智能体治理基础设施-技术方案.md`；**平台层职责**：`紫微平台层职责梳理.md`；子项目进度 `_bmad-output/planning-artifacts/各子项目应对焦事项与进度同步.md`。**飞书端到端核心目标**：`核心目标-飞书端到端流程.md`；**一键启动**：`ziwei/deploy/README.md`。

---

## 1. 集成目标与范围

### 1.1 目标

- **端到端可验证**：从「智能体接入」到「身份上链、策略决策、审批触达、审计存证」全链路在单一环境可跑通、可回归。
- **契约清晰**：模块间接口（URL、请求/响应、环境变量）在根文档统一约定，子项目实现与测试对齐。
- **分阶段落地**：先固化已打通链路（天枢↔谛听 DID/初始化/审计、太白验证智能体），再扩展一键编排与契约测试。

### 1.2 集成范围（当前四模块）

| 模块 | 仓库/路径 | 职责 | 集成角色 |
|------|-----------|------|----------|
| **天枢** | ziwei/tianshu | 通信枢纽、身份、DID 注册/查询调用、企业 IM 审批触达 | 调用谛听（DID、初始化权限、审计）；被太白/悟空/智能体调用（发现、注册、心跳） |
| **谛听** | ziwei/diting | **一套机制，达到监听的效果**：策略、鉴权（/auth/exec）、代理、CHEQ、Trace、链上存证等；不执行业务逻辑，执行在 Agent 侧 | 暴露 /chain/*、/auth/*、/cheq/*；Agent/3af 经谛听机制达到监听效果；天枢调谛听 DID/初始化等 |
| **太白** | ziwei/taibai | **联络 Agent 与天枢**：协议与 SDK，接收天枢信息、转发 Agent，Agent 按天枢规范输出回传天枢；验证用示例。不执行、不实现监听逻辑 | 智能体经太白与天枢联络（发现/注册/心跳、指令收发）；执行在 Agent，经谛听机制达到监听效果 |
| **悟空** | ziwei/wukong | **Agent 生命周期管理**：CLI 启动/停止/重启 Claude 等 Agent，身份注册与天枢同步、心跳与状态上报 | 宿主机侧 CLI；调用天枢 `POST /api/v1/agents/register`、`POST /api/v1/agents/heartbeat`；不放入 docker-compose，与一键启动后的天枢联通验证 |

**说明**：Matrix（Synapse）为天枢的通信依赖，当前由 tianshu 的 compose 编排；链为谛听内子模块，不单独列为一个「模块」。悟空以**宿主机 CLI** 方式运行，通过 `TIANSHU_API_URL`（本地一键部署时为 `http://localhost:8082`）与已启动的天枢对接。

---

## 2. 端到端数据流与集成点

### 2.1 核心数据流（与根技术方案一致）

```
智能体/太白 SDK → 天枢（注册、心跳、路由）
       ↓
天枢 → 谛听（DID 注册/查询、初始化权限、审计上报）
       ↓
谛听 ↔ 链（DID 文档、存证 Merkle 根）
谛听 → 天枢（发起审批请求）；天枢 → 企业 IM（审批卡片投递）；IM 回调 → 天枢 → 谛听（审批结果）
智能体/3af → 谛听（/auth/exec、/auth/sandbox-profile、代理流量）
```

### 2.2 已约定接口契约（根 + E-P7）

| 集成点 | 方向 | 接口/约定 | 环境变量/配置 | 文档 |
|--------|------|------------|----------------|------|
| 天枢 → 谛听 DID | 天枢 → 谛听 | `POST /chain/did/register`、`GET /chain/did/{did}` | 天枢：`DITING_CHAIN_URL`（如 `http://diting:8080/chain`） | E-P7、技术方案 §2.2.1、§7 |
| 天枢 → 谛听 初始化权限 | 天枢 → 谛听 | `POST {DITING_INIT_PERMISSION_URL}`，体：agent_id、owner_id | 天枢：`DITING_INIT_PERMISSION_URL` | design-alignment、技术方案 |
| 天枢 → 谛听 审计 | 天枢 → 谛听 | `POST {DITING_AUDIT_URL}`（消息审计） | 天枢：`DITING_AUDIT_URL` | design-alignment |
| 审批触达（架构） | 谛听 → 天枢 → IM | 谛听发起审批请求，天枢负责向飞书/钉钉等投递卡片（用户信息在天枢）；IM 回调天枢后，天枢回传谛听 | 天枢：飞书等凭证；谛听与天枢约定「审批请求/结果」接口 | 技术方案 §2.4、§3.3 |
| 审批回调 | IM → 天枢 | 飞书卡片点「通过/拒绝」后回调天枢 API，天枢再通知谛听 | 天枢暴露回调 URL | 技术方案 §2.4 |
| 谛听 代理鉴权 | 3af/智能体 → 谛听 | `POST /auth/exec`、`GET /auth/sandbox-profile`；可选 `GET /auth/stream` | 谛听 `proxy.listen_addr`（默认 :8080） | 谛听 ISSUE_LIST、Story 7/8 |
| 谛听 CHEQ 审批（结果） | 天枢/回调 → 谛听 | 天枢收到 IM 回调后通知谛听，或谛听提供 `GET/POST /cheq/approve` 供天枢/网关调用 | 卡片内链接可经天枢转发或由天枢代调谛听 approve | 谛听 I-008；目标为经天枢统一入口 |
| 太白验证智能体 | 太白 → 天枢、谛听 | 发现（`/.well-known/tianshu-matrix` 或 `/api/v1/discovery`）、注册、心跳、审计上报 | 太白：`TIANSHU_API_BASE`、`DITING_AUDIT_URL` | taibai/README、接入验证指南 |
| 悟空 ↔ 天枢 | 悟空 → 天枢 | `POST /api/v1/agents/register`（body: owner_id, agent_display_id?）、`POST /api/v1/agents/heartbeat`（body: agent_id, status?） | 悟空：`TIANSHU_API_URL`（宿主机见 `http://localhost:8082`）、`WUKONG_OWNER_ID`（可选，默认 wukong-default-owner） | wukong README、本节 §4.1 |

### 2.3 当前已打通情况（根侧记录）

- **天枢 ↔ 谛听 DID（E-P7）**：已联调通过。谛听 `chain.enabled: true` 时暴露 `/chain/*`；天枢设 `DITING_CHAIN_URL` 后注册时调用 DID 注册、可查 DID。
- **天枢 → 谛听 初始化权限**：接口与配置已存在（`DITING_INIT_PERMISSION_URL`），是否在谛听侧实现对应 handler 以子项目为准。
- **太白 verification_agent**：发现 → 注册/心跳 → 上报一条 action 至谛听，用于集成验证；依赖天枢发现接口与谛听审计 URL。

---

## 3. 集成方式建议

### 3.1 环境与配置矩阵

| 角色 | 关键环境变量 | 说明 |
|------|--------------|------|
| **谛听** | `proxy.listen_addr`、`chain.enabled`；审批触达经天枢，不直连飞书（用户信息在天枢） | 见 diting `config.example.yaml`；当前实现若含独立飞书投递则为历史/兼容，目标为谛听→天枢→飞书 |
| **天枢** | `MATRIX_HOMESERVER`、`MATRIX_GATEWAY_*`、`DITING_CHAIN_URL`、`DITING_INIT_PERMISSION_URL`、`DITING_AUDIT_URL`、`DITING_APPROVE_CALLBACK_URL` | 见 tianshu `.env.example`、design-alignment |
| **太白验证智能体** | `TIANSHU_API_BASE`、`DITING_AUDIT_URL`、可选 `VERIFICATION_AGENT_ID`、`VERIFICATION_OWNER_ID` | 见 taibai `examples/verification_agent` |

**同机联调示例**（开发机同时跑天枢、谛听）：

- 谛听：`proxy.listen_addr: :8080`，`chain.enabled: true`。
- 天枢：`DITING_CHAIN_URL=http://127.0.0.1:8080/chain`，`DITING_INIT_PERMISSION_URL=http://127.0.0.1:8080/...`（若谛听暴露），`DITING_AUDIT_URL=http://127.0.0.1:8080/...`（与谛听实际路由一致）。
- 端口错开：若天枢也占 8080，可将谛听改为 8081 或天枢改为其他端口。

### 3.2 一键启动与编排

**现状**：

- **tianshu**：`compose.yaml` 仅含 tianshu + Synapse，不含谛听。
- **diting**：`deployments/docker/docker-compose*.yml` 为谛听自身多形态（Sentinel），非「天枢+谛听+太白」平台编排。

**建议（分步）**：

1. **短期**：在**根仓**维护一份「集成用」编排与说明，不强制改子仓：
   - 新建 `ziwei/deploy/` 或 `ziwei/docs/open/technical/集成部署/`，放置：
     - `docker-compose.integration.yml`（或等价名）：编排 Synapse + 天枢 + 谛听（+ 可选太白验证智能体一次性任务）；
     - `env.example`：汇总三端环境变量与端口说明；
     - `README.md`：启动顺序、健康检查、最小验证步骤（见 §4）。
   - 子项目保持各自 compose 与 Makefile 不变，仅被根侧 compose 通过 build context 或 image 引用。

2. **中期**：若需 CI 内全平台回归，可在根仓或单独 CI 仓库中：
   - 先启动谛听（含链）→ 再启动天枢（+ Synapse）→ 再跑太白 verification_agent 与 E-P7 测试；
   - 或使用根侧 `docker-compose.integration.yml` 一键 up，再执行验证脚本。

### 3.3 契约测试与回归清单

- **契约测试**：对「天枢→谛听」的 DID、初始化权限、审计等接口，建议在根或子项目内保留**契约级**用例（请求/响应形态、状态码），不依赖真实链或 IM。例如：
  - 谛听侧：mock 天枢的 register 触发，验证 `/chain/did/register` 与 `GET /chain/did/{did}` 行为；
  - 天枢侧：已有 `tests/test_e2e_chain_did.py`（依赖真实谛听+链），可保留为集成测试，与「仅契约」的单元级测试区分。
- **回归清单**（建议每次发版或大合并前执行）：
  1. 谛听单测：`cd diting && make test`
  2. 谛听 E2E（可选）：`diting/cmd/diting/scripts/verify_exec.sh`
  3. 天枢 E-P7：启动谛听（chain 开启）+ 天枢，`DITING_CHAIN_URL=... pytest tianshu/tests/test_e2e_chain_did.py -v`
  4. 太白验证智能体：启动天枢+谛听后，`cd taibai/examples/verification_agent && python main.py`，退出码 0
  5. （可选）根侧一键 compose 启动后，跑上述 3+4 作为全平台集成回归

---

## 4. 最小验证步骤（当前可执行）

在不做根侧 compose 的前提下，可按以下顺序手动验证「天枢 + 谛听 + 太白」集成：

1. **启动谛听（含链）**  
   `cd ziwei/diting/cmd/diting && go run ./cmd/diting_allinone -config config.chain-run.yaml`（或等价配置 `chain.enabled: true`）。  
   检查：`curl -s http://127.0.0.1:8080/chain/health` 返回 200。

2. **启动天枢（+ Synapse）**  
   使用 tianshu 的 `compose.yaml` 或本地已配置 Synapse。  
   设置：`DITING_CHAIN_URL=http://127.0.0.1:8080/chain`（若同机）、以及 `DITING_INIT_PERMISSION_URL`、`DITING_AUDIT_URL` 指向谛听（端口与谛听一致）。

3. **跑 E-P7 天枢→谛听 DID**  
   `cd ziwei/tianshu && DITING_CHAIN_URL=http://127.0.0.1:8080/chain python3 -m pytest tests/test_e2e_chain_did.py -v`。  
   预期：在谛听已启动且开链时测试通过（非 skip）。

4. **跑太白验证智能体**  
   配置 `TIANSHU_API_BASE`、`DITING_AUDIT_URL` 指向上述天枢与谛听，执行：  
   `cd ziwei/taibai/examples/verification_agent && python main.py`。  
   预期：发现 → 注册/心跳 → 上报成功，退出码 0。

5. **（可选）谛听代理鉴权**  
   使用 `cmd/diting/scripts/verify_exec.sh` 或 `3af_exec` 调用 `POST /auth/exec`、`GET /auth/sandbox-profile`，验证策略与 CHEQ 流程。

### 4.1 悟空联通验证（本地一键部署后）

悟空不放入 docker-compose，以**宿主机 CLI** 方式与已启动的天枢对接。在一键启动（`docker compose -f deploy/docker-compose.integration.yml up -d`）成功后，按以下步骤验证悟空与天枢联通：

1. **确认天枢可达**  
   `curl -s http://localhost:8082/health` 返回 200；`curl -s http://localhost:8082/api/v1/discovery` 返回含 `matrix_homeserver` 的 JSON。

2. **宿主机安装悟空**  
   `cd ziwei/wukong && npm ci && npm run build`；可用 `npm link` 或 `npx wukong` 使用 CLI。

3. **配置天枢地址与 Owner**  
   `export TIANSHU_API_URL=http://localhost:8082`（与 compose 暴露的天枢端口一致）；可选 `export WUKONG_OWNER_ID=your-owner-id`（不设则使用默认 owner，天枢会自动登记）。

4. **注册身份并验证**  
   `wukong identity --register my-agent --type claude`。预期：返回成功，本地 `~/.wukong/identities.json` 中写入 agent_id（与天枢分配一致）。可选：`wukong list`、`wukong status my-agent`。

5. **（可选）心跳与状态**  
   若已实现心跳：启动 Agent 后（如 `wukong claude --name my-agent --mode local`），悟空向天枢上报心跳；可查天枢侧日志或后续管理端确认收到。

**对接条件小结**：天枢暴露 `POST /api/v1/agents/register`、`POST /api/v1/agents/heartbeat`（与太白约定一致）；悟空 TianshuClient 使用上述 URL，默认 `TIANSHU_API_URL=http://localhost:8082`，即可在本地一键部署场景下完成联通验证。详见 `deploy/README.md` 悟空小节。

---

## 5. 分阶段路线

| 阶段 | 内容 | 产出 |
|------|------|------|
| **当前** | 固化文档、回归清单、最小验证步骤 | 本文档；根侧可选 `deploy/` 或 `docs/.../集成部署/` 仅 README + env 示例 |
| **短期** | 根侧集成用 docker-compose（Synapse+天枢+谛听），悟空宿主机联通验证可执行 | `docker-compose.integration.yml`、悟空联通验证步骤（§4.1、deploy/README） |
| **中期** | 契约测试（DID/初始化/审计）在子项目或根侧落地；审批回调与飞书 E2E 可选项 | 契约用例、可选飞书 E2E 说明 |

---

## 6. 与其它文档的关系

- **根技术方案**：定义天枢、谛听、太白的职责与协议；本文不重复协议细节，只汇总**集成点与操作步骤**。
- **E-P7-DID联调验证**：天枢↔谛听 DID 的联调步骤与验收标准；本文 §4 将其纳入「最小验证步骤」。
- **各子项目应对焦事项与进度同步**：子项目完成状态与下一步对焦；集成方案依赖其「当前已打通」记录。
- **子项目 ISSUE_LIST / design-alignment**：接口 URL 与行为以子项目实现为准；本文环境变量与端口与之一致。

---

**文档结束**
