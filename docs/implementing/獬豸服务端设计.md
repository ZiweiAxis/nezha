# 獬豸服务端详细设计

## PEP / PDP / PIP 概念

紫微系统基于 ABAC 模型，采用 PEP/PDP/PIP 架构：

| 角色 | 英文 | 说明 | 紫微组件 |
|------|------|------|----------|
| **PEP** | Policy Enforcement Point | 策略执行点 | 哪吒 (Nezha) |
| **PDP** | Policy Decision Point | 策略决策点 | 獬豸 (Xiezhi) |
| **PIP** | Policy Information Point | 策略信息点 | 天枢 + 业务系统 |

### 三者关系

```
用户请求 → PEP(哪吒) → PDP(獬豸) → PIP(天枢/业务系统)
```

**流程**：
1. PEP 拦截用户请求
2. PEP 向 PDP 发起决策请求
3. PDP 根据策略进行决策，向 PIP 查询属性
4. PDP 返回决策结果
5. PEP 执行决策

---

## 1. 定位与职责

**定位**：獬豸服务端是紫微系统的策略决策中心(PDP)和策略管理中心(PAP)。

**核心职责**：
- 策略管理与下发
- 策略决策
- 审批流程管理
- 审计日志存储
- 消息投递协调

## 2. 架构图

```mermaid
flowchart TB
    API["API Gateway<br/>:8080"]
    Decision["决策引擎"]
    Policy["策略引擎"]
    CHEQ["审批模块<br/>(CHEQ)"]
    Audit["审计存储"]
    Delivery["消息投递"]
    W["哪吒/客户端"]
    T["天枢 PIP"]
    M["Matrix/飞书"]
    DB["数据库"]
    
    W --> API
    API --> Decision
    Decision --> Policy
    Decision --> CHEQ
    Policy --> T
    CHEQ --> Delivery
    Delivery --> M
    Decision --> Audit
    Audit --> DB
```

## 3. 核心功能模块

| 模块 | 功能描述 | 关键接口 |
|------|----------|----------|
| 策略引擎 | 策略的创建、存储、下发 | `createPolicy`, `getPolicy` |
| 决策引擎 | 接收请求，评估策略 | `/decide`, `/evaluate` |
| 审批模块 | CHEQ 审批单管理 | `createCheq`, `approve`, `reject` |
| 审计存储 | 操作日志记录 | `log`, `query` |
| 消息投递 | 协调消息发送 | `deliver`, `send` |

## 4. 工作流程时序图

```mermaid
sequenceDiagram
    participant C as 哪吒
    participant D as 獬豸服务端
    participant T as 天枢
    participant M as Matrix/飞书
    participant H as 人类审批

    C->>D: 请求决策
    D->>T: 查询审批规则
    T-->>D: 返回规则
    
    D->>D: 策略评估
    
    alt 无需审批
        D-->>C: ALLOW
    else 需要审批
        D->>D: 创建审批单
        D->>T: 投递审批请求
        T->>M: 发送消息
        H->>M: 审批
        
        alt 审批通过
            M->>T: 通过
            T->>D: 通知通过
            D-->>C: ALLOW
        else 审批拒绝
            M->>T: 拒绝
            T->>D: 通知拒绝
            D-->>C: DENY
        end
    end
    
    D->>D: 记录审计日志
```

## 5. 接口设计

### 决策接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 策略决策 | POST | `/api/v1/decide` | 请求策略决策 |
| 策略评估 | POST | `/api/v1/evaluate` | 评估请求 |

### 策略管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建策略 | POST | `/api/v1/policies` | 创建新策略 |
| 获取策略 | GET | `/api/v1/policies/{id}` | 获取策略详情 |
| 更新策略 | PUT | `/api/v1/policies/{id}` | 更新策略 |
| 删除策略 | DELETE | `/api/v1/policies/{id}` | 删除策略 |

### 审批管理

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 创建审批单 | POST | `/api/v1/cheq` | 创建审批单 |
| 审批 | POST | `/api/v1/cheq/{id}/approve` | 审批通过 |
| 审批 | POST | `/api/v1/cheq/{id}/reject` | 审批拒绝 |
| 查询审批单 | GET | `/api/v1/cheq/{id}` | 查询审批单状态 |

### 审计

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 记录日志 | POST | `/api/v1/audit` | 记录审计日志 |
| 查询日志 | GET | `/api/v1/audit` | 查询审计日志 |

## 6. 策略引擎详细设计

### 6.1 策略引擎架构

```mermaid
flowchart TB
    Store["策略存储"]
    Loader["策略加载器"]
    Matcher["策略匹配器"]
    Pusher["策略下发器"]
    Cache["本地缓存"]
    T["天枢 PIP"]
    C["哪吒/客户端"]
    DB["数据库"]
    
    T --> Loader
    Loader --> Store
    Store --> DB
    Store --> Cache
    Cache --> Matcher
    Matcher --> Pusher
    Pusher --> C
```

### 6.2 策略下发机制

1. **初始化加载**：服务启动时从数据库加载策略到内存
2. **热更新**：策略变更时实时推送到客户端
3. **定时同步**：定期全量同步策略到客户端

### 6.3 策略定义结构

```json
{
  "id": "policy-001",
  "name": "Agent注册审批",
  "version": "1.0",
  "rules": [
    {
      "condition": "action == 'agent.register'",
      "effect": "REVIEW"
    }
  ],
  "scope": {
    "business_system": "tianshu"
  }
}
```

### 6.4 策略审批流程

```mermaid
sequenceDiagram
    participant A as 管理员
    participant PE as 策略引擎
    participant CHEQ as 审批模块
    participant T as 天枢
    participant C as 哪吒

    A->>PE: 修改策略
    PE->>PE: 生成策略变更
    PE->>CHEQ: 创建策略审批单
    CHEQ->>T: 投递审批请求
    T-->>A: 审批通知
    
    A->>T: 审批通过
    T-->>CHEQ: 审批结果
    CHEQ->>PE: 审批通过
    
    PE->>PE: 创建动态策略
    PE->>C: 下发策略
    C-->>PE: 确认接收
```

### 6.5 动态策略

审批通过后自动生成的策略：

```json
{
  "id": "dynamic-policy-xxx",
  "type": "DYNAMIC",
  "source": "approval-xxx",
  "rules": [...],
  "validity": {
    "start": "2026-01-01T00:00:00Z",
    "end": "2026-01-02T00:00:00Z"
  }
}
```

### 6.6 策略实时下发

```mermaid
sequenceDiagram
    participant PE as 策略引擎
    participant C as 哪吒
    participant Cache as 客户端缓存

    PE->>PE: 策略变更
    PE->>C: WebSocket 推送
    C->>Cache: 更新本地缓存
    C-->>PE: 确认
    
    alt 推送失败
        C->>C: 定时轮询
    end
```

### 6.7 策略接口扩展

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 加载策略 | POST | `/api/v1/policy/load` | 从天枢加载策略 |
| 下发策略 | POST | `/api/v1/policy/push` | 推送到客户端 |
| 创建动态策略 | POST | `/api/v1/policy/dynamic` | 创建动态策略 |
