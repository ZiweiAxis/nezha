# 谛听拦截方案设计

## 1. 概述

本文档描述谛听（PEP）的系统级拦截方案，专注于中长期实现。

## 2. 拦截需求

| 类型 | 描述 | 拦截点 |
|------|------|--------|
| 命令执行 | exec/spawn 等系统命令 | 进程创建 |
| 文件操作 | read/write 文件系统 | syscall |
| 网络请求 | HTTP/HTTPS 请求 | 网络层 |
| Tool 调用 | Agent 使用的工具 | 应用层 |

## 3. 推荐架构：分层拦截

```
┌─────────────────────────────────────────┐
│              谛听 (PEP)                  │
├─────────────────────────────────────────┤
│  L7  Tool 调用层   (Proxy 包装)          │
│  L6  HTTP 请求层  (Node.js 拦截)         │
├─────────────────────────────────────────┤
│  L5  系统隔离层   (Linux Namespace)       │
│  L4  系统调用    (Seccomp)              │
│  L3  网络层      (iptables)              │
├─────────────────────────────────────────┤
│  L2  审计日志    (始终启用)              │
└─────────────────────────────────────────┘
```

## 4. 中期实现方案

### 4.1 Linux Namespace 隔离

```yaml
# 命名空间配置
namespace:
  type: process  # 进程级隔离
  mounts:
    - /tmp       # 临时目录
    - /usr/bin   # 只读系统命令
  networks:
    - bridge     # 独立
  user:
网络栈    uid_map: 1000:1000
    gid_map: 1000:1000
```

### 4.2 Seccomp 系统调用过滤

```json
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "syscalls": [
    {"names": ["execve", "execveat"], "action": "SCMP_ACT_ALLOW"},
    {"names": ["read", "write", "open", "close"], "action": "SCMP_ACT_ALLOW"},
    {"names": ["socket", "connect", "sendto"], "action": "SCMP_ACT_ALLOW"},
    {"names": ["mount"], "action": "SCMP_ACT_ERRNO"},
    {"names": ["ptrace"], "action": "SCMP_ACT_ERRNO"}
  ]
}
```

### 4.3 网络层拦截 (iptables)

```bash
# 限制出站连接
iptables -A OUTPUT -m owner --uid-owner 1000 -p tcp --dport 80 -j ACCEPT
iptables -A OUTPUT -m owner --uid-owner 1000 -p tcp --dport 443 -j ACCEPT
iptables -A OUTPUT -m owner --uid-owner 1000 -j DROP

# 记录所有连接
iptables -A OUTPUT -m owner --uid-owner 1000 -j LOG --log-prefix "ZIWEI_BLOCKED: "
```

## 5. 审计日志设计

### 5.1 日志结构

```json
{
  "timestamp": "2026-02-19T12:00:00Z",
  "event_id": "evt-001",
  "actor": {
    "type": "agent",
    "id": "agent-001",
    "owner": "user-001"
  },
  "action": {
    "type": "exec",
    "command": "ls -la /",
    "path": "/bin/ls"
  },
  "decision": "ALLOW",
  "policy_id": "policy-001",
  "context": {
    "workspace": "/home/dministrator/clawd",
    "mode": "interactive"
  }
}
```

### 5.2 日志存储

| 存储 | 用途 |
|------|------|
| 本地文件 | 实时查询 |
| PostgreSQL | 长期存储 |
| Elasticsearch | 分析检索 |

### 5.3 审计 API

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/v1/audit/query` | POST | 查询审计日志 |
| `/api/v1/audit/export` | GET | 导出日志 |

## 6. 长期增强方案

### 6.1 gVisor 集成

适用于高安全场景，运行不可信代码在轻量级沙箱中。

### 6.2 eBPF 动态拦截

用于高级威胁检测和实时系统监控。

## 7. 实施计划

### Phase 1: 审计日志 (立即)
- [x] 设计日志结构
- [ ] 实现日志收集
- [ ] 接入獬豸审计模块

### Phase 2: Namespace 隔离 (2-4 周)
- [ ] Namespace 配置管理
- [ ] 进程隔离实现
- [ ] 网络桥接

### Phase 3: Seccomp 策略 (2-4 周)
- [ ] 系统调用白名单
- [ ] 危险 syscall 拦截
- [ ] 策略管理 UI

### Phase 4: 网络层 (2-4 周)
- [ ] iptables 规则
- [ ] 出站连接控制
- [ ] 日志记录
