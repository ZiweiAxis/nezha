# 紫微智能体治理平台 - 架构设计

> 版本: v1.0  
> 更新日期: 2026-02-19  
> 文档状态: 持续更新

---

## 1. 系统概述

紫微 (Ziwei) 是一个企业级 AI 智能体治理基础设施，旨在为智能体提供安全、可控、可审计的运行平台。平台采用分层解耦、开放接入的架构设计，由四个核心组件构成。

### 1.1 核心组件一览

| 组件 | 中文名 | 功能定位 | 技术栈 | 状态 |
|------|--------|----------|--------|------|
| **天枢 (Tianshu)** | 消息枢纽 | 飞书 ↔ Matrix 双向消息桥接、Agent 注册与身份管理 | Python | 开发中 |
| **谛听 (Diting)** | 治理网关 | 策略评估、人工审批、审计存证 | Go | MVP |
| **悟空 (Wukong)** | 拦截器 | Agent 端请求拦截、策略执行、任务挂起 | TypeScript | 开发中 |
| **太白 (Taibai)** | Python SDK | 多语言 SDK、适配器框架、协议定义 | Python | MVP |

---

## 2. 系统架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              外部用户 / Agent                                    │
│                    (Claude Code CLI / OpenClaw / Dify / 自定义)                 │
└────────────────────────────────┬────────────────────────────────────────────────┘
                                 │ HTTP/gRPC
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              悟空 (Wukong) - 拦截器                              │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ - 任务拦截 (TaskSuspendManager)                                         │    │
│  │ - 策略执行                                                               │    │
│  │ - 审批挂起                                                               │    │
│  │ - 审计上报                                                               │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└────────────────────────────────┬────────────────────────────────────────────────┘
                                 │ HTTP
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              太白 (Taibai) - SDK                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ - Agent.register() - Agent 注册                                         │    │
│  │ - Agent.heartbeat() - 心跳保活                                          │    │
│  │ - Agent.trace() - 审计上报                                              │    │
│  │ - 适配器基类 (CLIAdapterBase, PluginAdapterBase, SDKAdapterBase)       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└────────────────────────────────┬────────────────────────────────────────────────┘
                                 │ Taibai Protocol / HTTP
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              天枢 (Tianshu) - 网关服务                          │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐     │
│  │   消息桥接       │  │   身份管理        │  │   房间管理                │     │
│  │  (bridge/)       │  │  (identity/)     │  │  (core/room_manager/)     │     │
│  └──────────────────┘  └──────────────────┘  └──────────────────────────┘     │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────┐     │
│  │   Matrix 客户端  │  │   飞书适配器      │  │   谛听客户端             │     │
│  │  (matrix/)       │  │  (bridge/feishu) │  │  (diting_client/)        │     │
│  └──────────────────┘  └──────────────────┘  └──────────────────────────┘     │
└────────────────────────────────┬────────────────────────────────────────────────┘
                                 │ HTTP / Matrix Protocol
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              谛听 (Diting) - 5 层治理架构                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ L0: 身份验证 - X-Agent-Token / Authorization 验证                        │    │
│  │ L1: 风险评估 - 规则引擎 + LLM 分析                                       │    │
│  │ L2: 策略决策 - RBAC/ABAC + 风控规则                                     │    │
│  │ L3: 人机协同 - CHEQ 确认引擎 + 飞书审批                                  │    │
│  │ L4: 审计追溯 - JSONL 日志 + 链上存证                                     │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
└────────────────────────────────┘
                                 │ HTTP
┬────────────────────────────────────────────────                                 ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              真实后端 API / 服务                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

        │                                    │
        ▼                                    ▼
┌──────────────────┐              ┌──────────────────┐
│   Matrix 服务器   │              │    飞书 IM       │
│  (xyin.oicp.net) │              │   (审批通知)     │
└──────────────────┘              └──────────────────┘
```

### 2.2 数据流向

```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  Agent  │────▶│  悟空   │────▶│  天枢   │────▶│  谛听   │────▶│ 审批人  │
│  执行   │     │  拦截   │     │  路由   │     │  决策   │     │ 人工审批 │
└─────────┘     └─────────┘     └─────────┘     └─────────┘     └─────────┘
    │                                       │                      │
    │                                       │                      │
    └───────────────────────────────────────┴──────────────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │  审计存储    │
                    │ (JSONL/DB)  │
                    └─────────────┘
```

---

## 3. 核心组件详解

### 3.1 天枢 (Tianshu)

**位置**: `~/workspace/ziwei/tianshu/`

**功能**:
- 飞书 ↔ Matrix 双向消息桥接
- 用户身份映射与房间管理
- Agent 注册与身份管理 (DID)
- 与谛听集成进行消息审计

**项目结构**:
```
tianshu/
├── src/
│   ├── main.py                   # 应用入口
│   ├── config.py                 # 配置加载
│   ├── gateway_bootstrap.py      # 网关启动引导
│   ├── matrix/
│   │   └── client.py             # Matrix 客户端
│   ├── bridge/
│   │   └── feishu.py             # 飞书适配层
│   ├── core/
│   │   ├── translator.py         # 消息格式转换
│   │   ├── user_mapper.py        # 用户 ID 映射
│   │   └── room_manager.py       # 房间生命周期管理
│   ├── identity/                  # 身份管理
│   ├── registration/              # Agent 注册
│   ├── approval/                  # 审批流程
│   └── diting_client/            # 谛听集成
│       ├── reporter.py            # 上报审计消息
│       └── callback_server.py     # 接收谛听回调
├── docs/
├── compose.yaml
├── Containerfile
└── .env
```

**关键配置**:
| 环境变量 | 说明 | 示例值 |
|----------|------|--------|
| MATRIX_HOMESERVER | Matrix 服务器地址 | http://xyin.oicp.net:8008 |
| MATRIX_GATEWAY_USER | 网关用户 DID | @gateway:xyin.oicp.net |
| MATRIX_GATEWAY_TOKEN | 网关用户 Token | syt_xxx |
| FEISHU_APP_ID | 飞书应用 ID | cli_xxxxxxxxxx |
| FEISHU_APP_SECRET | 飞书应用密钥 | xxxxxxxxxx |
| DITING_AUDIT_URL | 谛听审计地址 | http://diting-server:5000/audit/message |
| APPROVAL_USER_ID | 审批人 DID | @hulk:xyin.oicp.net |
| HEALTH_PORT | 健康检查端口 | 8081 |

**端口**: 8081 (HTTP)

---

### 3.2 谛听 (Diting)

**位置**: `~/workspace/ziwei/diting/`

**功能**:
- 零信任身份验证 (L0)
- 策略引擎与风险评估 (L1-L2)
- 人机协同审批 (L3)
- 完整审计追溯 (L4)

**5 层架构**:

| 层 | 名称 | 组件 | 功能 |
|----|------|------|------|
| L0 | 身份验证 | `proxy/handler.go` | X-Agent-Token / Authorization 验证 |
| L1 | 风险评估 | `policy/engine.go` | 规则引擎 + LLM 分析 |
| L2 | 策略决策 | `models/decision.go` | Allow/Deny/Review 决策 |
| L3 | 人机协同 | `cheq/engine.go` | CHEQ 确认 + 飞书投递 |
| L4 | 审计追溯 | `audit/store.go` | JSONL/PostgreSQL/ClickHouse 存储 |

**项目结构**:
```
diting/
├── cmd/diting/
│   ├── main.go                    # 入口点
│   ├── config.yaml                # 配置模板
│   ├── policy_rules.example.yaml  # 策略规则示例
│   └── internal/
│       ├── proxy/
│       │   ├── handler.go         # HTTP 代理处理
│       │   ├── pipeline.go        # L0-L4 流水线
│       │   └── server.go          # 服务器
│       ├── policy/
│       │   └── engine.go          # 策略引擎接口
│       ├── cheq/
│       │   ├── engine.go          # CHEQ 确认引擎
│       │   └── types.go           # CHEQ 类型定义
│       ├── audit/
│       │   └── store.go           # 审计存储接口
│       ├── delivery/
│       │   └── feishu/           # 飞书投递实现
│       ├── models/
│       │   ├── decision.go        # 决策模型
│       │   ├── audit.go          # 审计模型
│       │   ├── confirmation.go   # 确认对象模型
│       │   └── request.go        # 请求上下文
│       └── config/
│           └── config.go          # 配置加载
├── docs/
└── data/
    ├── audit.jsonl               # 审计日志
    └── cheq/                     # CHEQ 存储
```

**关键配置** (`config.yaml`):
```yaml
proxy:
  listen_addr: ":8080"
  upstream: "http://localhost:8081"
  allowed_api_keys: ["key1", "key2"]

policy:
  rules_path: "policy_rules.yaml"

cheq:
  timeout_seconds: 120
  persistence_path: "./data/cheq"

delivery:
  feishu:
    enabled: true
    approval_user_id: "user_id"
    use_card_delivery: true
    use_long_connection: true

audit:
  path: "./data/audit.jsonl"
  redact: ["password", "token"]
```

**端口**: 8080 (HTTP)

---

### 3.3 悟空 (Wukong)

**位置**: `~/workspace/ziwei/wukong/`

**功能**:
- Agent 生命周期管理 (启动/停止/重启)
- 身份注册与管理
- 状态实时同步
- 零侵入治理 (通过 diting-hook 接入)

**运行模式**:
- **local**: 本地直接运行，无隔离
- **sandbox**: Docker 沙箱，基础隔离
- **deep-sandbox**: gVisor 深度沙箱，高安全性

**项目结构**:
```
wukong/
├── src/
│   ├── index.ts                  # 入口
│   ├── cli.ts                    # CLI 实现
│   ├── adapters/                 # 适配器接口
│   ├── clients/                  # 外部服务客户端
│   │   ├── tianshu.ts           # 天枢客户端
│   │   └── diting.ts            # 谛听客户端
│   ├── core/                     # 核心逻辑
│   ├── managers/                 # 管理器
│   │   ├── identity.ts          # 身份管理器
│   │   ├── agent.ts             # Agent 管理器
│   │   └── status.ts            # 状态管理器
│   ├── types/                    # 类型定义
│   └── utils/                    # 工具函数
├── tests/
├── docs/
└── package.json
```

**关键配置**:
| 环境变量 | 说明 | 默认值 |
|----------|------|--------|
| TIANSHU_API_URL | 天枢 API 地址 | http://localhost:8081 |
| TIANSHU_API_KEY | 天枢 API 密钥 | - |
| WUKONG_DATA_DIR | 数据目录 | ~/.wukong |
| LOG_LEVEL | 日志级别 | info |

**端口**: 8082 (HTTP)

---

### 3.4 太白 (Taibai)

**位置**: `~/workspace/ziwei/taibai/`

**功能**:
- Agent SDK (Python)
- 适配器基类 (CLI/Plugin/SDK)
- 协议定义 (事件类型常量)
- 适配器注册表

**项目结构**:
```
taibai/
├── sdk/python/ziwei_taibai/
│   ├── __init__.py
│   ├── agent.py                   # Agent SDK 核心类
│   ├── protocol.py                # 协议常量定义
│   ├── registry.py                # 适配器注册表
│   └── adapters/
│       ├── base.py               # 适配器基类
│       ├── cli_base.py           # CLI 适配器基类
│       ├── plugin_base.py        # 插件适配器基类
│       └── sdk_base.py           # SDK 适配器基类
├── adapters/
│   └── claude_code_cli/          # Claude Code CLI 适配器
├── examples/
│   └── verification_agent/       # 接入验证用智能体
└── docs/
```

**核心类**:

```python
# Agent SDK - 与天枢和谛听通信
class Agent:
    def discover()           # 发现天枢端点
    def register()          # 注册 Agent
    def heartbeat()          # 心跳保活
    def trace()              # 上报审计到谛听
```

**协议常量** (`protocol.py`):
```python
EVENT_REGISTER_REQUEST = "m.agent.register_request"
EVENT_IDENTITY = "m.agent.identity"
EVENT_ACTION = "m.agent.action"
EVENT_AUDIT = "m.agent.audit"
EVENT_HEARTBEAT = "m.agent.heartbeat"
EVENT_REVOKE = "m.agent.revoke"

ACTION_FILE_WRITE = "file_write"
ACTION_FILE_READ = "file_read"
ACTION_API_CALL = "api_call"
ACTION_EXEC_RUN = "exec:run"
ACTION_EXEC_SUDO = "exec:sudo"
```

---

## 4. API 接口列表

### 4.1 天枢 API

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 健康检查 | GET | `/health` | 服务健康状态 |
| 发现端点 | GET | `/.well-known/tianshu-matrix` | 服务发现 |
| 发现端点 | GET | `/api/v1/discovery` | 服务发现 (备用) |
| 注册 Agent | POST | `/api/v1/agents/register` | Agent 注册 |
| 消息转发 | POST | `/api/v1/message` | 消息发送 |

### 4.2 谛听 API

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 健康检查 | GET | `/health` | 服务健康状态 |
| 代理请求 | * | `/*` | 代理上游请求 |
| 审批回调 | POST | `/approve_callback` | 审批回调 |
| 审计上报 | POST | `/audit/message` | 审计消息上报 |
| CHEQ 审批 | POST | `/cheq/{id}/approve` | 审批通过 |
| CHEQ 拒绝 | POST | `/cheq/{id}/reject` | 审批拒绝 |
| CHEQ 查询 | GET | `/cheq/{id}` | 查询 CHEQ 状态 |

### 4.3 悟空 API

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| Agent 列表 | GET | `/api/agents` | 列出所有 Agent |
| Agent 状态 | GET | `/api/agents/{name}/status` | 查询状态 |
| Agent 启动 | POST | `/api/agents/{name}/start` | 启动 Agent |
| Agent 停止 | POST | `/api/agents/{name}/stop` | 停止 Agent |
| 身份注册 | POST | `/api/identity/register` | 注册新身份 |

---

## 5. 数据流与流程图

### 5.1 Agent 注册流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   悟空   │     │  太白SDK │     │   天枢   │     │   谛听   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1.注册请求      │                │                │
     │───────────────▶│                │                │
     │                │ 2.发现+注册     │                │
     │                │───────────────▶│                │
     │                │                │ 3.验证+创建DID │
     │                │                │──────┬─────────▶│
     │                │                │      │          │
     │                │                │◀─────┴──────────│
     │                │◀───────────────│                  │
     │◀──────────────│                │                  │
     │                │                │                  │
```

### 5.2 审批流程 (CHEQ)

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   悟空   │     │   天枢   │     │   谛听   │     │   飞书   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │ 1.请求操作      │                │                │
     │────────────────▶                │                │
     │                │ 2.转发请求       │                │
     │                │────────────────▶│                │
     │                │                │ 3.策略评估      │
     │                │                │ ─────────────▶ │
     │                │                │                │
     │                │                │ 4.返回 Review  │
     │                │◀───────────────│                │
     │                │                │                │
     │                │ 5.创建CHEQ     │                │
     │                │──────┬─────────▶│                │
     │                │      │          │                │
     │                │◀─────┴─────────│                │
     │                │                │                │
     │                │ 6.发送审批卡片  │                │
     │                │────────────────────────────────▶│
     │                │                │                │
     │                │                │    7.用户审批   │
     │◀─────────────────────────────────────────────────│
     │                │                │                │
     │                │ 8.审批回调     │                │
     │                │◀─────────────────────────────────│
     │                │                │                │
     │                │ 9.执行决策     │                │
     │                │ ─────────────▶│                │
     │                │                │                │
     │                │ 10.返回结果    │                │
     │◀──────────────│◀───────────────│                │
     │                │                │                │
```

### 5.3 消息通信模式

#### 审批通知: DM 私聊
```
悟空 → 谛听（决策需要审批）
          ↓
    天枢（路由管理，返回审批人）
          ↓
    @diting → 发送 DM 给审批人 (@hulk)
              ↓
    @diting → 监听审批回复（关键！）
              ↓
    @diting → 调用 /cheq/approve
```

#### Agent ↔ Owner: DM 私聊
```
Owner → 发送指令
          ↓
    gateway → 使用 Agent DID 发送 DM 给 Agent
              ↓
    Agent → 监听指令回复
              ↓
    Agent → 执行并返回结果
```

---

## 6. 关键技术

### 6.1 Matrix 通信

**Matrix 服务器**: `xyin.oicp.net:8008`

**用户身份 (DID)**:
| 身份 | 注册方式 | DID 示例 |
|------|----------|----------|
| Owner (真实人类) | 自己注册 | `did:human:xxx` |
| 审批人 | 固定配置 (hulk) | - |
| 谛听 | 系统初始化自动注册 | `did:agent:diting` |
| Agent | 悟空触发自动注册 | `did:agent:xxx` |

**紫微 Matrix 扩展事件**:
- `m.agent.register`: 智能体注册请求
- `m.agent.identity`: 身份下发与更新
- `m.agent.approval`: 审批事件
- `m.agent.action`: 操作上报
- `m.agent.audit`: 审计存证回执

### 6.2 CHEQ 确认引擎

CHEQ (Confirmation Engine) 是谛听的人机协同核心，负责创建和管理审批确认对象。

**ConfirmationObject 状态**:
- `pending`: 等待审批
- `approved`: 已批准
- `rejected`: 已拒绝
- `expired`: 已过期

**审批策略**:
- `any`: 任一审批人批准即可
- `all`: 所有审批人都必须批准

### 6.3 WebSocket 广播

谛听支持 WebSocket 长连接，用于实时审批事件推送。

**相关配置**:
```yaml
delivery:
  feishu:
    use_long_connection: true
    poll_interval_seconds: 2
```

---

## 7. 配置说明

### 7.1 端口规范

| 组件 | 服务名 | 端口 | 协议 |
|------|--------|------|------|
| **天枢** | tianshu | 8081 | HTTP |
| **谛听** | diting | 8080 | HTTP |
| **悟空** | wukong | 8082 | HTTP |
| **Synapse** | synapse | 8008 | HTTP |
| **Synapse** | synapse | 8448 | HTTPS (federation) |

### 7.2 Token 管理

| Token | 位置 | 说明 |
|-------|------|------|
| MATRIX_GATEWAY_TOKEN | tianshu/.env | 网关用户 Matrix Token |
| DITING_MATRIX_TOKEN | tianshu/.env | 谛听 Matrix Token |
| DITING_AUDIT_URL | tianshu/.env | 谛听审计上报地址 |
| X-Agent-Token | 请求头 | Agent 身份标识 |

### 7.3 环境变量汇总

#### 天枢 (.env)
```bash
FEISHU_APP_ID=cli_xxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxx
MATRIX_HOMESERVER=http://xyin.oicp.net:8008
MATRIX_GATEWAY_USER=@gateway:xyin.oicp.net
MATRIX_GATEWAY_TOKEN=syt_xxx
REGISTRATION_SHARED_SECRET=ziwei-gateway-dev-secret
DITING_AUDIT_URL=http://diting-server:5000/audit/message
APPROVAL_USER_ID=@hulk:xyin.oicp.net
HEALTH_PORT=8081
```

#### 谛听 (config.yaml)
```yaml
proxy:
  listen_addr: ":8080"
  allowed_api_keys: ["key1", "key2"]
cheq:
  timeout_seconds: 120
delivery:
  feishu:
    enabled: true
audit:
  path: "./data/audit.jsonl"
```

---

## 8. 快速开始

### 8.1 启动天枢

```bash
cd ~/workspace/ziwei/tianshu
cp .env.example .env
# 编辑 .env 配置
python src/main.py
```

### 8.2 启动谛听

```bash
cd ~/workspace/ziwei/diting/cmd/diting
cp config.example.yaml config.yaml
# 编辑 config.yaml 配置
go build -o bin/diting ./cmd/diting_allinone
./bin/diting
```

### 8.3 使用悟空

```bash
cd ~/workspace/ziwei/wukong
npm install
npm run build
npm link

# 启动 Agent
wukong claude --name my-agent --mode local
```

---

## 9. 参考文档

| 文档 | 路径 |
|------|------|
| 生态概览 | `ECOSYSTEM_OVERVIEW.md` |
| 快速参考 | `QUICK_REFERENCE.md` |
| 完整索引 | `INDEX.md` |
| 技术方案 | `docs/open/technical/紫微智能体治理基础设施-技术方案.md` |
| Matrix 通信 | `docs/implementing/matrix-communication.md` |
| 端口规范 | `docs/implementing/ports.md` |
| 谛听架构 | `diting/docs/ARCHITECTURE_FULL.md` |
| 太白原理 | `docs/open/technical/太白原理.md` |
| 太白对接 CLI 方案 | `docs/open/technical/太白对接Claude-Code-CLI方案.md` |

---

## 10. 附录

### 10.1 数据模型

#### RequestContext
```go
type RequestContext struct {
    AgentIdentity string              // L0 身份
    Method string                     // HTTP 方法
    TargetURL string                  // 目标 URL
    Resource string                   // 资源路径
    Action string                     // 操作类型
    Headers http.Header               // HTTP 头
    Context map[string]string         // 扩展字段
}
```

#### Decision
```go
type Decision struct {
    Kind DecisionKind                 // Allow / Deny / Review
    PolicyRuleID string               // 规则 ID
    DecisionReason string             // 决策理由
}
```

#### Evidence
```go
type Evidence struct {
    TraceID string                    // 追踪 ID
    AgentID string                    // Agent ID
    PolicyRuleID string               // 规则 ID
    Decision string                   // 决策
    CHEQStatus string                 // CHEQ 状态
    Confirmer string                  // 审批人
    Timestamp time.Time               // 时间戳
    Resource string                   // 资源
    Action string                     // 操作
}
```

#### ConfirmationObject
```go
type ConfirmationObject struct {
    ID string                         // 唯一 ID
    TraceID string                    // 追踪 ID
    Resource string                   // 资源
    Action string                     // 操作
    Summary string                    // 摘要
    Status ConfirmationStatus         // 状态
    ExpiresAt time.Time               // 过期时间
    ConfirmerIDs []string            // 审批人列表
    ApprovalPolicy string            // 审批策略
    CreatedAt time.Time              // 创建时间
    UpdatedAt time.Time              // 更新时间
}
```

### 10.2 变更历史

| 日期 | 版本 | 变更 |
|------|------|------|
| 2026-02-19 | v1.0 | 初始版本，整合现有文档 |
