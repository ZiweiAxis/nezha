# 哪吒详细架构设计

## 1. 定位与职责

**定位**：哪吒是紫微系统的 Agent 生命周期管理器，集成在客户端环境。

**核心职责**：
- 集成**谛听**（独立项目 PEP 客户端）- 引用，无业务逻辑
- 集成**太白**（独立项目天枢客户端）- 引用，无业务逻辑
- Agent 生命周期管理
- 转发操作请求到谛听
- 执行决策结果

## 2. 架构图

```mermaid
flowchart TB
    subgraph 哪吒["哪吒 Nezha (Agent 管理器)"]
        Core["核心逻辑"]
        DClient["谛听客户端\n(独立项目引用)"]
        TClient["太白客户端\n(独立项目引用)"]
    end
    
    subgraph 獬豸["獬豸服务端"]
        DAPI["API"]
    end
    
    subgraph 天枢["天枢服务端"]
        TAPI["API"]
    end
    
    subgraph 外部
        Agent["Agent"]
        Tool["Tool"]
        Matrix["Matrix"]
    end
    
    Agent --> Core
    Tool --> Core
    Core --> DClient
    Core --> TClient
    DClient --> DAPI
    TClient --> TAPI
    DClient --> Matrix
```

## 3. 核心功能模块

| 模块 | 功能描述 |
|------|----------|
| 核心逻辑 | Agent 生命周期管理、请求转发 |
| 谛听客户端 | 独立项目 (ZiweiAxis/diting)，集成引用，无业务逻辑 |
| 太白客户端 | 独立项目 (ZiweiAxis/taibai)，集成引用，负责消息通讯 |

## 4. 工作流程时序图

```mermaid
sequenceDiagram
    participant A as Agent
    participant W as 哪吒
    participant DC as 獬豸客户端
    participant DT as 獬豸服务端
    participant TB as 太白客户端
    participant TS as 天枢服务端

    A->>W: 发起操作
    W->>DC: 转发请求
    
    rect rgb(240, 248, 255)
        note right of DC: 獬豸客户端负责策略决策
        DC->>DT: 请求决策
        DT-->>DC: 返回决策
    end
    
    alt 需审批
        DC->>TB: 创建审批请求
        TB->>TS: 投递消息
        TS-->>DC: 审批结果
    end
    
    DC-->>W: 决策结果
    W-->>A: 返回结果
```

## 5. 接口设计

| 接口 | 说明 |
|------|------|
| 与Agent | 接收操作请求 |
| 与谛听客户端 | 转发请求、接收决策 |
| 与太白客户端 | 消息投递请求 |
