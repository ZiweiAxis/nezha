# 内网穿透方案调研

## 背景

紫微系统部署在家庭网络环境中，需要将内网服务暴露到公网供外部访问。本文档调研主流内网穿透方案，为技术选型提供参考。

---

## 一、各方案介绍

### 1. cloudflared (Cloudflare Tunnel)

**简介**：Cloudflare 提供的免费隧道服务，通过 Cloudflare 全球网络将内网服务暴露到公网。

**特点**：
- 免费使用，无需服务器
- 自动 HTTPS 证书
- 稳定可靠，全球 CDN 加速
- 需要绑定域名（可使用免费域名）
- 客户端轻量，支持多种平台

**适用场景**：长期稳定暴露 Web 服务

---

### 2. frp (Fast Reverse Proxy)

**简介**：开源的内网穿透工具，采用 Go 语言开发。

**特点**：
- 完全开源免费
- 需要自建服务器（中转或 P2P 模式）
- 支持 TCP/UDP/HTTP/HTTPS
- 配置灵活，性能高
- 无 Web 管理界面

**适用场景**：有自有服务器的用户

---

### 3. nps (Network Proxy Server)

**简介**：轻量级代理服务器，支持 Web 管理界面。

**特点**：
- 开源免费
- 内置 Web 管理界面
- 支持 HTTP/HTTPS/TCP/UDP
- 客户端和服务端分离
- 配置简单，支持多种协议

**适用场景**：需要图形化管理界面的用户

---

### 4. tunnelto

**简介**：免费的客户端工具，简单易用。

**特点**：
- 免费使用
- 无需配置服务器
- 客户端简单
- 共享的子域名
- 适合临时使用

**适用场景**：临时测试、演示

---

### 5. localtunnel

**简介**：Node.js 开发的 npm 包，快速创建临时隧道。

**特点**：
- 开源免费
- 通过 npm 快速部署
- 自动分配子域名
- 适合开发测试
- 需要 Node.js 环境

**适用场景**：开发者快速测试

---

### 6. ngrok

**简介**：最知名的内网穿透工具，功能强大。

**特点**：
- 成熟稳定，功能丰富
- 免费版有限制（随机域名、每小时失效）
- 付费版提供固定域名、白名单等
- 支持 HTTPS、TCP、TLS
- 需要注册账号

**适用场景**：商业项目、长期部署

---

### 7. ZeroTier

**简介**：P2P 组网工具，创建虚拟局域网。

**特点**：
- P2P 直连，不经过中转服务器（理想情况）
- 免费版支持最多 25 台设备
- 需要安装客户端
- 获得真实内网 IP
- 适合长期组网

**适用场景**：多设备组网、远程办公

---

### 8. Tailscale

**简介**：基于 WireGuard 的 P2P 组网工具。

**特点**：
- P2P 直连，WireGuard 协议
- 免费版支持 20 台设备
- 自动 NAT 穿透
- 获取真实内网 IP
- 支持出口节点（类似 VPN）
- 需要 Google/Apple 账号

**适用场景**：远程访问、组网

---

## 二、对比表格

| 方案 | 类型 | 免费 | 自建服务器 | Web 管理 | 稳定性 | 速度 | 易用性 |
|------|------|------|------------|----------|--------|------|--------|
| cloudflared | 隧道 | ✅ | ❌ | ❌ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| frp | 隧道 | ✅ | ✅ | ❌ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| nps | 代理 | ✅ | ✅ | ✅ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| tunnelto | 隧道 | ✅ | ❌ | ❌ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| localtunnel | 隧道 | ✅ | ❌ | ❌ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| ngrok | 隧道 | ⚠️有限 | ❌ | ✅ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| ZeroTier | P2P | ✅(25设备) | ❌ | ✅ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| Tailscale | P2P | ✅(20设备) | ❌ | ✅ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## 三、推荐方案

### 首选方案：cloudflared

**理由**：
1. **完全免费** - 无需任何费用
2. **稳定可靠** - Cloudflare 全球网络
3. **无需服务器** - 不需要自建中转
4. **自动 HTTPS** - 无需配置证书
5. **适合紫微系统** - 长期运行、Web 服务暴露

### 备选方案：Tailscale

**适用场景**：
- 需要获得真实内网 IP
- 多设备组网
- 已有 tailscale 账号

### 不推荐方案

- **tunnelto/localtunnel**：适合临时使用，不稳定
- **ngrok 免费版**：限制多，每小时需要重新连接
- **frp/nps**：需要自建服务器

---

## 四、实施步骤

### 方案一：cloudflared 部署

#### 1. 准备工作
- 一个域名（可使用免费域名如 .tk, .ml）
- 将域名 NS 解析指向 Cloudflare

#### 2. 安装 cloudflared

```bash
# Linux x86_64
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
chmod +x cloudflared-linux-amd64
sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

# 验证安装
cloudflared --version
```

#### 3. 登录 Cloudflare

```bash
cloudflared tunnel login
# 会打开浏览器进行授权
```

#### 4. 创建隧道

```bash
cloudflared tunnel create ziwei-tunnel
# 记录返回的 Tunnel ID
```

#### 5. 配置 DNS 和隧道

```bash
# 添加 DNS 解析
cloudflared tunnel route dns ziwei-tunnel ziwei.yourdomain.com

# 或使用 IP 模式
cloudflared tunnel ingress rule --hostname ziwei.yourdomain.com --service http://localhost:8080
```

#### 6. 运行隧道

```bash
# 前台运行测试
cloudflared tunnel run ziwei-tunnel

# 后台运行（使用 systemd）
sudo cloudflared service install
# 编辑配置 /etc/systemd/system/cloudflared.service
```

#### 7. 配置文件示例

创建 `~/.cloudflared/config.yml`：

```yaml
tunnel: ziwei-tunnel
credentials-file: /root/.cloudflared/ziwei-tunnel.json

ingress:
  - hostname: ziwei.yourdomain.com
    service: http://localhost:8080
  - service: http_status:404
```

---

### 方案二：Tailscale 部署（备选）

#### 1. 安装 Tailscale

```bash
# Linux
curl -fsSL https://tailscale.com/install.sh | sh

# 或使用包管理器
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install tailscale
```

#### 2. 登录

```bash
sudo tailscale up
# 会打开浏览器进行授权
```

#### 3. 获取 IP

登录后会获得一个 100.x.x.x 的虚拟 IP，其他设备安装 Tailscale 后可直接通过该 IP 访问。

#### 4. 关闭退出节点（可选）

```bash
sudo tailscale set --exit-node=false
```

---

## 五、总结

| 场景 | 推荐方案 |
|------|----------|
| 长期稳定 Web 服务 | cloudflared |
| 多设备组网 | Tailscale / ZeroTier |
| 临时测试 | localtunnel |
| 有自有服务器 | frp / nps |

**最终推荐**：使用 **cloudflared** 作为紫微系统的内网穿透方案，原因是无需服务器、稳定可靠、完全免费。
