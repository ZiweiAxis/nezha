# 紫微系统部署架构

## 一、当前部署情况

### 1.1 组件分布总览

| 组件 | 名称 | 位置 | 端口 | 状态 |
|------|------|------|------|------|
| **谛听** | Diting | 本机 Podman | 8080 | 运行中 |
| **天枢** | Tianshu | 本机 Podman | 8082 | 运行中 |
| **Synapse** | Matrix | NAS Docker | 内部 | 运行中 |
| **FileBrowser** | 文件管理 | NAS Docker | 8082 | 运行中 |
| **产品站点** | Ziwei Site | NAS Docker | 3001 | 运行中 |
| **私有镜像仓库** | Registry | NAS Docker | 5050 | 运行中 |

### 1.2 本机运行组件

**Podman 容器**：
```
$ podman ps
CONTAINER ID  IMAGE                    COMMAND               PORTS       NAMES
575af3027d4c  localhost/ziwei-diting   /app/diting           8080/tcp    ziwei-diting
d3f5bc0eab58  localhost/ziwei-tianshu  python -m src.main   8082/tcp    ziwei-tianshu
```

**端口监听**：
| 端口 | 服务 | 说明 |
|------|------|------|
| 8080 | diting | 策略网关 (PDP+PEP) |
| 8081 | - | 预留 (原天枢测试用) |
| 8082 | tianshu | 消息枢纽 (PIP) |

### 1.3 NAS 运行组件

**Docker 容器**：
```
$ ssh -p 2345 hulk@192.168.3.16 "sudo docker ps"
CONTAINER ID   IMAGE                              PORTS
17780affe450   filebrowser/filebrowser:v2.55.0   0.0.0.0:8082->80/tcp
2ea792a2f42a   localhost/ziwei-product-site       0.0.0.0:3001->3001/tcp
850cff054e37   matrixdotorg/synapse:v1.100.0      (internal)
f2b55765e569   registry:2                         0.0.0.0:5050->5000/tcp
836b442e97cc   nginx:stable-alpine                0.0.0.0:8080->80/tcp
8e3a53bb2107   registry:5000/nasapp/deploy-api    0.0.0.0:3000->3000/tcp
```

---

## 二、网络架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户网络                                    │
│                                                                         │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────────────────┐ │
│   │  飞书 APP   │     │  Matrix     │     │    OpenClaw/Agent       │ │
│   │ (审批卡片)  │     │ (Element)   │     │    (执行方)             │ │
│   └──────┬──────┘     └──────┬──────┘     └───────────┬─────────────┘ │
│          │                    │                         │               │
└──────────┼────────────────────┼─────────────────────────┼───────────────┘
           │                    │                         │
           │                    │ (HTTP/WebSocket)        │ (HTTP)
           ▼                    ▼                         ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           外网 (xyin.oicp.net)                          │
│                                                                         │
│  ┌──────────────────┐  ┌──────────────────────────────────────────┐   │
│  │  Synapse:8008    │  │           NAS Docker 基础设施               │   │
│  │  (Matrix Homeserver) │  │  ┌──────────┐ ┌──────────┐ ┌───────┐ │   │
│  └──────────────────┘  │  │ 8080/8443 │ │ :5050    │ │:3001  │ │   │
│                        │  └──────────┘ └──────────┘ └───────┘ │   │
│                        └──────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    (本机 Podman 网络: ziwei-net)
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                        本机 Podman 容器网络                             │
│                                                                         │
│   ┌─────────────────────────┐      ┌─────────────────────────────┐    │
│   │      ziwei-tianshu      │      │        ziwei-diting         │    │
│   │  ┌─────────────────┐   │      │  ┌───────────────────────┐   │    │
│   │  │ 天枢 (Tianshu)  │   │      │  │    谛听 (Diting)      │   │    │
│   │  │   端口: 8080    │   │      │  │     端口: 8080        │   │    │
│   │  │   PIP 角色      │   │      │  │   PEP/PDP+PAP 角色    │   │    │
│   │  └─────────────────┘   │      │  └───────────────────────┘   │    │
│   │         │              │      │            │                  │    │
│   │  消息枢纽               │      │    策略拦截/审批              │    │
│   │  - Agent 注册          │      │    - L0-L4 流水线            │    │
│   │  - 任务分发            │      │    - CHEQ 审批               │    │
│   │  - 审批投递            │      │    - 审计记录                │    │
│   └───────────┬───────────┘      └─────────────┬────────────────┘    │
│               │                                │                      │
│               │     HTTP/WebSocket             │                      │
│               └───────────────┬─────────────────┘                      │
│                               │                                        │
└───────────────────────────────┼────────────────────────────────────────┘
                                │
                    ┌────────────┴────────────┐
                    │      本机宿主机          │
                    │  ┌──────────────────┐   │
                    │  │ OpenClaw Gateway │   │
                    │  │   端口: 18789    │   │
                    │  └──────────────────┘   │
                    └─────────────────────────┘
```

### 2.2 数据流说明

```
1. Agent 注册流程:
   Agent → 天枢 (8082) → Synapse (xyin.oicp.net:8008)

2. 任务执行流程:
   Agent → 谛听 (8080) → [L0-L4 策略检查] → [需要审批?] → 天枢 → 飞书/Matrix

3. 审批流程:
   飞书/Matrix 审批 → 天枢 → 谛听 → 转发到实际后端 API
```

### 2.3 网络连通性

| 源 | 目标 | 协议 | 端口 | 说明 |
|----|------|------|------|------|
| 本机 | NAS Synapse | HTTP | 8008 | 外部 Matrix 服务 |
| 天枢 | NAS Synapse | HTTP | 8008 | 网关用户注册 |
| 谛听 | 天枢 | HTTP | 8082 | 审批回调投递 |
| 天枢 | 谛听 | HTTP | 8080 | 策略查询 |
| 天枢 | 飞书 | HTTPS | 443 | 审批卡片推送 |
| Agent | 谛听 | HTTP | 8080 | 策略拦截 |
| Agent | 天枢 | HTTP | 8082 | 消息发送 |

---

## 三、端口配置

### 3.1 本机端口

| 端口 | 服务 | 容器名 | 用途 |
|------|------|--------|------|
| 8080 | diting | ziwei-diting | 策略网关 |
| 8082 | tianshu | ziwei-tianshu | 消息枢纽 |
| 18789 | OpenClaw | openclaw-gateway | 主服务 |

### 3.2 NAS 端口

| 端口 | 服务 | 容器名 | 用途 |
|------|------|--------|------|
| 3000 | deploy-api | nas-deploy-api | 部署 API |
| 3001 | product-site | ziwei-site | 产品站点 |
| 5050 | registry | nas-registry | 私有镜像仓库 |
| 8080 | nginx | nas-deploy-nginx | 反向代理 |
| 8082 | filebrowser | filebrowser | 文件管理 |

### 3.3 外部服务

| 地址 | 服务 | 用途 |
|------|------|------|
| xyin.oicp.net:8008 | Synapse | Matrix 通讯 |
| xyin.oicp.net:8083 | FileBrowser | 文档预览 |

---

## 四、组件说明

### 4.1 核心组件

| 组件 | 语言 | 目录 | 角色 | 状态 |
|------|------|------|------|------|
| **天枢 (Tianshu)** | Python | `tianshu/` | PIP - 消息枢纽 | MVP |
| **谛听 (Diting)** | Go | `diting/` | PEP/PDP+PAP - 策略引擎 | MVP |
| **太白 (Taibai)** | Python | `taibai/` | SDK - 适配器框架 | MVP |
| **哪吒 (Nezha)** | TypeScript | `nezha/` | Agent 生命周期 | 开发中 |
| **獬豸 (Xiezhi)** | Go | `xiezhi/` | 策略服务 | 开发中 |

### 4.2 基础设施

| 组件 | 类型 | 位置 | 说明 |
|------|------|------|------|
| **Synapse** | Matrix | NAS | 消息服务器 |
| **飞书** | 审批 | 云端 | 审批卡片推送 |

---

## 五、缺失的文档

### 5.1 部署文档

| 文档 | 位置 | 状态 | 优先级 |
|------|------|------|--------|
| **一键部署脚本** | `deploy/` | 部分存在 | P0 |
| **环境变量说明** | - | **缺失** | P0 |
| **升级文档** | - | **缺失** | P1 |
| **故障排查指南** | - | **缺失** | P1 |

### 5.2 网络文档

| 文档 | 位置 | 状态 | 优先级 |
|------|------|------|--------|
| **端口映射表** | - | **缺失** | P0 |
| **防火墙规则** | - | **缺失** | P2 |
| **外网访问配置** | - | **缺失** | P1 |

### 5.3 运维文档

| 文档 | 位置 | 状态 | 优先级 |
|------|------|------|--------|
| **日志说明** | - | **缺失** | P1 |
| **监控配置** | - | **缺失** | P2 |
| **备份方案** | - | **缺失** | P2 |

---

## 六、BMAD 补充建议

### 6.1 待创建的 Story

| Story | 描述 | 优先级 | 模块 |
|-------|------|--------|------|
| **环境变量文档化** | 创建 `.env` 完整说明文档，包含所有变量的用途、默认值、是否必填 | P0 | 文档 |
| **部署检查脚本** | 创建 `deploy/check-health.sh`，验证所有服务状态 | P0 | 部署 |
| **一键启动脚本** | 完善 `deploy/start-all.sh`，支持本机一键启动 | P0 | 部署 |
| **故障排查手册** | 创建 `docs/ops/troubleshooting.md`，常见问题及解决方案 | P1 | 运维 |
| **升级指南** | 创建 `docs/ops/upgrade.md`，版本升级步骤 | P1 | 运维 |
| **日志配置说明** | 创建 `docs/ops/logging.md`，各组件日志位置和级别 | P1 | 运维 |
| **NAS 部署指南** | 创建 `docs/deployment/nas.md`，NAS 独立部署步骤 | P1 | 部署 |
| **监控接入** | 接入 Prometheus + Grafana 监控 | P2 | 运维 |

### 6.2 优先级建议

**第一阶段 (P0)**：
1. 完成环境变量文档
2. 完善健康检查脚本
3. 一键启动脚本

**第二阶段 (P1)**：
1. 故障排查手册
2. 升级指南
3. 日志说明
4. NAS 部署指南

**第三阶段 (P2)**：
1. 监控系统接入
2. 备份方案
3. 防火墙规则

---

## 七、当前环境变量

### 7.1 必需变量

| 变量 | 说明 | 当前值 |
|------|------|--------|
| `MATRIX_HOMESERVER` | Synapse 地址 | `http://xyin.oicp.net:8008` |
| `MATRIX_GATEWAY_USER` | 网关用户 ID | `@gateway:xyin.oicp.net` |
| `REGISTRATION_SHARED_SECRET` | 注册密钥 | `ziwei-gateway-dev-secret` |
| `FEISHU_APP_ID` | 飞书应用 ID | (未设置) |
| `FEISHU_APP_SECRET` | 飞书应用密钥 | (未设置) |
| `DELIVERY_ROOM_ID` | 审批投递房间 | `!dUfdUfOFQLGIcWFGRB:xyin.oicp.net` |

### 7.2 可选变量

| 变量 | 说明 | 当前值 |
|------|------|--------|
| `DITING_TIANSHU_ENABLED` | 启用天枢投递 | `true` |
| `APPROVAL_REPLY_VIA_MATRIX` | Matrix 审批 | `true` |
| `SYNAPSE_IMAGE` | Synapse 镜像 | `matrixdotorg/synapse:v1.100.0` |

---

## 八、验证命令

### 8.1 健康检查

```bash
# 本机服务
curl -s http://localhost:8080/healthz   # 谛听
curl -s http://localhost:8082/health   # 天枢

# NAS 服务
curl -s http://192.168.3.16:8008/health  # Synapse
curl -s http://192.168.3.16:8082/        # FileBrowser

# 外部服务
curl -s http://xyin.oicp.net:8008/health  # 外部 Synapse
```

### 8.2 容器状态

```bash
# 本机 Podman
podman ps

# NAS Docker
ssh -p 2345 hulk@192.168.3.16 "sudo docker ps"
```
