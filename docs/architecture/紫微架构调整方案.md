# 紫微架构调整方案

## 一、当前问题

### 1.1 代码分布混乱

| 位置 | 问题 |
|------|------|
| `xiezhi/cmd/diting/` | 谛听代码在獬豸项目内（已独立） |
| `tianshu/src/diting_client/` | 天枢下有独立的谛听客户端（已删除） |

---

## 二、正确架构

### 2.1 模块结构

```
紫微项目 (~/workspace/ziwei/)
├── nezha/     # 哪吒 - Agent 生命周期管理
├── xiezhi/   # 獬豸 - 策略服务 + 审批服务
├── tianshu/  # 天枢 - 消息中枢
├── taibai/   # 太白 - 天枢 SDK（各模块集成使用）
└── diting/   # 谛听 - PEP 策略执行点（独立子项目）
```

### 2.2 正确依赖关系

```
         ┌─────────────────────────────────────┐
         │              獬豸                       │
         │         (策略决策服务端)                 │
         │                                       │
         │    审批消息 ──▶ 天枢 (通过太白 SDK)     │
         └──────────────────┬────────────────────┘
                          ▲
                          │ 谛听调用獬豸
                          │ (HTTP)
         ┌────────────────┴────────────────┐
         │                                   │
    ┌────┴────┐                      ┌──────┴──────┐
    │   谛听   │                      │ 太白 SDK     │
    │ (PEP)   │                      │ (天枢客户端)  │
    └────┬────┘                      └──────┬──────┘
         │                                   │
    哪吒调用谛听                         天枢调用太白
         │                                   │
    ┌────┴────┐                      ┌──────┴──────┐
    │   哪吒   │                      │    天枢     │
    │ (Agent) │                      │ (消息中枢)   │
    └─────────┘                      └─────────────┘
```

### 2.3 依赖总结

| 模块 | 依赖谁 | 被谁依赖 | 依赖说明 |
|------|--------|----------|----------|
| **獬豸** | 太白 | 谛听 | 使用太白 SDK 调用天枢投递审批消息 |
| **谛听** | 獬豸 | 哪吒 | 调用獬豸获取策略决策 |
| **哪吒** | 谛听、太白 | - | 使用谛听拦截、使用太白发消息 |
| **太白** | 天枢 | 哪吒、獬豸 | 天枢的客户端 SDK |
| **天枢** | - | 太白 | 被太白调用 |

### 2.4 模块职责

| 模块 | 职责 | 角色 |
|------|------|------|
| **哪吒** | Agent 生命周期管理 | 调用方 |
| **獬豸** | 策略决策 + 审批服务 | 服务端（被谛听调用） |
| **天枢** | 消息中枢 | 服务端（被太白调用） |
| **太白** | 天枢 SDK | 客户端库 |
| **谛听** | PEP 策略执行 | 獬豸的客户端 |

---

## 三、调用协议

| 调用路径 | 协议 | 说明 |
|----------|------|------|
| 哪吒 → 谛听 | HTTP | 策略拦截请求 |
| 谛听 → 獬豸 | HTTP | 获取策略决策 |
| 獬豸 → 天枢 | 太白 SDK | 审批消息投递 |
| 哪吒 → 天枢 | 太白 SDK | 消息发送 |

---

## 四、当前问题

### 4.1 直接调用问题

**问题**：獬豸直接调用天枢，未使用太白 SDK

```go
// 当前代码 (xiezhi/internal/delivery/tianshu/tianshu.go)
http.Post("http://tianshu:8081/api/v1/delivery/approval-request", ...)
```

**应改为**：
```go
// 正确方式
taibaiClient.SendApprovalRequest(...)
```

---

## 五、调整完成状态

### Phase 1: 方案确认
- [x] 明确模块结构
- [x] 定义调用关系
- [x] 更新设计文档

### Phase 2: 谛听独立化
- [x] 创建 `ziwei/diting/`
- [x] 移动代码

### Phase 3: 天枢清理
- [x] 删除 `tianshu/src/diting_client/`

### Phase 4: 调用统一
- [ ] 獬豸使用太白 SDK（待改造）

---

## 六、后续任务

| 任务 | 模块 | 优先级 |
|------|------|----------|
| 太白 SDK 开发 | 太白 | P0 |
| 獬豸改造使用太白 SDK | 獬豸 | P1 |
| 谛听 Seccomp 实现 | 谛听 | P1 |
| 哪吒改造 | 哪吒 | P1 |
