# 紫微架构调整方案

## 一、当前问题

### 1.1 代码分布混乱

| 位置 | 问题 |
|------|------|
| `xiezhi/cmd/diting/` | 谛听代码在獬豸项目内（应该独立） |
| `tianshu/src/diting_client/` | 天枢下有独立的谛听客户端（已删除） |

### 1.2 架构不一致

- 文档描述：谛听是独立子项目
- 实际代码：谛听是獬豸的子模块（已独立）

---

## 二、正确架构

### 2.1 模块结构

```
紫微项目 (~/workspace/ziwei/)
├── nezha/     # 哪吒 - Agent 生命周期管理
├── xiezhi/   # 獬豸 - 策略服务 + 审批服务
├── tianshu/  # 天枢 - 消息中枢
├── taibai/   # 太白 - 天枢 SDK（各模块集成使用）
└── diting/   # 谛听 - PEP 策略执行点（独立子项目）
```

### 2.2 正确依赖关系

```
         ┌─────────────────────────────────────┐
         │              獬豸                       │
         │         (策略决策服务端)                 │
         └──────────────────┬────────────────────┘
                          ▲
                          │ 谛听调用獬豸
                          │ (HTTP)
         ┌────────────────┴────────────────┐
         │                                   │
    ┌────┴────┐                      ┌──────┴──────┐
    │   谛听   │                      │ 太白 SDK     │
    │ (PEP)   │                      │ (天枢客户端)  │
    └────┬────┘                      └──────┬──────┘
         │                                   │
    哪吒调用谛听                         天枢调用太白
         │                                   │
    ┌────┴────┐                      ┌──────┴──────┐
    │   哪吒   │                      │    天枢     │
    │ (Agent) │                      │ (消息中枢)   │
    └─────────┘                      └─────────────┘
```

### 2.3 依赖总结

| 模块 | 依赖谁 | 被谁依赖 |
|------|--------|----------|
| **獬豸** | - | 谛听 |
| **谛听** | 獬豸 | 哪吒 |
| **哪吒** | 谛听、太白 | - |
| **太白** | 天枢 | 哪吒、獬豸 |
| **天枢** | - | 太白 |

### 2.4 模块职责

| 模块 | 职责 | 角色 |
|------|------|------|
| **哪吒** | Agent 生命周期管理 | 调用方 |
| **獬豸** | 策略决策 + 审批服务 | 服务端 |
| **天枢** | 消息中枢 | 服务端 |
| **太白** | 天枢 SDK | 客户端库 |
| **谛听** | PEP 策略执行 | 獬豸的客户端 |

---

## 三、调用协议

| 调用路径 | 协议 | 说明 |
|----------|------|------|
| 哪吒 → 谛听 | HTTP | 策略拦截请求 |
| 谛听 → 獬豸 | HTTP | 获取策略决策 |
| 獬豸 → 天枢 | 太白 SDK | 审批消息投递 |
| 哪吒 → 天枢 | 太白 SDK | 消息发送 |

---

## 四、调整完成状态

### Phase 1: 方案确认
- [x] 明确模块结构
- [x] 定义调用关系
- [x] 更新设计文档

### Phase 2: 谛听独立化
- [x] 创建 `ziwei/diting/`
- [x] 移动代码
- [ ] 修复 import 依赖

### Phase 3: 天枢清理
- [x] 删除 `tianshu/src/diting_client/`

### Phase 4: 调用统一
- [x] 检查直接调用（无需修改）

---

## 五、后续任务

| 任务 | 模块 | 优先级 |
|------|------|--------|
| 太白 SDK 开发 | 太白 | P0 |
| 谛听 Seccomp 实现 | 谛听 | P1 |
| 獬豸使用太白 SDK | 獬豸 | P1 |
| 哪吒使用太白 SDK | 哪吒 | P1 |
