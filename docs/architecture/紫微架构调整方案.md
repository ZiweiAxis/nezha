# 紫微架构调整方案

## 一、当前问题

### 1.1 代码分布混乱

| 位置 | 问题 |
|------|------|
| `xiezhi/cmd/diting/` | 谛听代码在獬豸项目内（应该独立） |
| `tianshu/src/diting_client/` | 天枢下有独立的谛听客户端（不应该存在） |

### 1.2 架构不一致

- 文档描述：谛听是独立子项目
- 实际代码：谛听是獬豸的子模块

### 1.3 调用关系混乱

- 天枢直接调用"谛听客户端"（不应该）
- 应该通过太白 SDK 统一调用

---

## 二、正确架构

### 2.1 模块结构

```
紫微项目 (~/workspace/ziwei/)
├── nezha/     # 哪吒 - Agent 生命周期管理
├── xiezhi/   # 獬豸 - 策略服务 + 审批服务
├── tianshu/  # 天枢 - 消息中枢
├── taibai/   # 太白 - 天枢 SDK（各模块集成使用）
└── diting/   # 谛听 - PEP 策略执行点（独立子项目）
```

### 2.2 正确调用关系

```
┌─────────┐     HTTP      ┌─────────┐     太白 SDK     ┌─────────┐
│  哪吒   │ ─────────────▶ │  獬豸  │ ◀──────────────▶ │  天枢  │
│ (太白)  │               │ (太白)  │                 │         │
└─────────┘               └─────────┘                 └─────────┘
       │                       │
       ▼                       ▼
┌─────────────────────────────────────────────────────────┐
│                      谛听                              │
│  (独立子项目，被獬豸/哪吒 调用)                        │
└─────────────────────────────────────────────────────────┘
```

### 2.3 模块职责

| 模块 | 职责 | 依赖 |
|------|------|------|
| **哪吒** | Agent 生命周期管理 | 太白 SDK、谛听 |
| **獬豸** | 策略决策 + 审批 | 太白 SDK、谛听 |
| **天枢** | 消息中枢 | - |
| **太白** | 天枢客户端 SDK | - |
| **谛听** | PEP 策略执行 | 被獬豸/哪吒调用 |

---

## 三、调整方案

### 3.1 谛听独立化

**当前**：`xiezhi/cmd/diting/`（在獬豸项目内）

**目标**：`ziwei/diting/`（独立子项目）

**操作**：
1. 创建 `ziwei/diting/` 目录
2. 移动代码
3. 更新 import 路径
4. 更新 CI/CD

### 3.2 天枢清理

**当前**：`tianshu/src/diting_client/`（存在独立客户端）

**目标**：删除或重构为使用太白 SDK

### 3.3 调用统一

所有模块调用天枢必须通过太白 SDK：
- 移除直接 HTTP 调用
- 使用 `taibai-go` / `taibai-python`

---

## 四、实施顺序

### Phase 1: 方案确认（文档对齐）
- [x] 明确模块结构
- [x] 定义调用关系
- [ ] 更新所有设计文档

### Phase 2: 谛听独立化
- [ ] 创建 `ziwei/diting/`
- [ ] 移动代码
- [ ] 修复 import 依赖
- [ ] 更新 CI/CD

### Phase 3: 天枢清理
- [ ] 移除 `tianshu/src/diting_client/`
- [ ] 或重构为使用太白 SDK

### Phase 4: 调用统一
- [ ] 检查所有直接调用天枢的代码
- [ ] 替换为太白 SDK 调用

---

## 五、关键文件变更

### 5.1 需要新增
- `ziwei/diting/` - 独立谛听项目

### 5.2 需要删除
- `xiezhi/cmd/diting/` - 合并到独立项目后删除
- `tianshu/src/diting_client/` - 清理或重构

### 5.3 需要修改
- `xiezhi/go.mod` - 移除谛听依赖
- `tianshu/...` - 移除直接调用，改用太白 SDK
