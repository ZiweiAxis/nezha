# 悟空谛听客户端 - Epic/Story 列表

**版本**：v1.0  
**日期**：2026-02-17  
**状态**：初稿

---

## 1. Epic 概述

本项目将谛听客户端功能拆分为 5 个 Epic：

| Epic ID | Epic 名称 | 描述 | 优先级 |
|---------|-----------|------|--------|
| E01 | 策略管理模块 | 策略接收、存储、评估 | P0 |
| E02 | 请求拦截模块 | 请求拦截、决策执行 | P0 |
| E03 | 任务挂起与审批 | 任务挂起、审批轮询、结果处理 | P0 |
| E04 | JIT 动态策略 | JIT 策略接收、应用、过期管理 | P1 |
| E05 | 集成与运维 | 配置管理、日志、监控集成 | P2 |

---

## 2. Epic 详细拆分

### Epic E01: 策略管理模块

**目标**：实现策略的接收、存储和本地评估功能

**依赖关系**：无

#### Stories

| Story ID | Story 名称 | 描述 | 验收标准 | 优先级 |
|----------|------------|------|----------|--------|
| E01-S01 | 策略存储结构设计 | 设计策略存储的数据结构和文件格式 | 1. 定义 Policy, PolicyRule 接口<br>2. 创建策略存储文件格式<br>3. 支持静态策略和 JIT 策略分离存储 | P0 |
| E01-S02 | PolicyManager 基础实现 | 实现策略管理器基础功能 | 1. 创建 PolicyManager 类<br>2. 实现 getPolicies() 方法<br>3. 实现 getPolicy(id) 方法 | P0 |
| E01-S03 | 策略同步 - 拉取实现 | 实现从谛听拉取策略的功能 | 1. 实现 fetchPolicies() 方法<br>2. 支持全量同步<br>3. 支持增量同步（可选） | P0 |
| E01-S04 | 策略同步 - 推送接收 | 实现接收谛听策略推送的功能 | 1. 创建策略推送回调 API<br>2. 接收并应用推送的策略<br>3. 策略版本管理 | P1 |
| E01-S05 | 本地策略评估引擎 | 实现策略评估核心逻辑 | 1. 实现 evaluate() 方法<br>2. 支持 action/resource 匹配<br>3. 支持通配符匹配<br>4. 返回 Allow/Deny/Review | P0 |
| E01-S06 | 策略版本管理 | 实现策略版本控制和回滚 | 1. 记录策略版本历史<br>2. 支持策略回滚<br>3. 冲突检测和解决 | P2 |

---

### Epic E02: 请求拦截模块

**目标**：实现请求拦截和决策执行功能

**依赖关系**：E01（策略管理模块）

#### Stories

| Story ID | Story 名称 | 描述 | 验收标准 | 优先级 |
|----------|------------|------|----------|--------|
| E02-S01 | RequestContext 定义 | 定义请求上下文数据结构 | 1. 定义 RequestContext 接口<br>2. 包含 subject/action/resource/environment<br>3. 支持请求 ID 和时间戳 | P0 |
| E02-S02 | Interceptor 基础实现 | 实现拦截器基础功能 | 1. 创建 Interceptor 类<br>2. 实现 intercept() 方法框架<br>3. 集成 PolicyManager | P0 |
| E02-S03 | 请求上下文提取 | 从 Agent 请求中提取上下文 | 1. 解析请求中的 action 类型<br>2. 提取 resource 信息<br>3. 获取 subject 身份信息 | P0 |
| E02-S04 | 决策执行 - Allow | 实现策略允许时的执行逻辑 | 1. 调用 Agent 执行请求<br>2. 记录执行日志<br>3. 返回执行结果 | P0 |
| E02-S05 | 决策执行 - Deny | 实现策略拒绝时的处理逻辑 | 1. 返回拒绝错误<br>2. 记录拒绝日志<br>3. 错误信息格式化 | P0 |
| E02-S06 | 决策执行 - Review | 实现需要审批时的转发逻辑 | 1. 将请求转发给任务挂起模块<br>2. 挂起当前请求<br>3. 返回挂起状态 | P0 |
| E02-S07 | 拦截器与 AgentManager 集成 | 将拦截器集成到 Agent 启动流程 | 1. 在 AgentManager 中集成拦截器<br>2. 配置拦截规则<br>3. 支持拦截启用/禁用配置 | P1 |

---

### Epic E03: 任务挂起与审批

**目标**：实现任务挂起、审批轮询和结果处理

**依赖关系**：复用现有 TaskSuspendManager

#### Stories

| Story ID | Story 名称 | 描述 | 验收标准 | 优先级 |
|----------|------------|------|----------|--------|
| E03-S01 | 任务挂起功能扩展 | 扩展现有 TaskSuspendManager | 1. 集成 RequestContext 到挂起任务<br>2. 支持任务优先级<br>3. 支持超时配置 | P0 |
| E03-S02 | 审批提交 | 实现提交审批请求到谛听 | 1. 实现 submitForApproval() 方法<br>2. 调用谛听 API<br>3. 返回 cheqId | P0 |
| E03-S03 | 审批状态轮询 | 实现审批状态轮询逻辑 | 1. 实现轮询机制<br>2. 支持可配置间隔<br>3. 支持超时处理 | P0 |
| E03-S04 | 审批结果处理 | 处理审批通过/拒绝的结果 | 1. 审批通过：恢复任务执行<br>2. 审批拒绝：返回拒绝错误<br>3. 审批超时：处理超时情况 | P0 |
| E03-S05 | 审批结果回调 API | 实现审批结果回调接口 | 1. 创建回调 API 端点<br>2. 支持即时结果推送<br>3. 减少轮询依赖 | P1 |
| E03-S06 | 任务持久化增强 | 增强任务持久化机制 | 1. 支持进程重启后恢复挂起任务<br>2. 任务状态完整保存<br>3. 清理已完成任务 | P1 |

---

### Epic E04: JIT 动态策略

**目标**：实现 JIT 临时策略的接收、应用和过期管理

**依赖关系**：E01（策略管理模块）

#### Stories

| Story ID | Story 名称 | 描述 | 验收标准 | 优先级 |
|----------|------------|------|----------|--------|
| E04-S01 | JIT 策略接收 | 实现接收 JIT 策略的功能 | 1. 创建 JIT 策略接收 API<br>2. 解析 JIT 策略格式<br>3. 验证策略有效性 | P1 |
| E04-S02 | JIT 策略存储 | 实现 JIT 策略的存储 | 1. 分离 JIT 策略存储<br>2. 支持策略 ID 查询<br>3. 记录创建时间和过期时间 | P1 |
| E04-S03 | JIT 策略应用 | 实现 JIT 策略的评估应用 | 1. JIT 策略优先级高于静态策略<br>2. 评估时合并 JIT 策略<br>3. 支持 JIT 策略条件匹配 | P1 |
| E04-S04 | JIT 策略过期管理 | 实现 JIT 策略自动过期 | 1. 定时检查过期策略<br>2. 过期后自动清理<br>3. 通知相关模块 | P1 |
| E04-S05 | JIT 策略手动清理 | 提供手动清理 JIT 策略的能力 | 1. 按策略 ID 清理<br>2. 按 subject 清理<br>3. 清理所有 JIT 策略 | P2 |

---

### Epic E05: 集成与运维

**目标**：提供配置管理、日志和监控集成

**依赖关系**：E01, E02, E03, E04

#### Stories

| Story ID | Story 名称 | 描述 | 验收标准 | 优先级 |
|----------|------------|------|----------|--------|
| E05-S01 | 配置管理 | 实现配置管理功能 | 1. 支持环境变量配置<br>2. 支持配置文件<br>3. 配置验证和默认值 | P1 |
| E05-S02 | 日志记录 | 实现统一的日志记录 | 1. 策略评估日志<br>2. 审批流程日志<br>3. 错误日志<br>4. 日志级别可配置 | P1 |
| E05-S03 | 指标暴露 | 实现 Prometheus 指标暴露 | 1. 策略评估次数<br>2. 审批通过/拒绝数<br>3. 平均审批时间<br>4. JIT 策略数量 | P2 |
| E05-S04 | 健康检查 | 实现健康检查接口 | 1. 与谛听的连接状态<br>2. 策略同步状态<br>3. 挂起任务数量 | P2 |
| E05-S05 | 单元测试 | 编写核心模块单元测试 | 1. PolicyManager 单元测试<br>2. Interceptor 单元测试<br>3. TaskSuspendManager 单元测试 | P1 |

---

## 3. Epic/Story 依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                    Epic 依赖关系                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  E01 (策略管理)  ─────────────────────────────────────────┐                      │
│     │                                                      │                      │
│     ├── E01-S01 (策略存储结构)                             │                      │
│     ├── E01-S02 (PolicyManager)                           │                      │
│     ├── E01-S03 (策略拉取同步)    ───┐                     │                      │
│     ├── E01-S04 (策略推送接收)       │                     │                      │
│     ├── E01-S05 (本地评估引擎) ──────┼───▶ E02 (请求拦截)   │                      │
│     └── E01-S06 (策略版本管理)       │     │                │                      │
│                                      │     ├── E02-S01     │                      │
│                                      │     ├── E02-S02     │                      │
│                                      │     ├── E02-S03     │                      │
│                                      │     ├── E02-S04     │                      │
│                                      │     ├── E02-S05     │                      │
│                                      │     ├── E02-S06     │                      │
│                                      │     └── E02-S07     │                      │
│                                      │                      │                      │
│  E04 (JIT 动态策略) ◀─────────────────┘                      │                      │
│     │                                                      │                      │
│     ├── E04-S01 (JIT 接收) ──────┐                        │                      │
│     ├── E04-S02 (JIT 存储) ──────┼────────────────────────┘                      │
│     ├── E04-S03 (JIT 应用) ──────┤                                          │
│     ├── E04-S04 (JIT 过期) ──────┤                                          │
│     └── E04-S05 (JIT 清理) ──────┘                                          │
│                                                                                  │
│  E03 (任务挂起) ────────────────────────────────────────────────────────────▶ E05 │
│     │                                                                            │
│     ├── E03-S01 (挂起功能扩展)                                                  │
│     ├── E03-S02 (审批提交)                                                     │
│     ├── E03-S03 (审批轮询)                                                     │
│     ├── E03-S04 (结果处理)                                                     │
│     ├── E03-S05 (回调 API)                                                     │
│     └── E03-S06 (持久化增强)                                                   │
│                                                                                  │
│  E05 (集成运维)                                                                │
│     ├── E05-S01 (配置管理)                                                     │
│     ├── E05-S02 (日志记录)                                                     │
│     ├── E05-S03 (指标暴露)                                                     │
│     ├── E05-S04 (健康检查)                                                     │
│     └── E05-S05 (单元测试)                                                     │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 迭代计划建议

### Sprint 1: 基础能力建设

**目标**：完成 E01 核心功能

| Story | 预估工作量 |
|--------|------------|
| E01-S01 策略存储结构设计 | 1d |
| E01-S02 PolicyManager 基础实现 | 2d |
| E01-S05 本地策略评估引擎 | 3d |

**交付物**：本地策略评估能力

### Sprint 2: 拦截与挂起

**目标**：完成 E02 和 E03 核心功能

| Story | 预估工作量 |
|--------|------------|
| E02-S01 RequestContext 定义 | 0.5d |
| E02-S02 Interceptor 基础实现 | 1d |
| E02-S03 请求上下文提取 | 1d |
| E02-S04~06 决策执行 | 2d |
| E03-S01~04 任务挂起与审批 | 3d |

**交付物**：完整的请求拦截和审批流程

### Sprint 3: JIT 与集成

**目标**：完成 E04 和 E05 功能

| Story | 预估工作量 |
|--------|------------|
| E04-S01~04 JIT 动态策略 | 3d |
| E05-S01~02 配置与日志 | 2d |
| E05-S05 单元测试 | 2d |

**交付物**：JIT 策略支持和运维能力

---

## 5. 验收标准汇总

### 核心验收标准

| Epic | 验收标准 |
|------|----------|
| E01 | 1. 策略可以存储到本地文件<br>2. 本地策略评估延迟 < 10ms<br>3. 支持 Cedar JSON 格式 |
| E02 | 1. 可以拦截 Agent 请求<br>2. 正确返回 Allow/Deny/Review 决策<br>3. 决策正确执行 |
| E03 | 1. 可以挂起任务并等待审批<br>2. 审批状态轮询正确工作<br>3. 审批超时处理正确 |
| E04 | 1. 可以接收和存储 JIT 策略<br>2. JIT 策略正确参与评估<br>3. 过期策略自动清理 |
| E05 | 1. 配置可以通过环境变量加载<br>2. 日志正确记录<br>3. 核心功能有单元测试覆盖 |

---

## 6. 相关文档

- [PRD-谛听客户端](./PRD-谛听客户端.md)
- [技术方案-谛听客户端架构设计](./技术方案-谛听客户端架构设计.md)
- [网关拦截流程设计-提案](../../docs/discussing/网关拦截流程设计-提案.md)

---

**文档结束**
