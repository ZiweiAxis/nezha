# 再次验证条件检查

**目的**：在「任务都已完成」的前提下，检查各子项目与部署是否具备**再一次端到端验证**的条件。验证目标：Element 使用 hulk 身份，悟空启动 Agent 注册 → 谛听推送审批给 hulk → hulk 确认后谛听放行、天枢完成注册并下发身份；hulk 下发治理指令 → Agent 执行触发谛听规则 → 审批推 hulk → hulk 确认谛听放行。

---

## 1. 验证目标简述

| 阶段 | 内容 |
|------|------|
| 注册 | 悟空启动 Agent → 向天枢注册（身份与基本信息）→ 谛听监听并产生审批申请 → 推送到 hulk（Matrix 房间）→ hulk 在 Element 确认 → 谛听放行 → 天枢完成注册并下发身份 |
| 治理 | hulk 在 Element 下发指令给 Agent → Agent 执行并触发谛听规则 → 谛听推送审批到 Matrix 房间 → hulk 确认 → 谛听放行 |

---

## 2. 各环节验证条件与具备情况

### 2.1 部署 / 环境

| 验证条件 | 具备情况 |
|----------|----------|
| 一键启动（Synapse + 天枢 + 谛听） | ✅ `deploy/docker-compose.integration.yml`、`deploy/README.md` 已就绪 |
| NAS Synapse 或本机 Synapse；REGISTRATION_SHARED_SECRET 与 NAS 一致 | ✅ `deploy/NAS-Synapse-配置说明.md`、`env.example` 已约定 |
| NATIVE_DEMO_INVITE_USER（如 @hulk:xyin.oicp.net） | ✅ 在 `.env` 中配置即可；native-demo 可自动邀请 |
| DELIVERY_ROOM_ID（审批发往的 Matrix 房间） | ✅ 在 `.env` 中配置 native-demo 返回的 room_id 即可 |

**结论**：部署与环境具备再次验证条件。

---

### 2.2 天枢（tianshu）

| 验证条件 | 具备情况 |
|----------|----------|
| POST /api/v1/delivery/approval-request（谛听可调，投递到 DELIVERY_ROOM_ID） | ✅ 已实现 |
| DELIVERY_ROOM_ID 配置生效，审批消息发到该 Matrix 房间 | ✅ 已支持 |
| send_agent_message（向 Agent Matrix 房间发消息） | ✅ 已有 |
| GET /api/v1/delivery/native-demo（创建房间、投递一条审批、可选邀请用户） | ✅ 已有 |
| 小谛身份（审批消息展示为来自「小谛」） | ⏳ 待实现 T1，**不阻塞**「审批进房间」验证 |

**结论**：天枢具备再次验证条件（小谛为体验优化，非必须）。

**若调用 `POST /api/v1/delivery/approval-request` 返回 404**：多为天枢镜像为旧版本，未包含该路由。请重建镜像：`docker compose -f deploy/docker-compose.integration.yml build tianshu`（或 `podman-compose` 对应命令），再 `up -d tianshu`。

---

### 2.3 谛听（diting）

| 验证条件 | 具备情况 |
|----------|----------|
| CHEQ 创建后，将审批请求投递到天枢（调用 POST /api/v1/delivery/approval-request） | ✅ **已实现**。`internal/delivery/tianshu` 在 CHEQ 创建后调用天枢 `POST /api/v1/delivery/approval-request`；需在配置中启用 `delivery.tianshu.enabled` 并配置 `base_url`（或环境变量 `DITING_TIANSHU_ENABLED=true`、`DITING_TIANSHU_BASE_URL`）。 |
| 审批结果回调（/cheq/approve） | ✅ 已有 |

**结论**：谛听具备再次验证条件；启用天枢投递后即可跑通「危险操作 → Matrix 房间审批」。

---

### 2.4 悟空（wukong）

| 验证条件 | 具备情况 |
|----------|----------|
| 调用天枢 POST /api/v1/agents/register（owner_id、agent_display_id） | ✅ 已实现 |
| 宿主机可配置 TIANSHU_API_URL、WUKONG_OWNER_ID | ✅ 已支持；Element+hulk 时建议 WUKONG_OWNER_ID 与天枢/谛听约定一致 |
| 启动的 Agent 能连天枢与谛听（文档或 env 透传） | ✅ 见 `wukong/docs/悟空-方案相关待办.md` W3 |

**结论**：悟空具备再次验证条件。

---

### 2.5 太白 / 验证用 Agent

| 验证条件 | 具备情况 |
|----------|----------|
| 能接收天枢 Matrix 房间消息（协议/SDK） | ✅ 协议与 SDK 已就绪 |
| 执行操作经谛听（如 /auth/exec）以触发审批 | ✅ 视验证用 agent 实现；谛听侧 /auth/exec、CHEQ 已有 |

**结论**：依赖具体验证用 Agent 实现；协议与谛听侧能力已具备。

---

## 3. 汇总：是否具备再次验证条件

| 环节 | 是否具备 | 说明 |
|------|----------|------|
| 部署/环境 | ✅ 具备 | compose、env、NAS 说明已就绪 |
| 天枢 | ✅ 具备 | approval-request、DELIVERY_ROOM_ID、native-demo 已有 |
| 谛听 | ✅ 具备 | 天枢投递渠道已实现（`delivery/tianshu`），启用后即可 |
| 悟空 | ✅ 具备 | 注册、配置、文档已就绪 |
| 太白/Agent | ✅ 具备 | 协议与消费方式已约定，具体 agent 按需实现 |

**结论**：各环节均具备再次验证条件。启用谛听天枢投递（`DITING_TIANSHU_ENABLED=true`、`DITING_TIANSHU_BASE_URL`，并配置天枢 `DELIVERY_ROOM_ID`）后，可完整跑通「危险操作 → Matrix 房间审批」的端到端验证。

---

## 4. 启用天枢投递（谛听）

- 在 `.env` 中设置：`DITING_TIANSHU_ENABLED=true`，`DITING_TIANSHU_BASE_URL=http://tianshu:8080`（compose 内）；宿主机联调时可为 `http://localhost:8082`。
- 天枢侧配置 `DELIVERY_ROOM_ID` 为已加入的 Matrix 房间 ID（可与 native-demo 返回的 room_id 一致）。
- 参考：`deploy/危险操作与Matrix审批验证.md`、`deploy/env.example`。

---

## 5. 引用

- 危险操作与 Matrix 审批验证：`deploy/危险操作与Matrix审批验证.md`
- 原生渠道验证步骤：`deploy/原生渠道验证步骤.md`
- 天枢投递与消费渠道：`docs/open/technical/天枢投递与消费渠道.md`
