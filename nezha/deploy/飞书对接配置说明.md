# 飞书对接配置说明

**目的**：用飞书企业自建应用（机器人）的 App ID 与 App Secret，让**天枢**能向飞书推送消息、审批卡片并接收回调。  
**架构要点**：飞书投递**仅经天枢**；用户/审批人信息均在天枢，谛听不直连飞书。

---

## 1. 架构：飞书投递经天枢

根技术方案（`docs/open/technical/紫微智能体治理基础设施-技术方案.md`）约定：

- **企业 IM 适配器（飞书/钉钉/企微）归属天枢**，审批触达与 IM 回调均由天枢处理。
- 谛听负责策略与 CHEQ 决策；需要向用户发审批卡片时，**谛听向天枢发起审批请求**，由**天枢**根据身份与用户信息向飞书投递卡片；用户点击后飞书回调**天枢**，天枢再把审批结果回传谛听。

因此：

- **只需在天枢侧配置飞书凭证**（`FEISHU_APP_ID`、`FEISHU_APP_SECRET`）。
- **谛听不配置飞书**，也不直接调用飞书 API；当前谛听代码中若存在独立飞书投递实现，视为历史/兼容形态，目标架构为「谛听 → 天枢 → 飞书」。

---

## 2. 安全约定：不要泄露 Secret

- **App Secret 不要**写在聊天记录、代码库或公开文档里。
- **推荐做法**：只在本机仓库根目录的 **`.env`** 中填写；`.env` 已在 `.gitignore` 中，不会被提交到 git。
- 你可以把 **App ID** 发给我（用于检查配置是否生效）；**Secret 请仅写在 .env 里**，不要粘贴到对话中。

---

## 3. 在 .env 里填什么

在 ziwei 仓库根目录的 `.env` 中（没有则 `cp deploy/env.example .env`）填写：

```bash
# 飞书机器人（仅天枢使用，用于向飞书投递消息与审批卡片）
FEISHU_APP_ID=你的AppID
FEISHU_APP_SECRET=你的AppSecret
```

- **天枢**：使用上述凭证调用飞书 API，完成注册确认卡片、消息桥接、以及**代谛听投递的审批卡片**（审批人/接收人由天枢侧用户信息解析）。
- **谛听**：不读取飞书凭证；审批触达通过调用天枢的「审批投递」接口（或后续约定的协议）由天枢统一投递。

---

## 4. 飞书后台需要配置的内容

在 [飞书开放平台](https://open.feishu.cn/) 你的应用里确认：

| 项 | 说明 |
|----|------|
| **权限** | 发送消息、接收消息、获取用户信息等（按天枢文档所需权限勾选）。 |
| **事件订阅** | 若需要「用户发消息 → 天枢收到」：请求 URL 指向**天枢**对外暴露的飞书事件回调。 |
| **消息与卡片回调** | 卡片内「通过/拒绝」点击后，请求 URL 指向**天枢**对外暴露的回调（天枢再转交谛听或更新 CHEQ）。 |

**本地/内网调试**：若天枢只跑在本地（localhost），飞书无法直接回调，需用内网穿透（如 ngrok、frp）把天枢的回调 URL 暴露为公网地址再填到飞书后台。

---

## 5. 一键启动如何读到飞书配置

- 启动时加载仓库根目录的 **`.env`**（例如：`docker compose -f deploy/docker-compose.integration.yml --env-file .env up -d` 或 podman-compose 同理）。
- **天枢**：compose 已将 `FEISHU_APP_ID`、`FEISHU_APP_SECRET` 传入天枢容器；仅天枢需要这两项。
- **谛听**：不传入飞书相关环境变量。

填好 .env 后**重启编排**即可生效。

---

## 6. 如何确认已生效

- **天枢**：若未配置飞书，启动日志会有类似「飞书未配置 FEISHU_APP_ID / FEISHU_APP_SECRET」；配置正确后该告警消失，天枢可正常调用飞书发消息接口。
- 谛听侧无需也不应配置飞书凭证；审批流程以「谛听 → 天枢 → 飞书」为准。

如需，我可以根据你提供的 **App ID**（不包含 Secret）帮你写一份天枢侧「检查清单」或一起过一遍日志。
