# 悟空谛听客户端 - 技术方案架构设计

**版本**：v1.0  
**日期**：2026-02-17  
**状态**：初稿

---

## 1. 系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                 紫微平台                                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌───────────┐ │
│  │    天枢     │────▶│    谛听     │◀────│    悟空     │◀────│   Agent   │ │
│  │ (通信枢纽)   │     │ (策略+审批)  │     │ (拦截器)    │     │  (执行器)  │ │
│  └─────────────┘     └──────┬──────┘     └──────┬──────┘     └───────────┘ │
│         │                    │                   │                    │    │
│         │              策略下发 │           拦截请求│              执行结果│    │
│         │                    │                   │                    │    │
│         │                    │                   ▼                    │    │
│         │                    │          ┌────────────────┐              │    │
│         │                    │          │ DitingClient   │              │    │
│         │                    │          │ ┌────────────┐ │              │    │
│         │                    │          │ │PolicyManager│ │             │    │
│         │                    │          │ └────────────┘ │              │    │
│         │                    │          │ ┌────────────┐ │              │    │
│         │                    │          │ │Interceptor │ │              │    │
│         │                    │          │ └────────────┘ │              │    │
│         │                    │          │ ┌────────────┐ │              │    │
│         │                    │          │ │TaskSuspend │ │             │    │
│         │                    │          │ │  Manager   │ │              │    │
│         │                    │          │ └────────────┘ │              │    │
│         │                    │          └────────────────┘              │    │
└─────────┴────────────────────┴──────────────────────────────────────────┘    │
                                                                                │
                          谛听服务                          悟空客户端              │
```

### 1.2 模块设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              悟空客户端 (Wukong)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         DitingClient (入口)                          │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │                     IDitingClient (接口)                        │ │   │
│  │  │  - connect()                                                    │ │   │
│  │  │  - disconnect()                                                │ │   │
│  │  │  - evaluatePolicy(request)                                     │ │   │
│  │  │  - submitForApproval(request)                                  │ │   │
│  │  │  - getApprovalStatus(cheqId)                                  │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                       │
│          ┌───────────────────────────┼───────────────────────────┐          │
│          │                           │                           │          │
│          ▼                           ▼                           ▼          │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────┐ │
│  │  PolicyManager  │    │   Interceptor   │    │   TaskSuspendManager   │ │
│  │  (策略管理)      │    │    (拦截器)     │    │     (任务挂起)         │ │
│  ├─────────────────┤    ├─────────────────┤    ├─────────────────────────┤ │
│  │ - policies      │    │ - evaluate()    │    │ - suspend()             │ │
│  │ - fetchPolicies│    │ - intercept()  │    │ - resume()              │ │
│  │ - applyPolicy()│    │ - forward()    │    │ - pollStatus()          │ │
│  │ - addJitPolicy │    │ - allow()      │    │ - waitForCompletion()  │ │
│  │ - cleanupExpired│   │ - deny()       │    │ - listTasks()           │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────┘ │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                           存储层                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │   │
│  │  │ PolicyStore │  │ TaskStore   │  │ IdentityStore│ │  LogStore  │  │   │
│  │  │ (策略存储)   │  │ (任务存储)  │  │ (身份存储)  │  │ (日志存储)  │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 核心模块设计

### 2.1 DitingClient（谛听客户端入口）

**职责**：
- 统一管理与其他模块的连接
- 提供统一的策略评估和审批提交接口
- 管理生命周期（连接/断开）

**接口设计**：

```typescript
interface IDitingClient {
  /**
   * 连接到谛听服务
   */
  connect(): Promise<void>;
  
  /**
   * 断开连接
   */
  disconnect(): void;
  
  /**
   * 评估策略（本地评估）
   * @param request 请求上下文
   * @returns 决策结果
   */
  evaluatePolicy(request: RequestContext): Promise<PolicyDecision>;
  
  /**
   * 提交审批请求
   * @param request 请求上下文
   * @returns 审批请求 ID
   */
  submitForApproval(request: RequestContext): Promise<string>;
  
  /**
   * 获取审批状态
   * @param cheqId 审批请求 ID
   * @returns 审批状态
   */
  getApprovalStatus(cheqId: string): Promise<ApprovalStatus>;
  
  /**
   * 获取策略管理器
   */
  getPolicyManager(): IPolicyManager;
  
  /**
   * 获取任务挂起管理器
   */
  getTaskSuspendManager(): ITaskSuspendManager;
}
```

### 2.2 PolicyManager（策略管理器）

**职责**：
- 从谛听获取并同步策略
- 存储和管理本地策略
- JIT 策略的添加和过期清理
- 策略版本管理

**接口设计**：

```typescript
interface IPolicyManager {
  /**
   * 获取所有策略
   */
  getPolicies(): Policy[];
  
  /**
   * 获取指定策略
   */
  getPolicy(id: string): Policy | undefined;
  
  /**
   * 从谛听同步策略
   */
  syncPolicies(): Promise<void>;
  
  /**
   * 添加 JIT 临时策略
   */
  addJitPolicy(policy: Policy): void;
  
  /**
   * 清理过期策略
   */
  cleanupExpiredPolicies(): void;
  
  /**
   * 评估策略
   */
  evaluate(request: RequestContext): Promise<PolicyDecision>;
}

/**
 * 策略决策结果
 */
enum PolicyDecision {
  ALLOW = 'allow',    // 允许执行
  DENY = 'deny',      // 拒绝执行
  REVIEW = 'review'  // 需要审批
}
```

**策略存储格式**：

```json
{
  "policies": [
    {
      "id": "pol-001",
      "version": "1.0",
      "type": "static",
      "rules": [
        {
          "id": "rule-001",
          "effect": "allow",
          "action": "file:read",
          "resource": "file:///home/**"
        }
      ],
      "createdAt": "2026-02-17T00:00:00Z",
      "scope": {
        "subjects": ["did:agent:*"]
      }
    }
  ],
  "jitPolicies": [
    {
      "id": "jit-001",
      "type": "jit",
      "rules": [...],
      "expiresAt": "2026-02-17T01:00:00Z"
    }
  ],
  "lastSyncAt": "2026-02-17T10:30:00Z"
}
```

### 2.3 Interceptor（拦截器）

**职责**：
- 拦截 Agent 的请求
- 调用 PolicyManager 进行本地评估
- 根据决策结果执行相应操作

**工作流程**：

```
Agent 请求
    │
    ▼
┌─────────────────┐
│  Interceptor    │
│  接收请求       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  提取上下文      │
│  - action       │
│  - resource     │
│  - subject      │
│  - environment  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  PolicyManager  │
│  本地策略评估   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
 Allow      Deny/Review
    │         │
    ▼         ▼
┌────────┐ ┌─────────────────┐
│ 执行   │ │ 转发谛听审批   │
│ 返回结果│ │ 或直接拒绝     │
└────────┘ └─────────────────┘
```

### 2.4 TaskSuspendManager（任务挂起管理器）

（见现有实现 TaskSuspendManager.ts）

扩展点：
- 支持更多任务状态
- 支持任务优先级
- 支持超时自定义

---

## 3. 数据模型

### 3.1 请求上下文

```typescript
interface RequestContext {
  id: string;
  timestamp: Date;
  subject: {
    did: string;
    name: string;
    type: string;
  };
  action: {
    type: string;
    params: Record<string, any>;
  };
  resource: {
    type: string;
    identifier: string;
    attributes?: Record<string, any>;
  };
  environment: {
    sourceIp?: string;
    userAgent?: string;
    [key: string]: any;
  };
}
```

### 3.2 审批请求

```typescript
interface ApprovalRequest {
  id: string;
  cheqId: string;           // 谛听的 CHEQ ID
  request: RequestContext;
  status: ApprovalRequestStatus;
  createdAt: Date;
  approvedAt?: Date;
  rejectedAt?: Date;
  approvedBy?: string;
  rejectedReason?: string;
  jitPolicy?: Policy;       // 审批通过的 JIT 策略
}

enum ApprovalRequestStatus {
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected',
  TIMEOUT = 'timeout'
}
```

### 3.3 策略

```typescript
interface Policy {
  id: string;
  version: string;
  type: PolicyType;
  rules: PolicyRule[];
  createdAt: Date;
  expiresAt?: Date;
  scope?: PolicyScope;
  metadata?: Record<string, any>;
}

enum PolicyType {
  STATIC = 'static',   // 静态策略
  JIT = 'jit'         // JIT 临时策略
}

interface PolicyRule {
  id: string;
  effect: 'allow' | 'deny';
  priority?: number;
  principal?: string;      // 支持通配符 did:agent:*
  action: string;           // 如 file:read, api:call
  resource: string;         // 支持通配符 file:///home/**
  conditions?: {
    time?: { start?: string; end?: string };
    ip?: { allow?: string[]; deny?: string[] };
    [key: string]: any;
  };
}

interface PolicyScope {
  subjects?: string[];
  resources?: string[];
  actions?: string[];
}
```

---

## 4. API 设计

### 4.1 悟空 → 谛听 API

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/policies` | GET | 获取策略列表 |
| `/api/v1/policies/sync` | POST | 同步策略 |
| `/api/v1/approval/submit` | POST | 提交审批请求 |
| `/api/v1/approval/:cheqId/status` | GET | 获取审批状态 |
| `/api/v1/jit/policy` | POST | 接收 JIT 策略 |

### 4.2 谛听 → 悟空 API（回调）

| API | 方法 | 说明 |
|-----|------|------|
| `/api/v1/internal/policy/update` | POST | 策略更新推送 |
| `/api/v1/internal/approval/result` | POST | 审批结果回调 |

---

## 5. 与谛听的对接方式

### 5.1 连接建立

```
悟空 ─────────────────────────────────────────────────────────────▶ 谛听
  │                                                               │
  │  1. 启动时从配置或环境变量获取 DITING_API_BASE                │
  │                                                               │
  │  2. 建立 HTTP/HTTPS 连接                                     │
  │     - 使用 API Key 认证                                       │
  │     - 支持 OAuth2 (未来)                                      │
  │                                                               │
  │  3. 首次同步策略                                              │
  │     GET /api/v1/policies                                      │
  │                                                               │
  │◀───────────────────────────────────────────────────────────── │
  │                                                               │
  │  返回策略列表                                                │
```

### 5.2 策略同步机制

**方式一：主动拉取**
- 悟空启动时全量同步
- 定时增量同步（默认 5 分钟）

**方式二：被动推送**
- 谛听策略变更时主动推送给悟空
- 需要悟空暴露回调接口

**推荐**：两种方式结合，启动时拉取 + 定时同步 + 被动接收推送

### 5.3 审批流程

```
悟空                              谛听                          审批人
  │                                │                              │
  │  提交审批请求                   │                              │
  │ ──────────────────────────────▶│                              │
  │                                │  创建 CHEQ                   │
  │                                │ ────────────────────────────▶│
  │                                │                              │ 审批操作
  │                                │◀──────────────────────────────│
  │                                │                              │
  │  轮询状态                       │                              │
  │ ──────────────────────────────▶│                              │
  │◀────────────────────────────── │                              │
  │                                │                              │
  │  (重复直到审批完成)             │                              │
  │                                │                              │
  │  审批通过 + JIT 策略            │                              │
  │◀────────────────────────────── │                              │
  │                                │                              │
```

---

## 6. 配置设计

### 6.1 环境变量

| 变量名 | 必填 | 默认值 | 说明 |
|--------|------|--------|------|
| `DITING_API_BASE` | 是 | - | 谛听服务地址 |
| `DITING_API_KEY` | 是 | - | API 认证密钥 |
| `DITING_POLICY_SYNC_INTERVAL_MS` | 否 | 300000 | 策略同步间隔（5分钟） |
| `DITING_APPROVAL_POLL_INTERVAL_MS` | 否 | 3000 | 审批轮询间隔（3秒） |
| `DITING_APPROVAL_TIMEOUT_MS` | 否 | 600000 | 审批超时（10分钟） |
| `DITING_JIT_DEFAULT_TTL_MS` | 否 | 3600000 | JIT 策略默认 TTL（1小时） |

### 6.2 配置文件

```yaml
diting:
  apiBase: "https://diting.example.com"
  apiKey: "${DITING_API_KEY}"
  policy:
    syncIntervalMs: 300000
    storagePath: ".wukong/policies.json"
  approval:
    pollIntervalMs: 3000
    timeoutMs: 600000
  jit:
    defaultTtlMs: 3600000
    storagePath: ".wukong/jit-policies.json"
```

---

## 7. 错误处理

### 7.1 错误类型

| 错误码 | 说明 | 处理方式 |
|--------|------|----------|
| `DITING_CONNECTION_FAILED` | 无法连接到谛听 | 使用本地缓存策略，继续工作 |
| `DITING_POLICY_SYNC_FAILED` | 策略同步失败 | 记录日志，使用现有策略 |
| `DITING_APPROVAL_TIMEOUT` | 审批超时 | 标记任务为超时，通知 Agent |
| `DITING_INVALID_POLICY` | 无效策略 | 忽略该策略，记录警告 |
| `DITING_JIT_EXPIRED` | JIT 策略已过期 | 清理策略，通知 Agent |

### 7.2 降级策略

| 场景 | 降级行为 |
|------|----------|
| 谛听不可达 | 使用本地缓存的策略继续评估 |
| 策略同步失败 | 保持现有策略，下次重试 |
| 审批超时 | 任务标记为超时，返回错误给 Agent |

---

## 8. 部署架构

### 8.1 单实例部署

```
┌─────────────────────────────────────────┐
│              Wukong 进程                 │
│  ┌───────────────────────────────────┐  │
│  │         DitingClient              │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────┐  │  │
│  │  │Policy   │ │Interceptor│ │Task│  │  │
│  │  │Manager  │ │          │ │Sus-│  │  │
│  │  │         │ │          │ │pend│  │  │
│  │  └─────────┘ └─────────┘ └─────┘  │  │
│  └───────────────────────────────────┘  │
│                      │                    │
│                      ▼                    │
│  ┌───────────────────────────────────┐  │
│  │     本地存储 (.wukong/)            │  │
│  │  - policies.json                   │  │
│  │  - jit-policies.json              │  │
│  │  - suspended-tasks.json           │  │
│  │  - identities.json                │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
          │
          │ HTTPS
          ▼
┌─────────────────────────────────────────┐
│            谛听服务                       │
│  - 策略管理                              │
│  - 审批处理                              │
│  - JIT 策略生成                          │
└─────────────────────────────────────────┘
```

### 8.2 多实例部署

每个悟空实例独立运行，拥有独立的本地策略存储。策略同步确保各实例策略一致性。

---

## 9. 相关文档

- [PRD-谛听客户端](./PRD-谛听客户端.md)
- [网关拦截流程设计-提案](../../docs/discussing/网关拦截流程设计-提案.md)
- [太白原理](../../docs/open/technical/太白原理.md)
- [太白对接 Claude Code CLI 方案](../../docs/open/technical/太白对接Claude-Code-CLI方案.md)

---

**文档结束**
