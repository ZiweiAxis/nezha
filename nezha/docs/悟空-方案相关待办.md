# 悟空：与「Element + hulk 端到端」目标相关的待办

**目的**：在「Element 用 hulk 身份：悟空启动 Agent 注册 → 谛听推送审批给 hulk → hulk 确认后谛听放行、天枢完成注册并下发身份；hulk 下发治理指令 → Agent 执行触发谛听规则 → 审批推 hulk、hulk 确认谛听放行」这一目标下，悟空需要完成的具体任务（若有）。

**依据**：`ziwei/docs/open/technical/紫微平台各模块集成方案.md`、`ziwei/deploy/危险操作与Matrix审批验证.md`、`ziwei/deploy/原生渠道验证步骤.md`。

---

## 1. 目标流程简述

| 阶段 | 步骤 |
|------|------|
| **注册** | 悟空启动 Agent → Agent 声明身份与基本信息 → 向天枢注册 → 谛听监听并产生「申请」→ 推送给 hulk（Matrix 房间）→ hulk 在 Element 确认 → 谛听放行 → 天枢完成注册并下发身份信息 |
| **治理** | hulk 在 Element 下发治理指令给该 Agent → Agent 执行操作并触发谛听规则 → 谛听推送审批给 hulk → hulk 确认 → 谛听放行 |

---

## 2. 悟空当前已具备

- 调用天枢 **POST /api/v1/agents/register**（body: `owner_id`、`agent_display_id`），**POST /api/v1/agents/heartbeat**。
- `owner_id` 来自环境变量 **WUKONG_OWNER_ID**（默认 `wukong-default-owner`）。
- 宿主机 CLI，通过 **TIANSHU_API_URL**（如 `http://localhost:8082`）与天枢联通。

---

## 3. 悟空需要做或约定的事（按目标）

| 序号 | 任务 | 说明 | 验收 |
|------|------|------|------|
| W1 | **Owner 标识与文档** | Element + hulk 场景下，审批推送到天枢配置的 **DELIVERY_ROOM_ID**（hulk 所在 Matrix 房间）。悟空注册时传的 **owner_id** 用于天枢/谛听关联「谁审批」；若天枢用 owner 映射 Matrix 房间则需一致。**动作**：在 README 或部署文档中约定：用 Element+hulk 做端到端时，设置 `WUKONG_OWNER_ID` 为 hulk 的标识（如 `hulk` 或 `@hulk:xyin.oicp.net`），与天枢/谛听侧约定一致。若当前仅用 DELIVERY_ROOM_ID 且 hulk 即在该房间，则无需改代码，仅文档约定即可。 | 文档可查、与 deploy 文档一致 |
| W2 | **注册若返回「待审批」** | 若天枢将来支持「注册需人工审批」并返回 `requires_approval: true` 或 `status: pending`，悟空需：将该身份视为待审批、不视为注册完成；可轮询 天枢/谛听 审批状态，审批通过后再拉取或刷新身份信息。当前天枢直接返回成功，悟空可暂不实现轮询；**任务**：在 天枢 提供 pending 语义后，悟空实现「注册待审批」的处理与可选轮询（或文档标明由用户手动重试）。 | 天枢有 pending 后，悟空能处理或文档说明 |
| W3 | **启动的 Agent 能收指令、走谛听** | hulk 在 Element 下发指令给 Agent、Agent 执行并触发谛听规则时，需：(1) Agent 能收到 Matrix 房间内 hulk 的指令（由天枢/太白/房间归属保证）；(2) Agent 执行敏感操作时经谛听（如 /auth/exec）。**悟空** 只负责启动 Agent 进程；需保证启动时传入 Agent 所需环境变量（如 **TIANSHU_API_URL**、**DITING_** 相关地址，若 Agent 需连谛听）。**动作**：在文档中说明「Element 端到端」时，悟空启动的 Agent 需配置哪些 env（如 TIANSHU_API_URL、DITING_PROXY 或 DITING_AUDIT_URL）；或悟空在 `wukong claude` 等命令中透传这些 env（若尚未透传）。 | 文档或代码：Agent 被悟空启动后能连天枢与谛听 |

---

## 4. 小结

| 问题 | 结论 |
|------|------|
| 悟空要不要改代码？ | 当前以**文档与配置约定**为主（W1、W3）；若天枢后续支持注册待审批，则需实现或约定 W2。 |
| 与谛听/天枢的分工 | 谛听：接天枢投递、审批推 Matrix；天枢：小谛身份、DELIVERY_ROOM_ID、注册/审批闭环；悟空：正确传 owner_id、启动的 Agent 可连天枢与谛听、必要时处理 pending 注册。 |

---

## 5. 引用

- 紫微平台各模块集成方案：`ziwei/docs/open/technical/紫微平台各模块集成方案.md`
- 危险操作与 Matrix 审批验证：`ziwei/deploy/危险操作与Matrix审批验证.md`
- 原生渠道验证步骤：`ziwei/deploy/原生渠道验证步骤.md`
- 主仓执行清单（悟空节）：`ziwei/_bmad-output/planning-artifacts/下一步执行清单.md`
