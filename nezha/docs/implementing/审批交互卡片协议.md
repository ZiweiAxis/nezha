# 审批交互卡片协议

## 1. 概述

本文档定义了紫微系统中獬豸审批场景的交互卡片协议，基于 T1-T3 设计方案实现审批流程的人机交互。

### 1.1 设计目标

- 统一各平台的审批卡片格式
- 标准化按钮点击事件与响应处理
- 支持批准/拒绝等审批操作

### 1.2 角色分工

| 组件 | 职责 |
|------|------|
| **獬豸** | 策略评估、审批决策、CHEQ 管理 |
| **太白** | 消息卡片封装、交互协议定义 |
| **天枢** | 消息路由、Matrix 投递 |

---

## 2. T1-T3 现有方案回顾

### 2.1 T1: 统一点击事件模型

当用户点击按钮时，系统传递以下统一事件结构：

```json
{
  "action_key": "approve",
  "action_value": {},
  "card_id": "card-xxx",
  "user_id": "did:human:hulk",
  "timestamp": 1700000000,
  "metadata": {}
}
```

**字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| action_key | string | 按钮唯一标识，如 `approve`、`reject` |
| action_value | object | 按钮携带的业务数据 |
| card_id | string | 消息卡片 ID，用于关联响应 |
| user_id | string | 点击用户 DID |
| timestamp | int64 | 时间戳（毫秒） |
| metadata | object | 扩展元信息 |

### 2.2 T2: 统一响应接口

业务层通过统一的 Context 接口执行响应：

```python
# 更新卡片
context.updateCard(card_data)

# 跳转链接
context.redirectUrl(url)
```

**底层适配**：
- Matrix 等即时响应型：直接更新消息
- 飞书/钉钉等 API 调用型：先 ACK 再调用平台 API

### 2.3 T3: 太白卡片格式

```json
{
  "msgtype": "tianshu.card",
  
  "msg_id": "msg-xxx",
  "sender": {
    "did": "did:agent:xiezhi",
    "display_name": "獬豸"
  },
  "receiver": {
    "did": "did:human:hulk"
  },
  
  "payload": {
    "card_type": "approval",
    "title": "审批请求",
    "content": "...",
    "actions": [
      {"id": "approve", "label": "批准"},
      {"id": "reject", "label": "拒绝"}
    ],
    "metadata": {}
  }
}
```

---

## 3. 审批卡片协议详解

### 3.1 审批请求卡片格式

审批请求卡片是獬豸触发审批时发送给用户的交互卡片。

```json
{
  "msgtype": "tianshu.card",
  
  "msg_id": "msg_45552a85_511e_4d3a_9860_e0e890ccc02d",
  "sender": {
    "did": "did:agent:xiezhi",
    "display_name": "獬豸"
  },
  "receiver": {
    "did": "did:human:hulk"
  },
  
  "payload": {
    "card_type": "approval_request",
    "title": "审批请求",
    "content": "Agent [test-agent] 请求执行敏感操作",
    "created_at": 1700000000000,
    "expires_at": 1700000060000,
    
    "actions": [
      {
        "id": "approve",
        "label": "批准",
        "style": "primary",
        "metadata": {
          "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d"
        }
      },
      {
        "id": "reject",
        "label": "拒绝",
        "style": "danger",
        "metadata": {
          "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d"
        }
      }
    ],
    
    "metadata": {
      "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d",
      "agent_did": "did:agent:test-agent",
      "operation": "execute_command",
      "command": "rm -rf /",
      "risk_level": "high"
    }
  }
}
```

**字段说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| msg_id | string | 是 | 消息唯一标识 |
| msgtype | string | 是 | 固定为 `tianshu.card` |
| sender | object | 是 | 发送方信息 |
| sender.did | string | 是 | 发送方 DID |
| sender.display_name | string | 是 | 显示名称 |
| receiver | object | 是 | 接收方信息 |
| receiver.did | string | 是 | 接收方 DID |
| payload.card_type | string | 是 | 固定为 `approval_request` |
| payload.title | string | 是 | 卡片标题 |
| payload.content | string | 是 | 卡片内容描述 |
| payload.created_at | int64 | 是 | 创建时间（毫秒） |
| payload.expires_at | int64 | 否 | 过期时间（毫秒） |
| payload.actions | array | 是 | 按钮列表 |
|].id | string payload.actions[ | 是 | 按钮唯一标识 |
| payload.actions[].label | string | 是 | 按钮显示文本 |
| payload.actions[].style | string | 否 | 按钮样式：primary/success/danger/secondary |
| payload.actions[].metadata | object | 否 | 按钮级元信息 |
| payload.metadata | object | 是 | 业务元信息（包含 CHEQ ID） |

### 3.2 按钮样式规范

| style 值 | 适用场景 | 视觉效果 |
|----------|----------|----------|
| primary | 默认操作 | 蓝色 |
| success | 批准操作 | 绿色 |
| danger | 拒绝/删除 | 红色 |
| secondary | 取消/返回 | 灰色 |

### 3.3 审批结果卡片格式

审批完成后，系统更新卡片状态：

```json
{
  "msgtype": "tianshu.card",
  
  "msg_id": "msg_45552a85_511e_4d3a_9860_e0e890ccc02d",
  "sender": {
    "did": "did:agent:xiezhi",
    "display_name": "獬豸"
  },
  "receiver": {
    "did": "did:human:hulk"
  },
  
  "payload": {
    "card_type": "approval_result",
    "title": "审批结果",
    "content": "已批准 Agent [test-agent] 的请求",
    "status": "APPROVED",
    "approved_by": "did:human:hulk",
    "approved_at": 1700000010000,
    "reason": "测试通过",
    
    "actions": [],
    
    "metadata": {
      "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d"
    }
  }
}
```

**状态枚举**：

| status | 说明 |
|--------|------|
| PENDING | 待审批 |
| APPROVED | 已批准 |
| REJECTED | 已拒绝 |
| EXPIRED | 已过期 |
| CANCELLED | 已取消 |

---

## 4. 点击事件回调

### 4.1 Matrix 回调格式

当用户在 Matrix 房间点击按钮时：

```json
{
  "action": "button_click",
  "action_key": "approve",
  "action_value": {},
  "msg_id": "msg_45552a85_511e_4d3a_9860_e0e890ccc02d",
  "user_id": "did:human:hulk",
  "timestamp": 1700000010000,
  "metadata": {
    "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d"
  }
}
```

### 4.2 事件处理流程

```
用户点击按钮
    ↓
Matrix 消息房间
    ↓
天枢监听消息（适配层）
    ↓
解析为统一事件模型（T1）
    ↓
路由到獬豸审批服务
    ↓
执行审批逻辑
    ↓
更新 CHEQ 状态
    ↓
响应结果（更新卡片 + WebSocket 广播）
    ↓
悟空接收审批结果
    ↓
恢复任务执行
```

---

## 5. API 接口

### 5.1 獬豸审批接口

#### 5.1.1 触发审批请求

```
POST /api/v1/cheq/create
```

请求体：
```json
{
  "agent_did": "did:agent:test-agent",
  "operation": "execute_command",
  "operation_detail": {
    "command": "rm -rf /"
  },
  "risk_level": "high",
  "requester": "did:human:hulk"
}
```

响应：
```json
{
  "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d",
  "status": "PENDING",
  "created_at": 1700000000000
}
```

#### 5.1.2 批准审批

```
POST /api/v1/cheq/approve
```

请求体：
```json
{
  "id": "45552a85-511e-4d3a-9860-e0e890ccc02d",
  "approved": true,
  "reason": "测试通过"
}
```

#### 5.1.3 拒绝审批

```
POST /api/v1/cheq/approve
```

请求体：
```json
{
  "id": "45552a85-511e-4d3a-9860-e0e890ccc02d",
  "approved": false,
  "reason": "风险过高"
}
```

#### 5.1.4 WebSocket 广播

```
WS /api/v1/ws/policy
```

审批通过后广播：
```json
{
  "type": "approval_result",
  "payload": {
    "approval_id": "45552a85-511e-4d3a-9860-e0e890ccc02d",
    "status": "APPROVED",
    "approved_by": "did:human:hulk",
    "reason": "测试通过",
    "timestamp": 1700000010000
  }
}
```

### 5.2 天枢消息投递接口

```
POST /api/v1/delivery/approval-request
```

请求体：
```json
{
  "receiver": "did:human:hulk",
  "card": {
    "msgtype": "tianshu.card",
    "payload": {
      "card_type": "approval_request",
      "title": "审批请求",
      "content": "Agent [test-agent] 请求执行敏感操作",
      "actions": [...],
      "metadata": {
        "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d"
      }
    }
  }
}
```

---

## 6. 流程图

### 6.1 审批完整流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   悟空   │     │   獬豸   │     │   太白   │     │   天枢   │
│(拦截器)  │     │(审批服务)│     │(卡片封装)│     │(消息路由)│
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                 │                 │                 │
     │  1.请求拦截    │                 │                 │
     │────────────────>│                 │                 │
     │                 │  2.创建CHEQ    │                 │
     │                 │────────────────>│                 │
     │                 │                 │  3.封装卡片    │
     │                 │                 │────────────────>
     │                 │                 │                 │  4.投递消息
     │                 │                 │                 │───────────>
     │                 │                 │                 │           │
     │                 │                 │                 │  ┌────┐  │
     │                 │                 │                 │  │Matrix│ │
     │                 │                 │                 │  │房间 │  │
     │                 │                 │                 │  └──┬─┘  │
     │                 │                 │                 │     │   │
     │                 │                 │                 │     │ 5.用户点击
     │                 │                 │                 │<────┘   │
     │                 │                 │                 │         │
     │                 │  6.审批回调     │                 │         │
     │                 │<────────────────│                 │         │
     │                 │                 │                 │         │
     │                 │  7.更新CHEQ     │                 │         │
     │                 │  8.WebSocket广播│                 │         │
     │                 │────────────────>│                 │         │
     │                 │                 │                 │         │
     │  9.审批结果     │                 │                 │         │
     │<────────────────┤                 │                 │         │
     │                 │                 │                 │         │
     │ 10.恢复执行     │                 │                 │         │
     └────────────────>│                 │                 │         │
                      └─────────────────┴─────────────────┴─────────┘
```

### 6.2 卡片状态流转

```
┌─────────┐      触发审批       ┌─────────┐
│  PENDING│ ──────────────────>│APPROVAL_│
│ (待审批) │                    │REQUEST  │
└─────────┘                    │ (请求中) │
       ▲                        └────┬────┘
       │                             │
       │      用户批准/拒绝           │
       │<────────────────────────────┤
       │                             │
       │                     ┌───────┴───────┐
       │                     │               │
       │              APPROVED          REJECTED
       │             (已批准)          (已拒绝)
       │                     │               │
       │                     └───────┬───────┘
       │                             │
       └─────────────────────────────┘
                     审批结果卡片
```

---

## 7. 示例

### 7.1 完整审批交互示例

**Step 1: 触发审批**

Agent 请求执行敏感操作，悟空拦截并触发审批：

```
请求: curl -X POST http://xiezhi:8080/api/v1/cheq/create \
  -d '{"agent_did":"did:agent:test-agent","operation":"execute_command","operation_detail":{"command":"rm -rf /"},"risk_level":"high"}'

响应: {"cheq_id":"45552a85-511e-4d3a-9860-e0e890ccc02d","status":"PENDING"}
```

**Step 2: 发送审批卡片**

獬豸调用天枢投递审批卡片：

```
请求: curl -X POST http://tianshu:8081/api/v1/delivery/approval-request \
  -d '{
    "receiver": "did:human:hulk",
    "card": {
      "msgtype": "tianshu.card",
      "payload": {
        "card_type": "approval_request",
        "title": "审批请求",
        "content": "Agent [test-agent] 请求执行敏感操作",
        "actions": [
          {"id": "approve", "label": "批准", "style": "success"},
          {"id": "reject", "label": "拒绝", "style": "danger"}
        ],
        "metadata": {
          "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d",
          "agent_did": "did:agent:test-agent",
          "operation": "execute_command"
        }
      }
    }
  }'
```

**Step 3: 用户审批**

用户在 Matrix 房间点击「批准」按钮，天枢收到回调：

```
回调事件: {
  "action": "button_click",
  "action_key": "approve",
  "msg_id": "msg_45552a85_511e_4d3a_9860_e0e890ccc02d",
  "user_id": "did:human:hulk",
  "timestamp": 1700000010000,
  "metadata": {
    "cheq_id": "45552a85-511e-4d3a-9860-e0e890ccc02d"
  }
}
```

天枢调用獬豸审批接口：

```
请求: curl -X POST http://xiezhi:8080/api/v1/cheq/approve \
  -d '{"id":"45552a85-511e-4d3a-9860-e0e890ccc02d","approved":true,"reason":"测试通过"}'

响应: {"status":"APPROVED","approved_by":"did:human:hulk"}
```

**Step 4: 审批结果通知**

獬豸更新卡片状态并通过 WebSocket 广播：

```
广播消息: {
  "type": "approval_result",
  "payload": {
    "approval_id": "45552a85-511e-4d3a-9860-e0e890ccc02d",
    "status": "APPROVED",
    "approved_by": "did:human:hulk",
    "reason": "测试通过",
    "timestamp": 1700000010000
  }
}
```

悟空收到广播，恢复任务执行。

---

## 8. 附录

### 8.1 术语表

| 术语 | 说明 |
|------|------|
| CHEQ | Confirmation with Human in the Loop (HITL) Exchange of Quotations，人机协同确认机制 |
| DID | Decentralized Identifier，去中心化身份标识 |
| JIT | Just-In-Time，实时生成的动态策略 |
| 獬豸 | 紫微策略服务，负责策略评估和审批决策 |
| 太白 | Python SDK，负责消息封装 |
| 天枢 | 网关服务，负责消息路由 |

### 8.2 参考文档

- [跨平台IM纯按钮交互方案](../discussing/跨平台IM纯按钮交互方案.md)
- [太白消息协议子任务提案](../discussing/太白消息协议子任务提案.md)
- [CHEQ IETF 草案](../open/technical/CHEQ-IETF草案.md)
- [架构设计](./架构设计.md)

### 8.3 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-02-19 | 初始版本，整合 T1-T3 设计 |
