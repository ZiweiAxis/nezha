# 谛听客户端详细设计

## 1. 定位与职责

**定位**：谛听是紫微系统下的独立子项目，谛听客户端集成在哪吒内部，负责拦截操作请求并与谛听服务端通信。

**核心职责**：
- 拦截哪吒内的所有操作请求
- 本地策略评估与缓存
- 与谛听服务端通信
- 执行策略决策

## 2. 架构图

```mermaid
flowchart TB
    subgraph 哪吒["哪吒 Nezha"]
        Core["核心逻辑"]
        Interceptor["请求拦截器"]
        PolicyCache["策略缓存"]
        DClient["谛听客户端"]
        TClient["太白客户端"]
    end
    
    subgraph 谛听["谛听服务端"]
        API["API"]
        Decision["决策引擎"]
        Policy["策略引擎"]
    end
    
    Core --> Interceptor
    Interceptor --> DClient
    Interceptor --> PolicyCache
    PolicyCache --> DClient
    DClient --> API
    API --> Decision
    Decision --> Policy
    DClient --> TClient
```

## 3. 核心功能模块

| 模块 | 功能描述 |
|------|----------|
| 请求拦截器 | 拦截所有操作请求 |
| 策略缓存 | 本地缓存审批规则和安全策略 |
| 服务端通信 | 与谛听服务端 HTTP/gRPC 通信 |
| 决策执行 | 执行放行/拒绝/审批请求 |

## 4. 工作流程时序图

```mermaid
sequenceDiagram
    participant A as Agent
    participant W as 哪吒
    participant I as 拦截器
    participant C as 谛听客户端
    participant D as 谛听服务端
    
    A->>W: 发起操作
    W->>I: 拦截请求
    I->>C: 转发请求
    
    rect rgb(240, 248, 255)
        note right of C: 本地缓存检查
        C->>C: 查询策略缓存
    end
    
    alt 缓存命中
        C->>C: 使用缓存决策
        C-->>A: 放行/拒绝
    else 缓存未命中
        C->>D: 请求决策
        D-->>C: 返回决策
        C->>C: 更新缓存
        C-->>A: 放行/拒绝
    end
```

## 5. 接口设计

| 接口 | 说明 |
|------|------|
| `/decide` | 请求策略决策 |
| `/sync` | 同步策略更新 |
| `/report` | 上报执行结果 |
