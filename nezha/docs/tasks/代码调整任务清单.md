# 任务清单

## 一、架构调整完成状态

| 阶段 | 任务 | 状态 |
|------|------|------|
| Phase 1 | 方案确认 | ✅ 完成 |
| Phase 2 | 谛听独立化 | ✅ 完成 |
| Phase 3 | 天枢清理 | ✅ 完成 |
| Phase 4 | 调用统一 | 🔶 进行中 |

---

## 二、紫微模块依赖关系

### 2.1 正确依赖关系

```
         ┌─────────────────────────────────────┐
         │              獬豸                       │
         │         (策略决策服务端)                 │
         │                                       │
         │    审批消息 ──▶ 天枢 (通过太白 SDK)     │
         └──────────────────┬────────────────────┘
                          ▲
                          │ 谛听调用獬豸
                          │ (HTTP)
         ┌────────────────┴────────────────┐
         │                                   │
    ┌────┴────┐                      ┌──────┴──────┐
    │   谛听   │                      │ 太白 SDK     │
    │ (PEP)   │                      │ (天枢客户端)  │
    └────┬────┘                      └──────┬──────┘
         │                                   │
    哪吒调用谛听                         天枢调用太白
         │                                   │
    ┌────┴────┐                      ┌──────┴──────┐
    │   哪吒   │                      │    天枢     │
    │ (Agent) │                      │ (消息中枢)   │
    └─────────┘                      └─────────────┘
```

### 2.2 依赖总结

| 模块 | 依赖谁 | 被谁依赖 | 依赖说明 |
|------|--------|----------|----------|
| **獬豸** | 太白 | 谛听 | 使用太白 SDK 调用天枢投递审批消息 |
| **谛听** | 獬豸 | 哪吒 | 调用獬豸获取策略决策 |
| **哪吒** | 谛听、太白 | - | 使用谛听拦截、使用太白发消息 |
| **太白** | 天枢 | 哪吒、獬豸 | 天枢的客户端 SDK |
| **天枢** | - | 太白 | 被太白调用 |

### 2.3 调用协议

| 调用路径 | 协议 | 说明 |
|----------|------|------|
| 哪吒 → 谛听 | HTTP | 策略拦截请求 |
| 谛听 → 獬豸 | HTTP | 获取策略决策 |
| 獬豸 → 天枢 | 太白 SDK | 审批消息投递（当前直接调用，需改造） |
| 哪吒 → 天枢 | 太白 SDK | 消息发送 |

---

## 三、模块职责

| 模块 | 职责 | 角色 |
|------|------|------|
| **哪吒** | Agent 生命周期管理 | 调用方 |
| **獬豸** | 策略决策 + 审批服务 | 服务端（被谛听调用） |
| **天枢** | 消息中枢 | 服务端（被太白调用） |
| **太白** | 天枢 SDK | 客户端库 |
| **谛听** | PEP 策略执行 | 獬豸的客户端 |

---

## 四、当前问题

### 4.1 直接调用问题

**问题**：獬豸直接调用天枢，未使用太白 SDK

```go
// 当前代码 (xiezhi/internal/delivery/tianshu/tianshu.go)
http.Post("http://tianshu:8081/api/v1/...", ...)
```

**应改为**：
```go
// 正确方式
taibaiClient.SendApprovalRequest(...)
```

---

## 五、后续开发任务

### 5.1 待完成

| 任务 | 模块 | 优先级 | 状态 |
|------|------|--------|------|
| **T1** 太白 SDK 开发 | 太白 | P0 | 待开发 |
| **T2** 獬豸改造 | 獬豸 | P1 | 待改造 |
| **T3** 谛听 Seccomp | 谛听 | P1 | 待开发 |
| **T4** 哪吒改造 | 哪吒 | P1 | 待改造 |

### 5.2 任务详情

#### T1: 太白 SDK 开发

- [ ] Go SDK 实现
  - [ ] HTTP 客户端
  - [ ] WebSocket 客户端
  - [ ] 消息发送 API
  - [ ] 用户管理 API
  - [ ] 房间管理 API
  - [ ] 审批消息投递 API ⭐
- [ ] Python SDK 实现（同上）
- [ ] 集成测试

#### T2: 獬豸改造

- [ ] 移除直接 HTTP 调用天枢（`xiezhi/internal/delivery/tianshu/`）
- [ ] 集成太白 SDK
- [ ] 使用太白 SDK 调用天枢投递审批消息
- [ ] 测试验证

#### T3: 谛听 Seccomp 方案实现

- [ ] Seccomp 通知处理
- [ ] 策略缓存
- [ ] 请求队列
- [ ] 与獬豸通信（调用獬豸获取策略决策）
- [ ] 审批回调

#### T4: 哪吒改造

- [ ] 集成谛听客户端
- [ ] 集成太白 SDK
- [ ] 测试验证

---

## 六、模块代码位置

```
ziwei/
├── nezha/           # 哪吒 - Agent 生命周期管理
│   └── src/clients/DitingClient.ts  # 谛听客户端
│
├── xiezhi/         # 獬豸 - 策略服务 + 审批服务
│   └── internal/delivery/tianshu/   # ⚠️ 直接调用天枢（待改造）
│
├── tianshu/        # 天枢 - 消息中枢
│
├── taibai/         # 太白 - SDK (待开发)
│
└── diting/        # 谛听 - PEP (新独立项目)
```

---

## 七、Git 仓库

| 模块 | 仓库 | 说明 |
|------|------|------|
| 主仓 | ziwei | 包含文档 |
| 哪吒 | ZiweiAxis/nezha | Agent 管理 |
| 獬豸 | ZiweiAxis/xiezhi | 策略服务 |
| 天枢 | ZiweiAxis/tianshu | 消息中枢 |
| 太白 | ZiweiAxis/taibai | SDK |
| 谛听 | ZiweiAxis/diting | PEP |
