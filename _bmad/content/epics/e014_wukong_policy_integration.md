# E014: 悟空策略拦截完整集成

## 概述

| 属性 | 值 |
|------|-----|
| Epic ID | E014 |
| 名称 | 悟空策略拦截完整集成 |
| 描述 | 实现完整的策略拦截流程：悟空执行 → 谛听拦截 → 獬豸检查 → 审批 → 执行 |
| 状态 | 🚧 进行中 |
| 优先级 | P0 |
| 依赖 | E013 (架构修正) |

## 背景

E013 完成了架构修正，将悟空中的谛听集成移除，回归纯粹的 Agent 角色。现在需要实现通过哪吒沙箱模式启动悟空，并集成谛听策略拦截。

## 目标

1. 实现哪吒沙箱启动时集成 diter-hook
2. 配置审批消息投递（天枢/Telegram）
3. 实现审批回调机制
4. 端到端测试验证

## Stories

| Story | 名称 | 状态 | 工作量 |
|-------|------|------|--------|
| S070 | 集成 diter-hook 到沙箱 | ⏳ 待处理 | 3 |
| S071 | 配置审批消息投递 | ⏳ 待处理 | 2 |
| S072 | 实现审批回调 | ⏳ 待处理 | 3 |
| S073 | 端到端流程测试 | ⏳ 待处理 | 2 |

---

## S070: 集成 diter-hook 到沙箱

### 任务

- [x] 修改 startSandbox 使用 golang:alpine 镜像
- [x] 在容器内安装 diter-hook
- [x] 配置 Claude Code hooks
- [ ] 验证 hook 拦截功能

### 实现细节

1. **镜像变更**: node:18-alpine → golang:1.21-alpine（需要 Go 环境编译）
2. **安装 diter-hook**: 克隆 nezha 仓库，编译 diter-hook
3. **配置 hooks**: 创建 .claude/settings.json 配置 PreToolUse hook

### 验收标准

- [ ] 容器内 diter-hook 安装成功
- [ ] Claude Code hooks 配置正确
- [ ] 技能执行被 diter-hook 拦截

---

## S071: 配置审批消息投递

### 任务

- [ ] 配置天枢 Matrix 投递
- [ ] 或配置 Telegram 投递
- [ ] 验证消息能发送到审批人

### 实现方案

审批消息发送到 Matrix 房间，用户在房间内点击批准按钮。

---

## S072: 实现审批回调

### 任务

- [ ] 天枢接收审批按钮点击
- [ ] 调用獬豸审批 API
- [ ] 獬豸更新 CHEQ 状态
- [ ] WebSocket 通知悟空继续执行

---

## S073: 端到端流程测试

### 任务

- [ ] 发送测试指令（如"查询天气"）
- [ ] 验证拦截触发审批
- [ ] 审批通过后执行技能
- [ ] 返回执行结果

### 测试用例

1. 用户发送："郑州天气怎么样"
2. 悟空调用 Skill
3. diter-hook 拦截，调用 /auth/exec
4. 策略返回 review，生成 CHEQ
5. 审批消息发送到 Matrix
6. 用户点击"批准"
7. 回调更新 CHEQ 状态
8. 悟空继续执行，返回天气结果
